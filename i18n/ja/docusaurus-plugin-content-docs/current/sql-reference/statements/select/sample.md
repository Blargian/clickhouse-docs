---
slug: /sql-reference/statements/select/sample
sidebar_label: SAMPLE
---

# SAMPLE 句

`SAMPLE` 句は、近似的な `SELECT` クエリ処理を可能にします。

データサンプリングが有効になっている場合、クエリはすべてのデータではなく、データの特定の一部（サンプル）のみで実行されます。たとえば、すべての訪問の統計を計算する必要がある場合、すべての訪問の1/10の部分でクエリを実行し、その結果に10を掛けるだけで十分です。

近似的なクエリ処理は、以下のような場合に便利です：

- 厳格なレイテンシ要件（100ms未満など）があるが、それを満たすための追加ハードウェアリソースのコストを正当化できない場合。
- 生データが正確でないため、近似が品質を著しく劣化させない場合。
- ビジネス要件が近似結果を対象としている場合（コスト効率のため、またはプレミアムユーザーに正確な結果を市場提供するため）。

:::note    
サンプリングは、[MergeTree](../../../engines/table-engines/mergetree-family/mergetree.md) ファミリのテーブルでのみ使用でき、テーブル作成時にサンプリング式が指定されている必要があります（[MergeTree エンジン](../../../engines/table-engines/mergetree-family/mergetree.md#table_engine-mergetree-creating-a-table)を参照）。
:::

データサンプリングの特徴は以下の通りです：

- データサンプリングは決定論的なメカニズムです。同じ `SELECT .. SAMPLE` クエリの結果は常に同じです。
- サンプリングは、異なるテーブルに対して一貫して機能します。単一のサンプリングキーを持つテーブルの場合、同じ係数のサンプルは常に同じデータの部分集合を選択します。たとえば、ユーザーIDのサンプルは、異なるテーブルからすべての可能なユーザーIDの同じ部分集合を持つ行を取得します。これにより、[IN](../../../sql-reference/operators/in.md) 句のサブクエリでサンプルを使用することができます。また、[JOIN](../../../sql-reference/statements/select/join.md) 句を使用してサンプルを結合することもできます。
- サンプリングは、ディスクから読み取るデータ量を減らすことを可能にします。サンプリングキーを正しく指定する必要があることに注意してください。詳細については、[MergeTree テーブルの作成](../../../engines/table-engines/mergetree-family/mergetree.md#table_engine-mergetree-creating-a-table)を参照してください。

`SAMPLE` 句には以下の構文がサポートされています：

| SAMPLE 句構文 | 説明                                                                                                                                                                                                                                    |
|----------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `SAMPLE k`     | ここで `k` は 0 から 1 までの数字です。クエリは `k` のデータの部分で実行されます。たとえば、`SAMPLE 0.1` はデータの10%でクエリを実行します。[詳しく読む](#sample-k)                                                             |
| `SAMPLE n`     | ここで `n` は十分に大きな整数です。クエリは少なくとも `n` 行のサンプルで実行されます（ただし、これよりもかなり多くはありません）。たとえば、`SAMPLE 10000000` は10,000,000行以上でクエリを実行します。[詳しく読む](#sample-n) |
| `SAMPLE k OFFSET m` | ここで `k` と `m` は 0 から 1 までの数字です。クエリは `k` のデータの部分でサンプルが実行され、サンプルに使用されるデータは `m` の部分でオフセットされます。[詳しく読む](#sample-k-offset-m)                                               |


## SAMPLE K {#sample-k}

ここで `k` は 0 から 1 までの数字です（分数と小数の両方の表記がサポートされています）。たとえば、`SAMPLE 1/2` または `SAMPLE 0.5`。

`SAMPLE k` 句では、データの `k` の部分からサンプルが取得されます。以下に例を示します：

``` sql
SELECT
    Title,
    count() * 10 AS PageViews
FROM hits_distributed
SAMPLE 0.1
WHERE
    CounterID = 34
GROUP BY Title
ORDER BY PageViews DESC LIMIT 1000
```

この例では、クエリはデータの0.1（10%）のサンプルで実行されます。集計関数の値は自動で修正されないため、近似結果を得るには、`count()` の値に手動で10を掛ける必要があります。

## SAMPLE N {#sample-n}

ここで `n` は十分に大きな整数です。たとえば、`SAMPLE 10000000`。

この場合、クエリは少なくとも `n` 行のサンプルで実行されます（ただし、これよりもかなり多くはありません）。たとえば、`SAMPLE 10000000` は最低でも10,000,000行でクエリを実行します。

データ読み取りの最小単位は1つのグラニュールであり（そのサイズは `index_granularity` 設定で決まります）、サンプルはグラニュールのサイズよりもかなり大きなものを設定することが意味があります。

`SAMPLE n` 句を使用する際、処理されたデータの相対的なパーセントがわからないため、集計関数にどの係数を掛ければよいかわかりません。近似結果を得るために `_sample_factor` 仮想カラムを使用してください。

`_sample_factor` カラムには、動的に計算された相対係数が含まれています。このカラムは、指定したサンプリングキーを持つテーブルを[作成](../../../engines/table-engines/mergetree-family/mergetree.md#table_engine-mergetree-creating-a-table)すると自動的に作成されます。 `_sample_factor` カラムの使用例は以下に示されます。

サイト訪問の統計を含むテーブル `visits` を考えてみましょう。最初の例では、ページビューの数を計算する方法を示します：

``` sql
SELECT sum(PageViews * _sample_factor)
FROM visits
SAMPLE 10000000
```

次の例では、訪問の合計数を計算する方法を示します：

``` sql
SELECT sum(_sample_factor)
FROM visits
SAMPLE 10000000
```

以下の例では、平均セッション時間を計算する方法を示します。平均値を計算するために相対係数を使用する必要がないことに注意してください。

``` sql
SELECT avg(Duration)
FROM visits
SAMPLE 10000000
```

## SAMPLE K OFFSET M {#sample-k-offset-m}

ここで `k` と `m` は 0 から 1 までの数字です。以下に例を示します。

**例1**

``` sql
SAMPLE 1/10
```

この例では、サンプルはすべてのデータの1/10です：

`[++------------]`

**例2**

``` sql
SAMPLE 1/10 OFFSET 1/2
```

ここでは、データの後半の10%からサンプルが取得されます。

`[------++------]`
