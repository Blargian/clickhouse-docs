---
sidebar_label: 'Обзор'
sidebar_position: 0
slug: /cloud/manage/backups/overview
title: 'Обзор'
keywords: ['резервные копии', 'облачные резервные копии', 'восстановление']
description: 'Предоставляет обзор резервных копий в ClickHouse Cloud'
---

import CloudNotSupportedBadge from '@theme/badges/CloudNotSupportedBadge';
import ScalePlanFeatureBadge from '@theme/badges/ScalePlanFeatureBadge';
import Image from '@theme/IdealImage';
import backup_chain from '@site/static/images/cloud/manage/backup-chain.png';
import backup_status_list from '@site/static/images/cloud/manage/backup-status-list.png';
import backup_usage from '@site/static/images/cloud/manage/backup-usage.png';
import backup_restore from '@site/static/images/cloud/manage/backup-restore.png';
import backup_service_provisioning from '@site/static/images/cloud/manage/backup-service-provisioning.png';


# Резервные копии

Резервные копии баз данных предоставляют защиту, гарантируя, что если данные будут утрачены по какой-либо непредвиденной причине, сервис может быть восстановлен до предыдущего состояния из последней успешной резервной копии. Это минимизирует время простоя и предотвращает постоянную утрату критически важной для бизнеса информации. Этот руководств описывает, как работают резервные копии в ClickHouse Cloud, какие у вас есть настройки для конфигурации резервных копий вашего сервиса и как восстановить данные из резервной копии.

## Как работают резервные копии в ClickHouse Cloud {#how-backups-work-in-clickhouse-cloud}

Резервные копии ClickHouse Cloud представляют собой комбинацию "полных" и "инкрементных" резервных копий, составляющих цепочку резервных копий. Цепочка начинается с полной резервной копии, а потом на следующих запланированных интервалах времени делаются инкрементные резервные копии для создания последовательности резервных копий. Как только длина цепочки резервных копий достигает определенной величины, начинается новая цепочка. Вся эта цепочка резервных копий может быть использована для восстановления данных в новом сервисе при необходимости. Как только все резервные копии, входящие в конкретную цепочку, превышают установленный для сервиса срок хранения (более подробная информация о сроках хранения приведена ниже), цепочкаDiscarded.

На скриншоте ниже сплошные квадратные рамки обозначают полные резервные копии, а пунктирные квадратные рамки обозначают инкрементные резервные копии. Сплошной прямоугольник вокруг квадратов обозначает срок хранения и резервные копии, доступные конечному пользователю, которые можно использовать для восстановления резервной копии. В представленном сценарии резервные копии создаются каждые 24 часа и сохраняются на 2 дня.

В первый день создается полная резервная копия, чтобы начать цепочку резервных копий. На второй день создается инкрементная резервная копия, и теперь у нас есть доступная для восстановления полная и инкрементная резервные копии. На седьмой день в цепочке будет одна полная резервная копия и шесть инкрементных резервных копий, с двумя самыми последними инкрементными резервными копиями, доступными для пользователя. На восьмой день мы создаем новую полную резервную копию, а на девятый день, как только в новой цепочке окажутся две резервные копии, предыдущая цепочка будет утилизирована.

<Image img={backup_chain} size="md" alt="Пример цепочки резервных копий в ClickHouse Cloud" />

*Пример сценария резервного копирования в ClickHouse Cloud*

## Политика резервного копирования по умолчанию {#default-backup-policy}

В Basic, Scale и Enterprise тарифах резервные копии имеют учет и выставляются отдельно от хранения. Все сервисы по умолчанию будут иметь одну резервную копию с возможностью настройки большего количества, начиная с тарифа Scale, через вкладку Настройки в Cloud Console.

## Список статусов резервных копий {#backup-status-list}

Ваш сервис будет резервироваться в соответствии с установленным расписанием, будь то стандартное ежедневное расписание или [пользовательское расписание](./configurable-backups.md), выбранное вами. Все доступные резервные копии можно просмотреть на вкладке **Резервные копии** сервиса. Отсюда вы можете увидеть статус резервной копии, продолжительность, а также размер резервной копии. Вы также можете восстановить конкретную резервную копию, используя столбец **Действия**.

<Image img={backup_status_list} size="md" alt="Список статусов резервных копий в ClickHouse Cloud" border/>

## Понимание стоимости резервных копий {#understanding-backup-cost}

Согласно политике по умолчанию, ClickHouse Cloud требует резервную копию каждый день с 24-часовым сроком хранения. Выбор расписания, которое требует хранения большего объема данных или приводит к более частым резервным копиям, может вызвать дополнительные расходы на хранение резервных копий.

Чтобы понять стоимость резервной копии, вы можете просмотреть стоимость резервной копии на экран использования (как показано ниже). Как только у вас появятся резервные копии в течение нескольких дней с пользовательским расписанием, вы сможете получить представление о стоимости и экстраполировать для получения ежемесячной стоимости резервных копий.

<Image img={backup_usage} size="md" alt="Диаграмма использования резервных копий в ClickHouse Cloud" border/>

Оценка общей стоимости ваших резервных копий требует настройки расписания. Мы также работаем над обновлением нашего [калькулятора цен](https://clickhouse.com/pricing), чтобы вы могли получить оценку ежемесячной стоимости до установки расписания. Вам нужно будет предоставить следующие данные для оценки стоимости:
- Размер полных и инкрементных резервных копий
- Желаемая частота
- Желаемый срок хранения
- Облако провайдер и регион

:::note
Имейте в виду, чтоEstimated cost for backups will change as the size of the data in the service grows over time.
:::

## Восстановление резервной копии {#restore-a-backup}

Резервные копии восстанавливаются в новый сервис ClickHouse Cloud, а не в существующий сервис, из которого была сделана резервная копия.

После нажатия на иконку **Восстановить** резервную копию вы можете указать имя сервиса нового сервиса, который будет создан, а затем восстановить эту резервную копию:

<Image img={backup_restore} size="md" alt="Восстановление резервной копии в ClickHouse Cloud" />

Новый сервис будет отображаться в списке сервисов как `Provisioning`, пока он не будет готов:

<Image img={backup_service_provisioning} size="md" alt="В процессе развертывания сервиса" border/>

## Работа с восстановленным сервисом {#working-with-your-restored-service}

После восстановления резервной копии у вас будет два похожих сервиса: **оригинальный сервис**, который необходимо было восстановить, и новый **восстановленный сервис**, который был восстановлен из резервной копии оригинального.

Как только восстановление резервной копии завершено, вам следует сделать одно из следующих действий:
- Использовать новый восстановленный сервис и удалить оригинальный сервис.
- Переместить данные из нового восстановленного сервиса обратно в оригинальный сервис и удалить новый восстановленный сервис.

### Использовать **новый восстановленный сервис** {#use-the-new-restored-service}

Чтобы использовать новый сервис, выполните следующие шаги:

1. Убедитесь, что новый сервис имеет записи в списке доступа IP, необходимые для вашего случая использования.
1. Убедитесь, что новый сервис содержит необходимые данные.
1. Удалите оригинальный сервис.

### Переместить данные из **нового восстановленного сервиса** обратно в **оригинальный сервис** {#migrate-data-from-the-newly-restored-service-back-to-the-original-service}

Предположим, вы не можете работать с новым восстановленным сервисом по какой-либо причине, например, если у вас все еще есть пользователи или приложения, подключающиеся к существующему сервису. Вы можете решить переместить новые восстановленные данные в оригинальный сервис. Перемещение может быть выполнено, следуя этим шагам:

**Разрешите удаленный доступ к новому восстановленному сервису**

Новый сервис должен быть восстановлен из резервной копии с таким же списком IP Allow List, как у оригинального сервиса. Это требуется, так как соединения не будут разрешены к другим сервисам ClickHouse Cloud, если вы не разрешили доступ из **Anywhere**. Временно измените список разрешений и разрешите доступ из **Anywhere**. См. [документы по списку доступа IP](/cloud/security/setting-ip-filters) для получения подробностей.

**На новом восстановленном сервисе ClickHouse (система, которая хранит восстановленные данные)**

:::note
Вам нужно будет сбросить пароль для нового сервиса, чтобы получить к нему доступ. Вы можете сделать это из вкладки **Настройки** списка сервисов.
:::

Добавьте пользователя с правами только для чтения, который может читать исходную таблицу (`db.table` в этом примере):

  ```sql
  CREATE USER exporter
  IDENTIFIED WITH SHA256_PASSWORD BY 'password-here'
  SETTINGS readonly = 1;
  ```

  ```sql
  GRANT SELECT ON db.table TO exporter;
  ```

Скопируйте определение таблицы:

  ```sql
  SELECT create_table_query
  FROM system.tables
  WHERE database = 'db' AND table = 'table'
  ```

**На целевой системе ClickHouse Cloud (той, в которой была повреждена таблица):**

Создайте целевую базу данных:
  ```sql
  CREATE DATABASE db
  ```

Используя оператор `CREATE TABLE`, полученный из исходной таблицы, создайте целевую:

:::tip
Измените `ENGINE` на `ReplicatedMergeTree` без каких-либо параметров, когда будете выполнять оператор `CREATE`. ClickHouse Cloud всегда реплицирует таблицы и предоставляет правильные параметры.
:::

  ```sql
  CREATE TABLE db.table ...
  ENGINE = ReplicatedMergeTree
  ORDER BY ...
  ```

Используйте функцию `remoteSecure`, чтобы перенести данные из нового восстановленного сервиса ClickHouse Cloud в ваш оригинальный сервис:

  ```sql
  INSERT INTO db.table
  SELECT *
  FROM remoteSecure('source-hostname', db, table, 'exporter', 'password-here')
  ```

После успешного вставки данных в ваш оригинальный сервис убедитесь, что данные проверены в сервисе. Вы также должны удалить новый сервис после проверки данных.

## Восстановление или отмена удаления таблиц {#undeleting-or-undropping-tables}

<CloudNotSupportedBadge/>

Команда `UNDROP` не поддерживается в ClickHouse Cloud. Если вы случайно `DROP` таблицу, лучше всего восстановить вашу последнюю резервную копию и воссоздать таблицу из резервной копии.

Чтобы предотвратить случайное удаление таблиц пользователями, вы можете использовать [`GRANT` statements](/sql-reference/statements/grant), чтобы отозвать права для [`DROP TABLE command`](/sql-reference/statements/drop#drop-table) для конкретного пользователя или роли.

:::note
Чтобы предотвратить случайное удаление данных, отметим, что по умолчанию невозможно удалить таблицы более чем >`1TB` в размере в ClickHouse Cloud.
Если вы хотите удалить таблицы больше этого порога, вы можете использовать настройку `max_table_size_to_drop`, чтобы сделать это:

```sql
DROP TABLE IF EXISTS table_to_drop
SYNC SETTINGS max_table_size_to_drop=2097152 -- увеличивает лимит до 2TB
```
:::

## Настраиваемые резервные копии {#configurable-backups}

Если вы хотите настроить расписание резервных копий, отличное от стандартного расписания резервных копий, ознакомьтесь с [Настраиваемыми резервными копиями](./configurable-backups.md).

## Экспорт резервных копий в ваш собственный облачный аккаунт {#export-backups-to-your-own-cloud-account}

Для пользователей, желающих экспортировать резервные копии в свои собственные облачные аккаунты, см. [здесь](./export-backups-to-own-cloud-account.md).
