function insertKapaWidget() {
    // Check if user agent is iOS 16.3 or lower
    function isOldiOS() {
        const ua = navigator.userAgent;

        // Check if it's an iOS device
        const isIOS = /iPad|iPhone/.test(ua);

        if (isIOS) {
            // Extract iOS version if it exists
            const iosVersionMatch = ua.match(/OS (\d+)_(\d+)/);
            if (iosVersionMatch) {
                const majorVersion = parseInt(iosVersionMatch[1], 10);
                const minorVersion = parseInt(iosVersionMatch[2], 10);

                // Return true if iOS version is 16.3 or lower
                // return majorVersion < 16 || (majorVersion === 16 && minorVersion <= 3);
                return true
            }
        }

        return false;
    }

    // Only insert script if not running on older iOS as Kapa does not support it
    if (!isOldiOS()) {
        const script = document.createElement('script');
        script.src = 'https://widget.kapa.ai/kapa-widget.bundle.js';
        script.async = true;
        script.defer = true;
        script.setAttribute('data-website-id', 'c0b5f156-1e92-49df-8252-adacc9feb21b');
        script.setAttribute('data-project-name', 'ClickHouse');
        script.setAttribute('data-project-color', '#151515');
        script.setAttribute('data-project-logo', 'https://avatars.githubusercontent.com/u/54801242?s=200&v=4');
        script.setAttribute('data-modal-disclaimer', 'This is a custom LLM for ClickHouse with access to all developer documentation, open GitHub Issues, YouTube videos, and resolved StackOverflow posts. Please note that answers are generated by AI and may not be fully accurate, so please use your best judgement.');
        script.setAttribute('data-modal-example-questions', 'How to speed up queries?,How to use materialized views?');
        script.setAttribute('data-kapa-branding-hide', 'true');

        document.head.appendChild(script);
        console.log('Kapa widget script added successfully');
    } else {
        console.log('Kapa widget not added: detected iOS 16.3 or lower');
    }
}

// Run the function when DOM is fully loaded
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', insertKapaWidget);
} else {
    try {
        insertKapaWidget();
    } catch (e) {
        console.log("An error occured while trying to load the Kapa.ai widget:", e);
    }
}
