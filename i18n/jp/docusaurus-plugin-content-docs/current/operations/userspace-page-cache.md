description: 'プロセス内メモリにデータをキャッシュすることを可能にするキャッシングメカニズムであり、OSページキャッシュに依存する必要がありません。'
sidebar_label: 'ユーザースペースページキャッシュ'
sidebar_position: 65
slug: /operations/userspace-page-cache
title: 'ユーザースペースページキャッシュ'
```


# ユーザースペースページキャッシュ

## 概要 {#overview}

> ユーザースペースページキャッシュは、データをプロセス内メモリにキャッシュすることを可能にする新しいキャッシングメカニズムで、OSページキャッシュに依存する必要がありません。

ClickHouseはすでに、[ファイルシステムキャッシュ](/docs/operations/storing-data) を提供しており、これによりAmazon S3、Google Cloud Storage (GCS)、またはAzure Blob Storageなどのリモートオブジェクトストレージの上でキャッシュを行うことができます。ユーザースペースページキャッシュは、通常のOSキャッシングが十分に機能しない場合にリモートデータへのアクセスを高速化することを目的としています。

ファイルシステムキャッシュとは以下の点が異なります。

| ファイルシステムキャッシュ                                 | ユーザースペースページキャッシュ               |
|---------------------------------------------------------|---------------------------------------|
| ローカルファイルシステムにデータを書き込む                     | メモリ内にのみ存在                       |
| ディスクスペースを占有する（tmpfsで設定可能）                 | ファイルシステムから独立している               |
| サーバーの再起動を生き延びる                                 | サーバーの再起動を生き延びない               |
| サーバーのメモリ使用量に表示されない                            | サーバーのメモリ使用量に表示される              |
| ディスク上とメモリ内（OSページキャッシュ）両方に適している           | **ディスクなしサーバーに適している**          |

## 設定と使用法 {#configuration-settings-and-usage}

### 使用法 {#usage}

ユーザースペースページキャッシュを有効にするには、まずサーバーで設定します。

```bash
cat config.d/page_cache.yaml
page_cache_max_size: 100G
```

:::note
ユーザースペースページキャッシュは指定された量のメモリを使用しますが、このメモリ量は予約されていません。他のサーバーのニーズのために必要に応じてメモリは追放されます。
:::

次に、クエリレベルでの使用を有効にします。

```sql
SET use_page_cache_for_disks_without_file_cache=1;
```

### 設定 {#settings}

| 設定名                                                  | 説明                                                                                                                                                                                                                                                     | デフォルト     |
|----------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------|
| `use_page_cache_for_disks_without_file_cache`            | ファイルシステムキャッシュが有効でないリモートディスクに対してユーザースペースページキャッシュを使用します。                                                                                                                                                                 | `0`         |
| `use_page_cache_with_distributed_cache`                  | 分散キャッシュが使用されるときにユーザースペースページキャッシュを使用します。                                                                                                                                                                     | `0`         |
| `read_from_page_cache_if_exists_otherwise_bypass_cache`  | [`read_from_filesystem_cache_if_exists_otherwise_bypass_cache`](/docs/operations/settings/settings#read_from_filesystem_cache_if_exists_otherwise_bypass_cache) と同様に、パッシブモードでユーザースペースページキャッシュを使用します。                             | `0`         |
| `page_cache_inject_eviction`                             | ユーザースペースページキャッシュは時折ランダムにいくつかのページを無効にします。テスト用です。                                                                                                                                                          | `0`         |
| `page_cache_block_size`                                  | ユーザースペースページキャッシュに保存するファイルチャンクのサイズ（バイト単位）です。キャッシュを介する読み取りは、このサイズの倍数に切り上げられます。                                                                                                   | `1048576`   |
| `page_cache_history_window_ms`                           | ユーザースペースページキャッシュで使用される前に解放されたメモリが使用されるまでの遅延です。                                                                                                                                                          | `1000`      |
| `page_cache_policy`                                      | ユーザースペースページキャッシュのポリシー名です。                                                                                                                                                                                                      | `SLRU`      |
| `page_cache_size_ratio`                                  | ユーザースペースページキャッシュのプロテクトキューのサイズとキャッシュの総サイズに対する比率です。                                                                                                                                                | `0.5`       |
| `page_cache_min_size`                                    | ユーザースペースページキャッシュの最小サイズです。                                                                                                                                                                                                       | `104857600` |
| `page_cache_max_size`                                    | ユーザースペースページキャッシュの最大サイズです。キャッシュを無効にするには0に設定します。page_cache_min_sizeより大きい場合、キャッシュサイズはこの範囲内で継続的に調整され、使用可能なメモリの大部分を使用しながら、総メモリ使用量を制限（`max_server_memory_usage`\[`_to_ram_ratio`\]）の下に保ちます。 | `0`         |
| `page_cache_free_memory_ratio`                           | ユーザースペースページキャッシュから解放するメモリ制限の割合です。Linuxのmin_free_kbytes設定に類似しています。                                                                                                                                              | `0.15`      |
| `page_cache_lookahead_blocks`                            | ユーザースペースページキャッシュミス時に、キャッシュに存在しない場合、基盤ストレージから一度に読み込む連続ブロックの数の最大値です。各ブロックはpage_cache_block_sizeバイトです。                                                                                                | `16`        |
| `page_cache_shards`                                      | ミューテックス競合を減らすために、これだけのシャードでユーザースペースページキャッシュをストライプします。実験的であり、パフォーマンスを向上させる可能性は低いです。                                                                                       | `4`         |

## 関連コンテンツ {#related-content}
- [ファイルシステムキャッシュ](/docs/operations/storing-data)
- [ClickHouse v25.3 リリースウェビナー](https://www.youtube.com/live/iCKEzp0_Z2Q?feature=shared&t=1320)
