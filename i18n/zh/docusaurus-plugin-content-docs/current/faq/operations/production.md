---
'slug': '/faq/operations/production'
'title': '在生产环境中使用哪个ClickHouse版本？'
'toc_hidden': true
'toc_priority': 10
'description': '本页面提供了关于在生产环境中使用哪个ClickHouse版本的指导'
---




# 生产中使用哪个 ClickHouse 版本？ {#which-clickhouse-version-to-use-in-production}

首先，让我们讨论一下人们为什么会问这个问题。有两个关键原因：

1.  ClickHouse 的开发速度相当快，通常每年有 10 次以上的稳定发布。这使得有很多版本可供选择，这并不是一个简单的选择。
2.  一些用户希望避免花时间找出哪个版本最适合他们的用例，而是跟随其他人的建议。

第二个原因更为根本，因此我们将从这个原因开始，然后再回到各种 ClickHouse 版本的选择上。

## 您推荐使用哪个 ClickHouse 版本？ {#which-clickhouse-version-do-you-recommend}

雇佣顾问或相信某些知名专家来卸脱您对生产环境的责任是很诱人的。您安装了某个别人推荐的特定 ClickHouse 版本；如果出现问题，那就不是您的错，是别人的。这种推理是一个大陷阱。没有外部的人比您更了解自己公司的生产环境发生了什么。

那么，您如何正确选择要升级到哪个 ClickHouse 版本？或者您如何选择第一个 ClickHouse 版本？首先，您需要投资设置一个 **现实的预生产环境**。理想情况下，它应该是完全相同的影子副本，但这通常代价高昂。

在预生产环境中以相对较低的成本获得合理的保真度的一些关键点如下：

- 预生产环境需要运行与生产环境中打算执行的查询集尽可能接近的查询：
    - 不要让它只读，使用一些静态数据。
    - 不要让它只写，单纯复制数据而不生成一些典型的报告。
    - 不要清空它，而是进行架构迁移。
- 使用真实生产数据和查询的样本。尽量选择一个仍然具有代表性的样本，并使得 `SELECT` 查询返回合理的结果。如果您的数据是敏感的，并且内部政策不允许其离开生产环境，请使用混淆技术。
- 确保预生产环境受到您的监控和警报软件的覆盖，方式和生产环境相同。
- 如果您的生产跨多个数据中心或地区，请确保您的预生产也是如此。
- 如果您的生产使用了诸如复制、分布式表和级联物化视图等复杂功能，请确保它们在预生产中进行相似配置。
- 预生产环境中使用的服务器或虚拟机数量与生产环境相近，但规模更小，或数量较少但规模相同，两者之间存在权衡。第一种选择可能会捕获额外的网络相关问题，而后者更易于管理。

另一个投资领域是 **自动化测试基础设施**。不要假设某种查询成功执行了一次后，就会永远保持成功。拥有一些模拟 ClickHouse 的单元测试是可以的，但请确保您的产品具有合理的自动化测试集，并在真实的 ClickHouse 上运行，这些测试检查所有重要用例是否仍按预期工作。

进一步的步骤是将这些自动化测试贡献给 [ClickHouse 的开源测试基础设施](https://github.com/ClickHouse/ClickHouse/tree/master/tests)，这些测试在其日常开发中持续使用。掌握 [如何运行它](../../development/tests.md) 以及如何将您的测试适配到这个框架，当然需要额外的时间和精力，但它通过确保 ClickHouse 在宣布稳定时已经经过测试，将大大节省您在后续报告问题时所花费的时间，同时还能等待问题修复、回填和发布。某些公司甚至将这种测试贡献纳入内部政策（在谷歌被称为 [Beyonce's Rule](https://www.oreilly.com/library/view/software-engineering-at/9781492082781/ch01.html#policies_that_scale_well)）。

当您设置好预生产环境和测试基础设施后，选择最佳版本就变得简单了：

1.  定期对新的 ClickHouse 发布版本运行自动化测试。您甚至可以对标记为 `testing` 的 ClickHouse 发布版本进行测试，但不建议继续进一步操作。
2.  将通过测试的 ClickHouse 发布版本部署到预生产，并检查所有进程是否按预期运行。
3.  将您发现的任何问题报告到 [ClickHouse GitHub Issues](https://github.com/ClickHouse/ClickHouse/issues)。
4.  如果没有重大问题，那么应安全地将 ClickHouse 发布版本部署到您的生产环境中。投资于逐步发布自动化，实施类似于 [金丝雀发布](https://martinfowler.com/bliki/CanaryRelease.html) 或 [蓝绿部署](https://martinfowler.com/bliki/BlueGreenDeployment.html) 的方法，可能会进一步降低生产问题的风险。

正如您可能注意到的，上述方法并没有特别针对 ClickHouse —— 如果人们认真对待他们的生产环境，他们会在任何基础架构上这样做。

## 如何选择 ClickHouse 发布版本？ {#how-to-choose-between-clickhouse-releases}

如果您查看 ClickHouse 软件包库的内容，您会看到两种类型的包：

1.  `stable`
2.  `lts`（长期支持）

以下是选择它们之间的一些指导：

- `stable` 是我们默认推荐的包类型。它们大约每月发布一次（因此以合理的延迟提供新功能），并且最新的三个稳定版本在诊断和错误修复回填方面提供支持。
- `lts` 每年发布两次，并在首次发布后支持一年。在以下情况下，您可能更喜欢它们而不是 `stable`：
    - 您的公司有内部政策，不允许进行频繁升级或使用非 LTS 软件。
    - 您在某些次要产品中使用 ClickHouse，而这些产品既不需要复杂的 ClickHouse 功能，也没有足够的资源进行更新。

许多最初认为 `lts` 是最佳选择的团队，最终会因为某些对其产品重要的最新功能而切换回 `stable`。

:::tip    
升级 ClickHouse 时要记住的一件事情是：我们始终关注各版本之间的兼容性，但有时不合理地需要保留，因此某些细节可能会有所变化。因此，在升级之前，请确保查看 [变更日志](/whats-new/changelog/index.md)，以查看是否有关于不兼容更改的注释。
:::
