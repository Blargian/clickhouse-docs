---
'slug': '/faq/operations/production'
'title': '在生产中应使用哪个 ClickHouse 版本？'
'toc_hidden': true
'toc_priority': 10
'description': '本页面提供有关在生产中应使用哪个 ClickHouse 版本的指导'
---


# 在生产中使用哪个 ClickHouse 版本？ {#which-clickhouse-version-to-use-in-production}

首先，让我们讨论一下人们为什么会问这个问题。主要有两个原因：

1.  ClickHouse 的开发速度相当高，通常每年有超过 10 个稳定版本发布。这使得可以选择的版本范围非常广泛，这并不是一个简单的选择。
2.  一些用户希望避免花时间去搞清楚哪个版本最适合他们的用例，只是跟随其他人的建议。

第二个原因更为根本，因此我们将先从这点开始，然后再回到如何浏览各种 ClickHouse 版本。

## 您推荐使用哪个 ClickHouse 版本？ {#which-clickhouse-version-do-you-recommend}

雇用顾问或信任一些知名专家以摆脱对您生产环境的责任是很诱人的。您安装某个特定的 ClickHouse 版本，因为其他人推荐过；如果出现问题，那不是您的错，是别人的。这种推理是一个大陷阱。没有外部人员比您更了解您公司生产环境中发生的事情。

那么，您如何正确选择要升级到的 ClickHouse 版本？或者，您如何选择您的第一个 ClickHouse 版本？首先，您需要投资建立一个 **现实的预生产环境**。理想情况下，它可以是一个完全相同的影子副本，但这通常很昂贵。

以下是一些关键点，以在不那么高的成本下获得合理的预生产环境可信度：

- 预生产环境需要运行与您打算在生产中运行的查询集尽可能接近的查询：
    - 不要让它成为只读，并只包含冻结的数据。
    - 不要让它成为写入模式，仅复制数据而不生成一些典型报告。
    - 不要清除环境，而是应用模式迁移。
- 使用真实生产数据和查询的一部分样本。尝试选择一个仍然具有代表性且能使 `SELECT` 查询返回合理结果的样本。如果您的数据敏感且内部政策不允许其离开生产环境，请使用模糊处理。
- 确保预生产环境受到与生产环境相同的监控和警报软件的覆盖。
- 如果您的生产跨多个数据中心或地区，请确保您的预生产环境也是如此。
- 如果您的生产使用复杂特性如复制、分布式表和级联物化视图，请确保在预生产中相似地配置它们。
- 在预生产中使用的服务器或虚拟机数量和生产中的大致相同，但规模较小，或更少的服务器但与生产规模相同是有权衡的。第一个选项可能会捕捉到额外的网络相关问题，而后者更容易管理。

第二个投资领域是 **自动化测试基础设施**。不要假设某种查询只要成功执行过一次，之后就会永远成功。拥有一些模拟 ClickHouse 的单元测试是可以的，但请确保您的产品具备合理的自动化测试集，以实际 ClickHouse 运行并检查所有重要用例是否仍按预期工作。

进一步的步骤可以是在 [ClickHouse 的开源测试基础设施](https://github.com/ClickHouse/ClickHouse/tree/master/tests) 中贡献这些自动化测试，这些测试在其日常开发中不断使用。学习 [如何运行它](../../development/tests.md) 以及如何将您的测试适配到这个框架肯定会花费一些额外的时间和精力，但将会有所回报，因为 ClickHouse 发布时，它们已经在这些测试中通过了验证，而不是在问题发生后反复花时间报告，然后等待修复的实现、回溯和发布。一些公司甚至将这种测试贡献作为内部政策，（在 Google 被称为 [Beyonce's Rule](https://www.oreilly.com/library/view/software-engineering-at/9781492082781/ch01.html#policies_that_scale_well)）。

当您建立了预生产环境和测试基础设施后，选择最佳版本就变得简单明了：

1.  定期对新的 ClickHouse 版本运行自动化测试。即使是标记为 `testing` 的 ClickHouse 版本，也可以这样做，但不建议继续推进后续步骤。
2.  将通过测试的 ClickHouse 版本部署到预生产，并检查所有流程是否按预期运行。
3.  将您发现的任何问题报告到 [ClickHouse GitHub Issues](https://github.com/ClickHouse/ClickHouse/issues)。
4.  如果没有重大问题，开始将 ClickHouse 版本部署到生产环境应该是安全的。投资于逐步发布自动化，采用类似于 [金丝雀发布](https://martinfowler.com/bliki/CanaryRelease.html) 或 [蓝绿部署](https://martinfowler.com/bliki/BlueGreenDeployment.html) 的方法，可能进一步降低生产中的问题风险。

正如您可能注意到的，上述方法并没有特别针对 ClickHouse - 对于他们所依赖的任何基础设施，认真对待生产环境的人都是这样做的。

## 如何选择 ClickHouse 版本？ {#how-to-choose-between-clickhouse-releases}

如果查看 ClickHouse 包存储库的内容，您会看到两种类型的包：

1.  `stable`
2.  `lts`（长期支持）

以下是关于如何在它们之间进行选择的一些指导：

- `stable` 是我们默认推荐的包类型。它们大约每月发布一次（因此以合理的延迟提供新功能），并且支持最新的三个稳定版本的诊断和回溯修复。
- `lts` 每年发布两次，并在首次发布后支持一年。在以下情况下，您可能更喜欢使用 `lts` 而非 `stable`：
    - 您的公司有一些内部政策不允许频繁升级或使用非 LTS 软件。
    - 您在某些次要产品中使用 ClickHouse，这些产品要么不需要复杂的 ClickHouse 特性，要么没有足够的资源来保持其更新。

经历过的许多团队，最初认为 `lts` 是最佳选择，最终往往还是会因为某些对他们产品重要的最新功能而切换到 `stable`。

:::tip    
升级 ClickHouse 时还需要记住一件事：我们始终关注版本之间的兼容性，但有时保持兼容性并不合理，某些细节可能会改变。因此，在升级之前请务必查看 [变更日志](/whats-new/changelog/index.md)，以查看是否有关于向后不兼容更改的说明。
:::
