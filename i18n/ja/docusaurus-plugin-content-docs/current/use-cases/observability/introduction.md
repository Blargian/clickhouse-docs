---
title: はじめに
description: ClickHouseを観測ソリューションとして使用する
slug: /use-cases/observability/introduction
keywords: [observability, logs, traces, metrics, OpenTelemetry, Grafana, OTel]
---

# ClickHouseを用いた観測

## はじめに {#introduction}

このガイドは、ClickHouseを使用して独自のSQLベースの観測ソリューションを構築しようとしているユーザー向けに設計されています。このガイドでは、ログやトレースに焦点を当て、独自のソリューションを構築するための取り込み、アクセスパターンに最適化されたスキーマ、非構造化ログからの構造の抽出に関する考慮事項をすべてカバーします。

ClickHouse単体は、観測用のオールインワンソリューションではありません。しかし、観測データのための非常に効率的なストレージエンジンとして使用でき、比類のない圧縮率と超高速のクエリ応答時間を実現します。ユーザーが観測ソリューション内でClickHouseを使用するには、ユーザーインターフェースとデータ収集フレームワークが必要です。現在、観測信号の可視化には**Grafana**を、データ収集には**OpenTelemetry**を使用することを推奨しています（どちらも公式にサポートされている統合です）。

<img src={require('./images/observability-1.png').default}    
  class="image"
  alt="NEEDS ALT"
  style={{width: '800px'}} />

<br />

:::note OpenTelemetryだけではない
私たちの推奨は、データ収集のためにOpenTelemetry (OTel)プロジェクトを使用することですが、VectorやFluentdなど他のフレームワークやツールを使用して同様のアーキテクチャを構築することも可能です（[Fluent Bitの例](https://clickhouse.com/blog/kubernetes-logs-to-clickhouse-fluent-bit)を参照）。SupersetやMetabaseなどの代替可視化ツールも存在します。
:::

## なぜClickHouseを使用するのか？ {#why-use-clickhouse}

集中型の観測ストアの最も重要な機能は、多様なソースからの膨大なログデータを迅速に集約、分析、および検索する能力です。この集中化は、トラブルシューティングを効率化し、サービス障害の根本原因を特定しやすくします。

ユーザーはますます価格に敏感になっており、こうしたオールインワン製品のコストが高く予測不可能な価値に対して、コスト効率が良く予測可能なログストレージがますます重要になっています。

性能とコスト効率により、ClickHouseは観測製品におけるログとトレースのストレージエンジンの事実上の標準となっています。

より具体的には、以下の理由からClickHouseは観測データのストレージに最適です：

- **圧縮** - 観測データは通常、HTTPコードやサービス名など、特定のセットから値を取得するフィールドを含みます。ClickHouseの列指向ストレージでは、値がソートされて保存されるため、このデータは非常に効果的に圧縮されます。特に、タイムシリーズデータ用のさまざまな専門的なコーデックと組み合わせると、圧縮効果が高まります。他のデータストアでは、通常JSON形式のデータと同じサイズのストレージが必要ですが、ClickHouseは平均してログとトレースを最大14倍圧縮します。大規模な観測インストールにおいて大きなストレージ節約を提供するだけでなく、この圧縮はディスクから読み込む必要があるデータ量が少なくなるため、クエリの加速にも寄与します。
- **高速集約** - 観測ソリューションは、通常、エラーレートを示す線グラフやトラフィックソースを示す棒グラフなど、データの可視化に依存します。集約やGROUP BYは、これらのチャートを強力にするための基本要素であり、問題診断のためのワークフローでフィルターを適用する際にも迅速かつ応答性が求められます。ClickHouseの列指向形式とベクトル化クエリ実行エンジンの組み合わせは、高速集約に最適で、スパースインデックスを使用してユーザーのアクションに応じたデータの迅速なフィルタリングを可能にします。
- **高速線形スキャン** - 他の技術はログの迅速なクエリのために逆インデックスに依存しますが、これは必然的に高いディスクおよびリソース利用につながります。ClickHouseは追加のオプションインデックスタイプとして逆インデックスも提供しますが、線形スキャンは非常に並列化されており、マシン上の利用可能なすべてのコアを使用します（別途設定されていない限り）。これにより、1秒間に数十GB（圧縮）を検索することが可能になります。[非常に最適化されたテキストマッチングオペレーター](/sql-reference/functions/string-search-functions)を使用しています。
- **SQLの馴染み** - SQLはすべてのエンジニアが慣れ親しんでいる普遍的な言語です。50年以上の開発を経て、データ分析の事実上の標準言語としての地位を確立しています。現在も[3番目に人気のあるプログラミング言語](https://clickhouse.com/blog/the-state-of-sql-based-observability#lingua-franca)です。観測は、SQLが理想的な別のデータの問題です。
- **分析関数** - ClickHouseは、SQLクエリを簡単に書けるように設計された分析関数を使用してANSI SQLを拡張しています。これらは、データを切り分けて分析するときに重要です。
- **二次インデックス** - ClickHouseは、特定のクエリプロファイルを加速するために、ブルームフィルターなどの二次インデックスをサポートしています。これらはカラムレベルでオプションとして有効にすることができ、ユーザーに対して詳細なコストパフォーマンス評価が可能です。
- **オープンソースとオープン標準** - オープンソースデータベースとして、ClickHouseはOpen Telemetryなどのオープン標準を受け入れています。プロジェクトに貢献し、積極的に参加できる能力は魅力的であり、ベンダーロックインの課題を避けることができます。

## いつClickHouseを観測に使用するべきか {#when-should-you-use-clickhouse-for-observability}

ClickHouseを観測データに使用するには、ユーザーがSQLベースの観測を受け入れる必要があります。このテーマに関する歴史については[こちらのブログ記事](https://clickhouse.com/blog/the-state-of-sql-based-observability)を推奨しますが、要約すると以下の通りです：

SQLベースの観測は次のような方に向いています：

- あなたやあなたのチームがSQLに慣れている（または学びたい）場合
- OpenTelemetryのようなオープン標準に従い、ロックインを避けて拡張性を実現したい場合
- 収集から保存、可視化までオープンソースの革新に支えられたエコシステムを運営したい場合
- 管理下にある観測データの中規模または大規模な成長を見込んでいる場合（または非常に大きなボリューム）
- TCO（総所有コスト）をコントロールし、観測コストの高騰を避けたい場合
- 観測データのコスト管理のために短期間のデータ保持に縛られたくない場合

SQLベースの観測が向いていない場合は次の通りです：

- SQLを学ぶ（または生成する）ことがあなたやあなたのチームにとって魅力的ではない場合
- パッケージ化されたエンドツーエンドの観測体験を探している場合
- 観測データのボリュームが小さすぎて大きな影響を与えない場合（例：&lt;150 GiB）か、成長が見込まれない場合
- 利用ケースがメトリクス重視でPromQLが必要な場合。その場合でも、メトリクスにはPrometheusを用い、ClickHouseをログとトレースに統一してGrafanaでプレゼンテーション層でまとめることができます。
- エコシステムが成熟し、SQLベースの観測がより簡単に使えるようになるのを待ちたい場合

## ログとトレース {#logs-and-traces}

観測のユースケースには、ログ、トレース、メトリクスの三つの明確な柱があります。それぞれに独自のデータタイプとアクセスパターンがあります。

現在、ClickHouseは観測データの二種類のストレージにおいて推奨されています：

- **ログ** - ログは、システム内で発生するイベントの時間スタンプ付き記録であり、ソフトウェアの操作のさまざまな側面について詳細な情報をキャプチャします。ログのデータは通常、非構造化または半構造化であり、エラーメッセージ、ユーザーアクティビティログ、システムの変更、その他のイベントを含むことがあります。ログは、トラブルシューティング、異常検知、システム内の問題が発生する直前の具体的なイベントを理解するために重要です。

```response
54.36.149.41 - - [22/Jan/2019:03:56:14 +0330] "GET
/filter/27|13%20%D9%85%DA%AF%D8%A7%D9%BE%DB%8C%DA%A9%D8%B3%D9%84,27|%DA%A9%D9%85%D8%AA%D8%B1%20%D8%A7%D8%B2%205%20%D9%85%D8%A7%DA%AF%D9%BE%DB%8C%DA%A9%D8%B3%D9%84,p53 HTTP/1.1" 200 30577 "-" "Mozilla/5.0 (compatible; AhrefsBot/6.1; +http://ahrefs.com/robot/)" "-"
```

- **トレース** - トレースは、分散システム内の異なるサービスを横断するリクエストの旅をキャプチャし、これらのリクエストのパスと性能を詳細に示します。トレース内のデータは高度に構造化されており、スパンとトレースがそれぞれのリクエストのステップを示し、タイミング情報が含まれます。トレースはシステムパフォーマンスについて貴重な洞察を提供し、ボトルネックやレイテンシの問題を特定し、マイクロサービスの効率を最適化する助けになります。

:::note メトリクス
ClickHouseはメトリクスデータの保存にも使用可能ですが、この柱に関してはClickHouseでは成熟度が低く、PrometheusデータフォーマットやPromQLのサポートが未確認の状態です。
:::

### 分散トレーシング {#distributed-tracing}

分散トレーシングは観測の重要な機能です。分散トレースは、単にトレースと呼ばれ、システム内のリクエストの旅をマッピングします。リクエストはエンドユーザーまたはアプリケーションから始まり、システム全体に広がるため、通常はマイクロサービス間のアクションの流れを生成します。このシーケンスを記録し、以降のイベントを相関させることにより、観測ユーザーやSREがアプリケーションフロー内の課題を診断できるようになります。これは、アーキテクチャがどれほど複雑であってもサーバーレスであっても、です。

各トレースは複数のスパンで構成され、リクエストに関連付けられた最初のスパンはルートスパンと呼ばれます。このルートスパンは、最初から最後までの全リクエストをキャプチャします。ルートの下の後続スパンは、リクエスト中に発生するさまざまなステップや操作に関する詳細な洞察を提供します。トレースがないと、分散システム内のパフォーマンス問題を診断するのは非常に難しくなります。トレースはリクエストがシステム内を移動する際のイベントの順序を詳細に示すことで、デバッグと分散システムの理解を容易にします。

ほとんどの観測ベンダーは、この情報を水fallの形で可視化し、相対的なタイミングを相応のサイズの水平バーで表現します。たとえば、Grafanaでは：

<img src={require('./images/observability-2.png').default}    
  class="image"
  alt="NEEDS ALT"
  style={{width: '1000px'}} />

<br />

ログとトレースの概念に深く慣れる必要があるユーザーには、[OpenTelemetryのドキュメント](https://opentelemetry.io/docs/concepts/)を強く推奨します。
