---
sidebar_label: 概要
sidebar_position: 0
slug: /cloud/manage/backups/overview
title: 概要
keywords: [バックアップ, クラウドバックアップ, リストア]
---

import CloudNotSupportedBadge from '@theme/badges/CloudNotSupportedBadge';
import ScalePlanFeatureBadge from '@theme/badges/ScalePlanFeatureBadge';

# バックアップ

データベースのバックアップは、安全ネットを提供し、予期しない理由でデータが失われた場合に、サービスを最後の成功したバックアップから以前の状態に復元できるようにします。これによりダウンタイムを最小化し、ビジネスに不可欠なデータが永久に失われるのを防ぎます。このガイドでは、ClickHouse Cloudにおけるバックアップの仕組み、サービスにバックアップを設定するためのオプション、およびバックアップからの復元方法について説明します。

## ClickHouse Cloudにおけるバックアップの仕組み {#how-backups-work-in-clickhouse-cloud}

ClickHouse Cloudのバックアップは、「完全」バックアップと「増分」バックアップからなるバックアップチェーンの組み合わせです。チェーンは完全バックアップから始まり、その後、次の数回のスケジュールされた時間帯に増分バックアップが取られてバックアップのシーケンスが形成されます。バックアップチェーンが一定の長さに達すると、新しいチェーンが開始されます。このバックアップチェーン全体は、必要に応じて新しいサービスにデータを復元するために利用できます。特定のチェーンに含まれるすべてのバックアップがサービスに設定された保持期間を過ぎると（保持については後述）、チェーンは破棄されます。

以下のスクリーンショットでは、実線の四角が完全バックアップを示し、点線の四角が増分バックアップを示しています。四角の周りの実線の長方形は、保持期間とエンドユーザーが表示できるバックアップを示しており、これをバックアップリストアに使用できます。以下のシナリオでは、バックアップが24時間ごとに行われ、2日間保持されます。

1日目に、バックアップチェーンを開始するために完全バックアップが取られます。2日目に増分バックアップが取られ、完全バックアップと増分バックアップの両方がリストア可能になります。7日目には、チェーンに完全バックアップ1つと6つの増分バックアップがありますが、最も最近の2つの増分バックアップがユーザーに表示可能です。8日目には、新しい完全バックアップを取り、9日目には、新しいチェーンにバックアップが2つあるときに、古いチェーンが破棄されます。

![バックアップチェーン](../images/backup-chain.png)

*ClickHouse Cloudにおけるバックアップシナリオの例*

## デフォルトのバックアップポリシー {#default-backup-policy}

Basic、Scale、Enterpriseプランでは、バックアップはメーターで測定され、ストレージとは別に請求されます。すべてのサービスは、バックアップを1つデフォルトで保持し、ScaleプランからはCloud Consoleの設定タブを介してより多くのバックアップを設定できます。

## バックアップステータスリスト {#backup-status-list}

サービスは、デフォルトのデイリースケジュールまたはユーザーが選択した[カスタムスケジュール](./configurable-backups.md)に基づいてバックアップされます。利用可能なすべてのバックアップは、サービスの**バックアップ**タブから表示できます。ここから、バックアップのステータス、所要時間、およびバックアップのサイズを確認できます。特定のバックアップを復元するために、**アクション**カラムを使用することもできます。

![バックアップステータスリスト](../images/backup-status-list.png)

## バックアップコストの理解 {#understanding-backup-cost}

デフォルトポリシーに従い、ClickHouse Cloudでは毎日1回のバックアップと、24時間の保持が義務付けられています。より多くのデータを保持する必要があるスケジュールや、バックアップがより頻繁に行われるスケジュールを選択することは、バックアップのために追加のストレージ料金を引き起こす可能性があります。

バックアップコストを理解するには、使用状況画面からサービスごとのバックアップコストを確認できます（下記参照）。カスタマイズされたスケジュールで数日間バックアップを実行した後、コストのアイデアを得て、それを外挿して、バックアップの月額コストを算出できます。

![バックアップ使用状況チャート](../images/backup-usage.png)

バックアップの総コストを見積もるには、スケジュールを設定する必要があります。また、スケジュールを設定する前に月額コストを見積もるために[料金計算機](https://clickhouse.com/pricing)の更新にも取り組んでいます。コストを見積もるには、以下の入力が必要です：
- 完全バックアップと増分バックアップのサイズ
- 希望の頻度
- 希望の保持期間
- クラウドプロバイダーと地域

:::note
サービス内のデータサイズが時間とともに増加するにつれて、バックアップの推定コストは変動することを考慮してください。
:::

## バックアップの復元 {#restore-a-backup}

バックアップは、バックアップを取得した既存のサービスではなく、新しいClickHouse Cloudサービスに復元されます。

**バックアップを復元**アイコンをクリックすると、作成される新しいサービスのサービス名を指定し、このバックアップを復元できます：

![バックアップの復元](../images/backup-restore.png)

新しいサービスは、準備ができるまでサービスリストに`Provisioning`として表示されます：

<img src={require('../images/backup-service-provisioning.png').default}    
class="image"
alt="プロビジョニング中のサービス"
style={{width: '80%'}} />

## 復元されたサービスとの作業 {#working-with-your-restored-service}

バックアップが復元されると、2つの類似のサービスが存在します：復元する必要があった**元のサービス**と、元のバックアップから復元された新しい**復元されたサービス**です。

バックアップリストアが完了したら、次のいずれかを行う必要があります：
- 新しい復元されたサービスを使用し、元のサービスを削除します。
- 新しい復元されたサービスから元のサービスにデータを移行し、新しい復元されたサービスを削除します。

### **新しい復元されたサービス**を使用する {#use-the-new-restored-service}

新しいサービスを使用するには、次の手順を実行します：

1. 新しいサービスに必要なIPアクセスリストのエントリが含まれていることを確認します。
1. 新しいサービスに必要なデータが含まれていることを確認します。
1. 元のサービスを削除します。

### **新しく復元されたサービス**から**元のサービス**にデータを移行する {#migrate-data-from-the-newly-restored-service-back-to-the-original-service}

例えば、何らかの理由で新しく復元されたサービスを使用できない場合（既存のサービスに接続するユーザーやアプリケーションがまだ存在する場合など）、新しく復元されたデータを元のサービスに移行することを決定するかもしれません。移行は、以下の手順に従って実行できます。

**新しく復元されたサービスへのリモートアクセスを許可する**

新しいサービスは、元のサービスと同じIP許可リストからバックアップを復元する必要があります。これは、他のClickHouse Cloudサービスへの接続が許可されないため必要です。ただし、**Anywhere**からのアクセスが許可されている場合を除きます。許可リストを変更し、一時的に**Anywhere**からのアクセスを許可してください。詳細については[IPアクセスリスト](/cloud/security/setting-ip-filters)のドキュメントを参照してください。

**新しく復元されたClickHouseサービス上（復元されたデータをホストするシステム）**

:::note
新しいサービスにアクセスするためにパスワードをリセットする必要があります。サービスリストの**設定**タブから行うことができます。
:::

ソーステーブル（この例では`db.table`）を読み取ることができる読み取り専用ユーザーを追加します：

```sql
CREATE USER exporter
IDENTIFIED WITH SHA256_PASSWORD BY 'password-here'
SETTINGS readonly = 1;
```

```sql
GRANT SELECT ON db.table TO exporter;
```

テーブル定義をコピーします：

```sql
SELECT create_table_query
FROM system.tables
WHERE database = 'db' AND table = 'table'
```

**損傷したテーブルがあった宛先のClickHouse Cloudシステム上：**

宛先データベースを作成します：
```sql
CREATE DATABASE db
```

ソースからの`CREATE TABLE`文を使用して、宛先を作成します：

:::tip
`CREATE`文を実行するときに`ENGINE`をパラメータなしの`ReplicatedMergeTree`に変更してください。ClickHouse Cloudは常にテーブルを複製し、正しいパラメータを提供します。
:::

```sql
CREATE TABLE db.table ...
ENGINE = ReplicatedMergeTree
ORDER BY ...
```

`remoteSecure`関数を使用して、新しく復元されたClickHouse Cloudサービスから元のサービスにデータを引き込む：

```sql
INSERT INTO db.table 
SELECT * 
FROM remoteSecure('source-hostname', db, table, 'exporter', 'password-here')
```

元のサービスにデータの挿入が成功したら、サービス内のデータを確認してください。データが確認されたら、新しいサービスを削除します。

## テーブルの復元または削除の取り消し {#undeleting-or-undropping-tables}

<CloudNotSupportedBadge/>

`UNDROP`コマンドはClickHouse Cloudではサポートされていません。テーブルを誤って`DROP`してしまった場合、最善のアクションは最後のバックアップを復元し、バックアップからテーブルを再作成することです。

ユーザーがテーブルを誤って削除するのを防ぐために、特定のユーザーやロールに対して[`DROP TABLE`コマンド](/sql-reference/statements/drop#drop-table)の権限を取り消すために、[`GRANT`ステートメント](/sql-reference/statements/grant)を使用できます。

:::note
データの誤削除を防ぐために、ClickHouse Cloudではデフォルトでサイズが>`1TB`のテーブルを削除することはできないことに注意してください。この閾値より大きなテーブルを削除したい場合は、`max_table_size_to_drop`設定を使用して実行できます：

```sql
DROP TABLE IF EXISTS table_to_drop 
SYNC SETTINGS max_table_size_to_drop=2097152 -- 限度を2TBに増加
```
:::

## 設定可能バックアップ {#configurable-backups}

デフォルトのバックアップスケジュールとは異なるバックアップスケジュールを設定したい場合は、[設定可能バックアップ](./configurable-backups.md)を確認してください。

## 自分のクラウドアカウントへのバックアップのエクスポート {#export-backups-to-your-own-cloud-account}

自分のクラウドアカウントにバックアップをエクスポートしたいユーザーは、[こちら](./export-backups-to-own-cloud-account.md)を参照してください。
