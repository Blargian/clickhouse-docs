---
sidebar_position: 1
sidebar_label: 自動スケーリング
slug: /manage/scaling
description: ClickHouse Cloudにおける自動スケーリングの設定
keywords: [自動スケーリング, オートスケーリング, スケーリング, 水平, 垂直, バースト]
---

import ScalePlanFeatureBadge from '@theme/badges/ScalePlanFeatureBadge'

# 自動スケーリング

スケーリングとは、クライアントの需要に応じて利用可能なリソースを調整する能力のことです。ScaleおよびEnterprise（標準1:4プロファイル）ティアサービスは、API呼び出しをプログラム的に行うか、UI上で設定を変更することで水平スケーリングが可能です。あるいは、これらのサービスはアプリケーションの需要に合わせて**自動的に垂直にスケーリング**することもできます。

<ScalePlanFeatureBadge feature="自動的な垂直スケーリング"/>

## ClickHouse Cloudでのスケーリングの仕組み {#how-scaling-works-in-clickhouse-cloud}

現在、ClickHouse Cloudは、Scaleティアサービスに対して垂直自動スケーリングと手動の水平スケーリングをサポートしています。

Enterpriseティアサービスでは、スケーリングは以下のように機能します：

- **水平スケーリング**: 手動の水平スケーリングは、エンタープライズティアのすべての標準およびカスタムプロファイルで利用可能です。  
- **垂直スケーリング**:
  - 標準プロファイル（1:4）は、垂直自動スケーリングをサポートします。
  - カスタムプロファイルは、リリース時には垂直自動スケーリングまたは手動の垂直スケーリングをサポートしません。ただし、これらのサービスはサポートに連絡することで垂直にスケーリングできます。

:::note
コンピュートレプリカのための新しい垂直スケーリングメカニズムを導入しています。これを「Make Before Break」（MBB）と呼びます。このアプローチでは、古いレプリカを削除する前に新しいサイズのレプリカを1つ以上追加し、スケーリング操作中の容量損失を防ぎます。既存のレプリカを削除し、新しいレプリカを追加する間隔を排除することで、MBBはよりシームレスで中断の少ないスケーリングプロセスを実現します。特に、高リソース使用が追加容量の必要性を引き起こすスケールアップシナリオにおいて有益です。なぜなら、レプリカを早期に削除するとリソース制約が悪化するだけだからです。

この変更の一環として、スケーリングイベントの一環として最大30日間、履歴のシステムテーブルデータが保持されます。さらに、AWSまたはGCP上のサービスの場合は2024年12月19日以前のシステムテーブルデータ、Azure上のサービスの場合は2025年1月14日以前のシステムテーブルデータは、新しい組織ティアへの移行の一環として保持されません。
:::

### 垂直自動スケーリング {#vertical-auto-scaling}

<ScalePlanFeatureBadge feature="自動的な垂直スケーリング"/>

ScaleおよびEnterpriseサービスは、CPUおよびメモリ使用量に基づく自動スケーリングをサポートしています。我々は、スケーリングの意思決定を行うために、サービスの過去30時間の履歴使用量を常に監視しています。使用量が特定の閾値を上回ったり下回ったりした場合、需要に応じてサービスを適切にスケールします。

CPUベースの自動スケーリングは、CPU使用量が50-75%の上限閾値を超えると発動します（実際の閾値はクラスタのサイズによります）。この時点で、クラスタに対するCPUの割り当ては倍増します。CPU使用量が上限閾値の半分（例えば、50%の上限閾値の場合、25%に下がる）を下回ると、CPUの割り当ては半減します。

メモリベースの自動スケーリングは、最大メモリ使用量の125%またはOOM（メモリ不足）エラーが発生した場合は150%までクラスタをスケールします。

**大きい方**のCPUまたはメモリの推奨値が選択され、サービスに割り当てられるCPUとメモリは、`1` CPUおよび`4 GiB`メモリの増分でスケーリングされます。

### 垂直自動スケーリングの設定 {#configuring-vertical-auto-scaling}

ClickHouse CloudのScaleまたはEnterpriseサービスのスケーリングは、**Admin**ロールを持つ組織のメンバーによって調整できます。垂直自動スケーリングを設定するには、サービスの**設定**タブに移動し、以下に示すように最小および最大メモリ、CPU設定を調整します。

:::note
単一レプリカサービスは、すべてのティアでスケーリングできません。
:::

<div class="eighty-percent">
![スケーリング設定ページ](./images/AutoScaling.png)
</div>

レプリカの**最大メモリ**を**最小メモリ**よりも高い値に設定します。これにより、サービスはその範囲内で必要に応じてスケールします。これらの設定は、初期のサービス作成フロー中にも利用可能です。サービス内の各レプリカには、同じメモリとCPUのリソースが割り当てられます。

これらの値を同じに設定することもでき、実質的にサービスを特定の設定に「ピン留め」します。この場合、選択したサイズにすぐにスケーリングが強制されます。

重要なのは、これによりクラスターの自動スケーリングが無効になり、これらの設定を超えるCPUまたはメモリ使用量の増加からサービスが保護されなくなることです。

:::note
Enterpriseティアサービスでは、標準1:4プロファイルが垂直自動スケーリングをサポートします。カスタムプロファイルは、リリース時には垂直自動スケーリングまたは手動の垂直スケーリングをサポートしません。ただし、これらのサービスはサポートに連絡することで垂直にスケーリングできます。
:::

## 手動の水平スケーリング {#manual-horizontal-scaling}

<ScalePlanFeatureBadge feature="手動の水平スケーリング"/>

ClickHouse Cloudの[公開API](/cloud/manage/api/swagger#/paths/~1v1~1organizations~1:organizationId~1services~1:serviceId~1scaling/patch)を使って、サービスのスケーリング設定を更新したり、クラウドコンソールからレプリカの数を調整したりしてサービスをスケーリングできます。

**Scale**および**Enterprise**ティアでは単一レプリカサービスがサポートされています。ただし、複数のレプリカで始まったり、複数のレプリカにスケールアウトしたりするティア内のサービスは、最小`2`レプリカまでしかスケーリングバックできません。

:::note
サービスは最大20レプリカまで水平にスケーリングできます。追加のレプリカが必要な場合は、サポートチームにお問い合わせください。
:::

### APIによる水平スケーリング {#horizontal-scaling-via-api}

クラスタを水平にスケールするには、API経由で`PATCH`リクエストを発行してレプリカの数を調整します。以下のスクリーンショットは、`3`レプリカのクラスタを`6`レプリカにスケールアウトするAPIコールと、その応答を示しています。

<img alt="スケーリング設定ページ"
    style={{width: '500px', marginLeft: 0}}
    src={require('./images/scaling-patch-request.png').default} />

*`numReplicas`を更新する`PATCH`リクエスト*

<img alt="スケーリング設定ページ"
    style={{width: '450px', marginLeft: 0}}
    src={require('./images/scaling-patch-response.png').default} />

*`PATCH`リクエストからの応答*

新しいスケーリングリクエストや複数のリクエストを連続して送信した場合、1つのリクエストが進行中でもスケーリングサービスは中間状態を無視し、最終的なレプリカ数に収束します。

### UIによる水平スケーリング {#horizontal-scaling-via-ui}

UIからサービスを水平にスケールするには、サービスの**設定**ページでレプリカの数を調整できます。

<img alt="スケーリング設定ページ"
    style={{width: '500px', marginLeft: 0}}
    src={require('./images/scaling-configure.png').default} />

*ClickHouse Cloudコンソールからのサービススケーリング設定*

サービスがスケールされた後、クラウドコンソールのメトリクスダッシュボードには、サービスに対する正しい割り当てが表示されるはずです。以下のスクリーンショットは、クラスタが合計メモリ`96 GiB`（`6`レプリカ、各`16 GiB`のメモリ割り当て）にスケールされたことを示しています。

<img alt="スケーリング設定ページ"
    style={{width: '500px', marginLeft: 0}}
    src={require('./images/scaling-memory-allocation.png').default} />

## 自動アイドル状態 {#automatic-idling}
**設定**ページでは、サービスがアイドル状態の際（ユーザーが提出したクエリを実行していないとき）に自動アイドル状態にするかどうかを選択できます。自動アイドル状態は、サービスが停止している間、計算リソースに対して請求されないため、サービスのコストを削減します。

:::note
特定の特殊な状況、例えばサービスが多数のパーツを持っている場合には、サービスは自動的にアイドルになりません。

サービスは、[更新可能なマテリアライズドビュー](/materialized-view/refreshable-materialized-view)の更新、[S3Queue](/engines/table-engines/integrations/s3queue)からの消費、新しいマージのスケジューリングを一時停止してアイドル状態になります。アイドル状態に移行する前に、既存のマージ操作は完了します。更新可能なマテリアライズドビューやS3Queueの消費を継続的に運用するためには、アイドル状態の機能を無効にしてください。
:::

:::danger 自動アイドル状態を使用すべきでない場合
自動アイドル状態は、クエリに応答するまで遅れが発生することに耐えられるユースケースでのみ使用してください。サービスが停止しているときには、サービスへの接続がタイムアウトします。自動アイドル状態は、頻繁に使用される顧客向け機能をサポートするサービスには推奨されません。
:::

## バーストなワークロードの処理 {#handling-bursty-workloads}
今後のワークロードの急増が予想される場合、[ClickHouse Cloud API](/cloud/manage/api/services-api-reference.md)を使用して、急増に対処するためにサービスを事前にスケールアップし、需要が落ち着いたらスケールダウンすることができます。各レプリカの現在のCPUコア数とメモリ使用量を理解するためには、以下のクエリを実行します：

```sql
SELECT *
FROM clusterAllReplicas('default', view(
    SELECT
        hostname() AS server,
        anyIf(value, metric = 'CGroupMaxCPU') AS cpu_cores,
        formatReadableSize(anyIf(value, metric = 'CGroupMemoryTotal')) AS memory
    FROM system.asynchronous_metrics
))
ORDER BY server ASC
SETTINGS skip_unavailable_shards = 1
```
