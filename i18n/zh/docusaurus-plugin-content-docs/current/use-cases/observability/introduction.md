import observability_1 from '@site/static/images/use-cases/observability/observability-1.png';
import observability_2 from '@site/static/images/use-cases/observability/observability-2.png';
import Image from '@theme/IdealImage';

# 使用 ClickHouse 进行可观察性

## 介绍 {#introduction}

本指南旨在帮助寻求构建基于 SQL 的可观察性解决方案的用户，侧重于日志和跟踪。它涵盖了构建自己解决方案的各个方面，包括数据摄取的考虑、根据访问模式优化架构以及从非结构化日志中提取结构的数据。

单靠 ClickHouse 并不是一个开箱即用的可观察性解决方案。然而，它可以用作可观察性数据的高效存储引擎，具备无与伦比的压缩率和闪电般快速的查询响应时间。为了让用户能够在可观察性解决方案中使用 ClickHouse，需要同时配备用户界面和数据收集框架。我们目前推荐使用 **Grafana** 来可视化可观察性信号，并使用 **OpenTelemetry** 来进行数据收集（这两者都是官方支持的集成）。

<Image img={observability_1} alt="简单的 OTel" size="md"/>

<br />

:::note 不仅仅是 OpenTelemetry
虽然我们建议使用 OpenTelemetry (OTel) 项目进行数据收集，但也可以利用其他框架和工具（例如 Vector 和 Fluentd）构建类似的架构（请参见 [一个示例](https://clickhouse.com/blog/kubernetes-logs-to-clickhouse-fluent-bit) 使用 Fluent Bit）。还有其他可视化工具可供选择，包括 Superset 和 Metabase。
:::

## 为什么使用 ClickHouse？ {#why-use-clickhouse}

任何集中式可观察性存储最重要的特性是其能够快速聚合、分析和搜索来自不同来源的庞大日志数据。这样的集中化简化了故障排除，使定位服务中断的根本原因变得更加容易。

随着用户对成本的敏感性增加，发现这些现成产品的成本高且不可预测，与其带来的价值相比，具有成本效益和可预测的日志存储变得愈发重要，尤其是在可接受的查询性能下。

由于其性能和成本效率，ClickHouse 已成为可观察性产品中日志和跟踪存储引擎的事实标准。

更具体地说，以下几点说明 ClickHouse 非常适合存储可观察性数据：

- **压缩** - 可观察性数据通常包含字段，其值来自于一个独特的集合，例如 HTTP 代码或服务名称。ClickHouse 的列式存储使得值按顺序存储，这意味着该数据的压缩效果非常好，特别是与一系列针对时间序列数据的专用编解码器相结合。与其他数据存储不同，ClickHouse 通常将日志和跟踪的平均压缩率提高到 14 倍，这不仅为大规模可观察性安装提供了显著的存储节省，还通过减少需要从磁盘读取的数据量来加速查询。
- **快速聚合** - 可观察性解决方案通常涉及通过图表可视化数据，例如显示错误率的线和显示流量来源的柱状图。聚合或 GROUP BY 是支撑这些图表的基础，它们在应用问题诊断工作流程中的过滤时也必须快速和响应。ClickHouse 的列式格式结合向量化查询执行引擎，非常适合快速聚合，在响应用户操作时，稀疏索引允许快速过滤数据。
- **快速线性扫描** - 尽管其他技术依赖反向索引快速查询日志，但这不可避免地导致高磁盘和资源利用率。虽然 ClickHouse 提供反向索引作为一种额外的可选索引类型，但线性扫描可高度并行化，并利用机器上所有可用核心（除非另行配置）。这使得每秒可能扫描 10s GB（压缩）以寻找匹配项，使用 [高度优化的文本匹配操作符](/sql-reference/functions/string-search-functions)。
- **SQL 的熟悉度** - SQL 是所有工程师都熟悉的通用语言。经过超过 50 年的发展，它已经证明自己是数据分析的事实语言，并仍然是 [第三大最受欢迎的编程语言](https://clickhouse.com/blog/the-state-of-sql-based-observability#lingua-franca)。可观察性只是一个数据问题，而 SQL 是解决此问题的理想工具。
- **分析函数** - ClickHouse 扩展了 ANSI SQL，提供用于简化和便于书写 SQL 查询的分析函数。这些函数对于执行根本原因分析的用户至关重要，因为数据需要被切片和 diced。
- **二级索引** - ClickHouse 支持二级索引，例如布隆过滤器，以加速特定查询轮廓。这些索引可以在列级别上选择性启用，为用户提供细粒度控制，并让他们评估成本与性能的收益。
- **开源与开放标准** - 作为一个开源数据库，ClickHouse 拥护开放标准，如 Open Telemetry。能够贡献并积极参与项目是吸引人的，同时规避供应商锁定的挑战。

## 何时应使用 ClickHouse 进行可观察性 {#when-should-you-use-clickhouse-for-observability}

使用 ClickHouse 进行可观察性数据需要用户接受基于 SQL 的可观察性。我们推荐 [这篇博客文章](https://clickhouse.com/blog/the-state-of-sql-based-observability) 来了解基于 SQL 的可观察性历史，但总结如下：

如果您符合以下条件，则适合使用基于 SQL 的可观察性：

- 您或您的团队熟悉 SQL（或想学习它）
- 您倾向于遵循如 OpenTelemetry 这样的开放标准，以避免锁定并实现可扩展性。
- 您愿意运行一个由开源创新推动的生态系统，从数据收集到存储和可视化。
- 您预计会有一些可观察性数据的中等或大规模增长（甚至是非常大规模的增长）
- 您希望控制 TCO（总拥有成本），避免可观察性成本失控。
- 您不想为您的可观察性数据设置较短的数据保留期以管理成本。

如果您符合以下条件，则可能不适合使用基于 SQL 的可观察性：

- 学习（或生成！）SQL 对您或您的团队不具吸引力。
- 您寻找的是一种打包的端到端可观察性体验。
- 您的可观察性数据量太小，无法产生任何显著差异（例如 &lt;150 GiB）且预计不会增长。
- 您的用例是以指标为主，并需要 PromQL。在这种情况下，您仍然可以使用 ClickHouse 处理日志和跟踪，同时在指标方面使用 Prometheus，并通过 Grafana 在展示层合并它们。
- 您更愿意等待生态系统更加成熟，基于 SQL 的可观察性得到更多的现成解决方案。

## 日志和跟踪 {#logs-and-traces}

可观察性用例有三个明显的支柱：日志、跟踪和指标。每个都有不同的数据类型和访问模式。

我们目前推荐 ClickHouse 用于存储两种类型的可观察性数据：

- **日志** - 日志是系统中发生事件的带时间戳的记录，捕获有关软件操作各个方面的详细信息。日志中的数据通常是非结构化或半结构化的，可能包含错误消息、用户活动日志、系统更改及其他事件。日志对于故障排除、异常检测和理解导致系统问题的特定事件至关重要。

```response
54.36.149.41 - - [22/Jan/2019:03:56:14 +0330] "GET
/filter/27|13%20%D9%85%DA%AF%D8%A7%D9%BE%DB%8C%DA%A9%D8%B3%D9%84,27|%DA%A9%D9%85%D8%AA%D8%B1%20%D8%A7%D8%B2%205%20%D9%85%DA%AF%D8%A7%D9%BE%DB%8C%DA%A9%D8%B3%D9%84,p53 HTTP/1.1" 200 30577 "-" "Mozilla/5.0 (compatible; AhrefsBot/6.1; +http://ahrefs.com/robot/)" "-"
```

- **跟踪** - 跟踪捕获请求在分布式系统中通过不同服务的旅程，详细描述这些请求的路径和性能。跟踪中的数据高度结构化，由跨度和跟踪组成，映射出请求所经过的每个步骤，包括时间信息。跟踪为系统性能提供了有价值的洞察，帮助识别瓶颈、延迟问题并优化微服务的效率。

:::note 指标
虽然 ClickHouse 可以用于存储指标数据，但在 ClickHouse 中这个支柱的成熟度较低，尚待支持 Prometheus 数据格式和 PromQL 等功能。
:::

### 分布式跟踪 {#distributed-tracing}

分布式跟踪是可观察性的一个关键特性。分布式跟踪，简单地称为跟踪，映射了请求在系统中的旅程。请求通常由最终用户或应用程序发起，并在系统中传播，通常导致微服务之间的一系列操作。通过记录这一序列，并允许后续事件相关联，它使得可观察性用户或 SRE 能够诊断应用程序流中的问题，无论架构多么复杂或无服务器。

每个跟踪由多个跨度组成，初始跨度与请求相关联，称为根跨度。根跨度记录了整个请求的开始到结束。根跨度下的后续跨度提供了请求过程中各种步骤或操作的详细洞察。如果没有跟踪，在分布式系统中诊断性能问题可能会非常困难。跟踪通过详细描述请求在系统中移动时的事件序列，简化了调试和理解分布式系统的过程。

大多数可观察性供应商将这些信息可视化为瀑布图，其相对时间使用大小不等的水平条表示。例如，在 Grafana 中：

<Image img={observability_2} alt="示例跟踪" size="lg" border/>

对于需要深刻了解日志和跟踪概念的用户，我们强烈推荐 [OpenTelemetry 文档](https://opentelemetry.io/docs/concepts/)。
