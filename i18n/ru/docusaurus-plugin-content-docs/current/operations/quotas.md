---
description: 'Руководство по настройке и управлению квотами использования ресурсов в ClickHouse'
sidebar_label: 'Квоты'
sidebar_position: 51
slug: /operations/quotas
title: 'Квоты'
---

Квоты позволяют вам ограничить использование ресурсов за определенный период времени или отслеживать использование ресурсов. Квоты настраиваются в конфигурации пользователя, которая обычно называется 'users.xml'.

Система также имеет функцию ограничения сложности одного запроса. Смотрите раздел [Ограничения на сложность запроса](../operations/settings/query-complexity.md).

В отличие от ограничений на сложность запросов, квоты:

- Устанавливают ограничения на набор запросов, которые могут выполняться за определенный период времени, вместо ограничения одного запроса.
- Учитывают ресурсы, затраченные на всех удаленных серверах для распределенной обработки запросов.

Давайте рассмотрим раздел файла 'users.xml', который определяет квоты.

```xml
<!-- Квоты -->
<quotas>
    <!-- Имя квоты. -->
    <default>
        <!-- Ограничения для временного интервала. Вы можете установить много интервалов с различными ограничениями. -->
        <interval>
            <!-- Длительность интервала. -->
            <duration>3600</duration>

            <!-- Без ограничений. Просто собирайте данные за указанный временной интервал. -->
            <queries>0</queries>
            <query_selects>0</query_selects>
            <query_inserts>0</query_inserts>
            <errors>0</errors>
            <result_rows>0</result_rows>
            <read_rows>0</read_rows>
            <execution_time>0</execution_time>
        </interval>
    </default>
```

По умолчанию квота отслеживает потребление ресурсов каждый час, не ограничивая использование. Потребление ресурсов, рассчитанное для каждого интервала, выводится в журнал сервера после каждого запроса.

```xml
<statbox>
    <!-- Ограничения для временного интервала. Вы можете установить много интервалов с различными ограничениями. -->
    <interval>
        <!-- Длительность интервала. -->
        <duration>3600</duration>

        <queries>1000</queries>
        <query_selects>100</query_selects>
        <query_inserts>100</query_inserts>
        <errors>100</errors>
        <result_rows>1000000000</result_rows>
        <read_rows>100000000000</read_rows>
        <execution_time>900</execution_time>
    </interval>

    <interval>
        <duration>86400</duration>

        <queries>10000</queries>
        <query_selects>10000</query_selects>
        <query_inserts>10000</query_inserts>
        <errors>1000</errors>
        <result_rows>5000000000</result_rows>
        <read_rows>500000000000</read_rows>
        <execution_time>7200</execution_time>
    </interval>
</statbox>
```

Для квоты 'statbox' ограничения устанавливаются на каждый час и каждые 24 часа (86 400 секунд). Временной интервал подсчитывается, начиная с фиксированного момента времени, определенного реализацией. Другими словами, 24-часовой интервал не обязательно начинается в полночь.

Когда интервал заканчивается, все собранные значения очищаются. На следующий час расчет квоты начинается заново.

Вот варианты, которые могут быть ограничены:

`queries` – Общее количество запросов.

`query_selects` – Общее количество запросов SELECT.

`query_inserts` – Общее количество запросов INSERT.

`errors` – Количество запросов, вызвавших исключение.

`result_rows` – Общее количество строк, выданных в результате.

`read_rows` – Общее количество исходных строк, прочитанных из таблиц для выполнения запроса на всех удаленных серверах.

`execution_time` – Общее время выполнения запроса, в секундах (wall time).

Если лимит превышен хотя бы для одного временного интервала, выбрасывается исключение с текстом о том, какое ограничение было превышено, для какого интервала и когда начинается новый интервал (когда запросы могут быть отправлены снова).

Квоты могут использовать функцию "quota key" для отчета о ресурсах для нескольких ключей независимо. Вот пример этого:

```xml
<!-- Для глобального дизайнера отчетов. -->
<web_global>
    <!-- keyed – Ключ квоты "key" передается в параметре запроса,
            и квота отслеживается отдельно для каждого значения ключа.
        Например, вы можете передать имя пользователя в качестве ключа,
            чтобы квота считалась отдельно для каждого имени пользователя.
        Использование ключей имеет смысл только в том случае, если quota_key передается программой, а не пользователем.

        Вы также можете написать <keyed_by_ip />, чтобы IP-адрес использовался в качестве ключа квоты.
        (Но имейте в виду, что пользователи могут довольно легко изменить адрес IPv6.)
    -->
    <keyed />
```

Квота назначается пользователям в разделе 'users' конфигурации. Смотрите раздел "Права доступа".

Для распределенной обработки запросов накопленные суммы хранятся на сервере запросов. Поэтому, если пользователь переходит на другой сервер, квота там "начнется заново".

Когда сервер перезагружается, квоты сбрасываются.
