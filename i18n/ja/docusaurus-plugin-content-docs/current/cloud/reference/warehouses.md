---
title: ウェアハウス
slug: /cloud/reference/warehouses
keywords: [コンピュート分離, クラウド, アーキテクチャ, コンピュート-コンピュート, ウェアハウス, ウェアハウス, ハイドラ]
description: ClickHouse Cloudにおけるコンピュート-コンピュート分離
---

# ウェアハウス

## コンピュート-コンピュート分離とは？ {#what-is-compute-compute-separation}

コンピュート-コンピュート分離は、ScaleおよびEnterpriseティアで利用可能です。

各ClickHouse Cloudサービスには以下が含まれます：
- 2つ以上のClickHouseノード（またはレプリカ）のグループが必要ですが、子サービスは単一レプリカでも構いません。
- サービスに接続するために使用するサービスURL（例えば、`https://dv2fzne24g.us-east-1.aws.clickhouse.cloud:8443`）であるエンドポイント（またはClickHouse Cloud UIコンソールを介して作成された複数のエンドポイント）。
- サービスがすべてのデータおよび部分的なメタデータを格納するオブジェクトストレージフォルダ：

:::note
子の単一サービスは、単一の親サービスとは異なり、垂直にスケールできます。
:::

<br />

<img src={require('./images/compute-compute-1.png').default}
    alt='代替テキストが必要'
    class='image'
    style={{width: '200px'}}
/>

<br />

_Fig. 1 - ClickHouse Cloudの現在のサービス_

コンピュート-コンピュート分離により、ユーザーは同じオブジェクトストレージフォルダを使用する複数のコンピュートノードグループを作成でき、したがって同じテーブルやビューなどを使用できます。

各コンピュートノードグループには独自のエンドポイントがあり、どのレプリカセットをワークロードに使用するかを選択できます。 一部のワークロードは小さなサイズのレプリカ1つで満足できるかもしれませんが、他のワークロードは完全な高可用性（HA）と数百ギガバイトのメモリを必要とするかもしれません。コンピュート-コンピュート分離は、読み取り操作と書き込み操作を分離することも可能にし、両者が干渉しないようにします：

<br />

<img src={require('./images/compute-compute-2.png').default}
    alt='代替テキストが必要'
    class='image'
    style={{width: '500px'}}
/>

<br />

_Fig. 2 - ClickHouse Cloudのコンピュート_

このプライベートプレビュープログラムでは、既存のサービスと同じデータを共有する追加のサービスを作成したり、同じデータを共有する複数のサービスを持つ完全に新しいセットアップを作成したりする能力があります。

## ウェアハウスとは？ {#what-is-a-warehouse}

ClickHouse Cloudにおいて、_ウェアハウス_は同じデータを共有するサービスのセットです。
各ウェアハウスにはプライマリサービス（このサービスは最初に作成されました）とセカンダリサービスがあります。例えば、以下のスクリーンショットには、「DWH Prod」というウェアハウスがあり、2つのサービスが示されています：

- プライマリサービス `DWH Prod`
- セカンダリサービス `DWH Prod Subservice`

<br />

<img src={require('./images/compute-compute-8.png').default}
    alt='代替テキストが必要'
    class='image'
    style={{width: '800px'}}
/>

<br />

_Fig. 3 - ウェアハウスの例_

ウェアハウス内のすべてのサービスは同じものを共有します：

- リージョン（例えば、us-east1）
- クラウドサービスプロバイダー（AWS、GCP、Azureなど）
- ClickHouseデータベースバージョン

サービスは、その所属するウェアハウスによってソートできます。

## アクセス制御 {#access-controls}

### データベース資格情報 {#database-credentials}

ウェアハウス内のすべてが同じテーブルセットを共有しているため、他のサービスへのアクセス制御も共有されています。つまり、サービス1で作成されたすべてのデータベースユーザーは、同じ権限（テーブル、ビューなどの権限）でサービス2を使用でき、逆も同様です。ユーザーは各サービスのために別のエンドポイントを使用しますが、同じユーザー名とパスワードを使用します。言い換えれば、_ユーザーは同じストレージで作業するサービス間で共有されています：_

<br />

<img src={require('./images/compute-compute-3.png').default}
    alt='代替テキストが必要'
    class='image'
    style={{width: '500px'}}
/>

<br />

_Fig. 4 - ユーザーAliceはサービス1で作成されましたが、同じ資格情報を使用してデータを共有するすべてのサービスにアクセスできます_

### ネットワークアクセス制御 {#network-access-control}

特定のサービスが他のアプリケーションやアドホックユーザーによって使用されるのを制限することが有用な場合があります。これは、現在の通常のサービス用に設定されているように、ネットワーク制限を使用することで行うことができます（ClickHouse Cloudコンソールの特定のサービスのサービスタブの**設定**に移動）。

各サービスにIPフィルタリング設定を個別に適用でき、どのアプリケーションがどのサービスにアクセスできるかを制御できます。これにより、特定のサービスを使用するユーザーを制限できます：

<br />

<img src={require('./images/compute-compute-4.png').default}
    alt='代替テキストが必要'
    class='image'
    style={{width: '400px'}}
/>

<br />

_Fig. 5 - アリスはネットワーク設定によりサービス2へのアクセスが制限されています_

### 読み取り vs 読み書き {#read-vs-read-write}

時には、特定のサービスへの書き込みアクセスを制限し、ウェアハウス内のサービスのサブセットのみが書き込み可能にすることが有用な場合があります。これは第二またはn番目のサービスを作成する際に行えます（最初のサービスは常に読み書き可能である必要があります）：

<br />

<img src={require('./images/compute-compute-5.png').default}
    alt='代替テキストが必要'
    class='image'
    style={{width: '400px'}}
/>

<br />

_Fig. 6 - ウェアハウス内の読み書きおよび読み取り専用サービス_

:::note
現在、読み取り専用サービスはユーザー管理操作（作成、削除など）を許可しています。この動作は将来的に変更される可能性があります。
:::


## スケーリング {#scaling}

ウェアハウス内の各サービスは、次の点でワークロードに応じて調整できます：
- ノード数（レプリカ）。プライマリサービス（ウェアハウスで最初に作成されたサービス）には2つ以上のノードを持つ必要があります。各セカンダリサービスは1つ以上のノードを持つことができます。
- ノードのサイズ（レプリカ）
- サービスが自動的にスケールすべきか
- サービスが非アクティブ時にアイドルするべきか（グループ内の最初のサービスには適用できません - **制限事項** セクションを参照してください）

## 動作の変更 {#changes-in-behavior}
コンピュート-コンピュートがサービスに対して有効化されると（少なくとも1つのセカンダリサービスが作成された場合）、`clusterAllReplicas()`関数呼び出しに`default`クラスタ名を指定すると、その呼び出しが行われたサービスのレプリカのみが使用されます。つまり、同じデータセットに接続されている2つのサービスがあり、サービス1から`clusterAllReplicas(default, system, processes)`が呼ばれると、サービス1で実行されているプロセスのみが表示されます。必要に応じて、例えば`clusterAllReplicas('all_groups.default', system, processes)`を呼び出すことで、すべてのレプリカにアクセスできます。

## 制限事項 {#limitations}

このコンピュート-コンピュート分離は現在プライベートプレビュー中であるため、この機能の利用にはいくつかの制限があります。ほとんどの制限は、この機能がGA（一般提供）に移行すると削除されます：

1. **プライマリサービスは常に稼働している必要があり、アイドル状態にしてはいけません（この制限はGAの少し後に削除されます）。** プライベートプレビュー中およびGAの後もしばらくの間、プライマリサービス（通常は他のサービスを追加して拡張したい既存のサービス）は常に稼働しており、アイドル設定は無効となります。少なくとも1つのセカンダリサービスがある場合、プライマリサービスを停止またはアイドルすることはできません。すべてのセカンダリサービスが削除されると、元のサービスを再度停止またはアイドルすることができます。

2. **時にはワークロードを分離できない場合があります。** データベースワークロードを互いに分離するオプションを提供することが目標ですが、1つのサービスのワークロードが同じデータを共有している別のサービスに影響を与えることになる隅々のケースがあります。これらは主にOLTPのようなワークロードに関連する非常に稀な状況です。

3. **すべての読み書きサービスはバックグラウンドマージ操作を行っています。** ClickHouseにデータを挿入する際、まずデータは一時的パーティションに挿入され、その後バックグラウンドでマージが行われます。これらのマージはメモリとCPUリソースを消費することがあります。同じストレージを共有する2つの読み書きサービスがバックグラウンド操作を実行しているため、サービス1に`INSERT`クエリがある場合、マージ操作はサービス2によって完了することがあります。読み取り専用サービスはバックグラウンドマージを実行しないため、この操作にリソースを消費しません。

4. **1つの読み書きサービスへの挿入が、もう1つの読み書きサービスがアイドル状態になるのを妨げる可能性があります（アイドルが有効な場合）。** 前述の点により、2番目のサービスは最初のサービスに対するバックグラウンドマージ操作を実行します。これらのバックグラウンド操作が原因で、2番目のサービスがアイドル状態になれない場合があります。バックグラウンド操作が終了すると、サービスはアイドル状態になります。読み取り専用サービスには影響せず、遅延なくアイドル状態になります。

5. **CREATE/RENAME/DROP DATABASEクエリは、アイドルまたは停止したサービスによってデフォルトでブロックされる可能性があります。** これらのクエリはハングする可能性があります。これを回避するには、セッションまたはクエリレベルで`settings distributed_ddl_task_timeout=0`を使用してデータベース管理クエリを実行できます。例えば：

```sql
create database db_test_ddl_single_query_setting
settings distributed_ddl_task_timeout=0
```

6. **非常に稀な場合、長期間（数日間）アイドルまたは停止されているセカンダリサービスが同じウェアハウス内の他のサービスにパフォーマンス低下を引き起こす可能性があります。** この問題はすぐに解決される予定で、バックグラウンドで実行されるミューテーションに関連しています。この問題が発生していると思われる場合は、ClickHouse [サポート](https://clickhouse.com/support/program)にお問い合わせください。

## 価格 {#pricing}

プライベートプレビュー中に作成された追加サービスは、通常通り課金されます。コンピュート料金はウェアハウス内のすべてのサービス（プライマリおよびセカンダリ）で同じです。ストレージは一次（元の）サービスにのみ一度課金されます。

## バックアップ {#backups}

- 単一のウェアハウス内のすべてのサービスは同じストレージを共有するため、バックアップはプライマリ（初期）サービスでのみ行われます。これにより、ウェアハウス内のすべてのサービスのデータがバックアップされます。
- ウェアハウスのプライマリサービスからバックアップを復元すると、それは既存のウェアハウスに接続されていないまったく新しいサービスに復元されます。復元が完了した後、すぐに新しいサービスに追加のサービスを追加することができます。

## ウェアハウスの利用 {#using-warehouses}

### ウェアハウスの作成 {#creating-a-warehouse}

ウェアハウスを作成するには、既存のサービスとデータを共有する第二のサービスを作成する必要があります。これは、既存のサービスのいずれかのプラス記号をクリックすることで行えます：

<br />

<img src={require('./images/compute-compute-7.png').default}
    alt='代替テキストが必要'
    class='image'
    style={{width: '800px'}}
/>

<br />

_Fig. 7 - ウェアハウス内に新しいサービスを作成するにはプラス記号をクリックします_

サービス作成画面では、元のサービスが新しいサービスのデータのソースとして選択されます。作成後、これらの2つのサービスはウェアハウスを形成します。

### ウェアハウスの名前変更 {#renaming-a-warehouse}

ウェアハウスの名前を変更する方法は2つあります：

- サービスページの右上隅で「ウェアハウスでソート」を選択し、次にウェアハウス名の近くの鉛筆アイコンをクリックします。
- サービスのいずれかでウェアハウス名をクリックし、そこでウェアハウスの名前を変更します。

### ウェアハウスの削除 {#deleting-a-warehouse}

ウェアハウスの削除は、すべてのコンピュートサービスとデータ（テーブル、ビュー、ユーザーなど）を削除することを意味します。このアクションは元に戻せません。
ウェアハウスを削除するには、最初に作成したサービスを削除する必要があります。これを行うには：

1. 最初に作成されたサービスに追加して作成されたすべてのサービスを削除します。
2. 最初のサービスを削除します（警告：このステップでウェアハウスのすべてのデータが削除されます）。
