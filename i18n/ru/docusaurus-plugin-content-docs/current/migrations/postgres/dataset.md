---
slug: /migrations/postgresql/dataset
title: 'Загрузка данных из PostgreSQL в ClickHouse'
description: 'Пример набора данных для миграции из PostgreSQL в ClickHouse'
keywords: ['postgres', 'postgresql', 'migrate', 'migration']
---

import postgres_stackoverflow_schema from '@site/static/images/migrations/postgres-stackoverflow-schema.png';
import Image from '@theme/IdealImage';

> Это **Часть 1** руководства по миграции из PostgreSQL в ClickHouse. Этот контент можно считать вводным, с целью помочь пользователям развернуть первоначальную функциональную систему, соответствующую лучшим практикам ClickHouse. Он избегает сложных тем и не приводит к полностью оптимизированной схеме; скорее, он предоставляет надежную основу для пользователей, чтобы построить производственную систему и углубить свои знания.

## Набор данных {#dataset}

В качестве примера набора данных для демонстрации типичной миграции из Postgres в ClickHouse мы используем набор данных Stack Overflow, задокументированный [здесь](/getting-started/example-datasets/stackoverflow). Этот набор данных содержит все `post`, `vote`, `user`, `comment` и `badge`, которые имели место на Stack Overflow с 2008 года по апрель 2024 года. Схема PostgreSQL для этих данных показана ниже:

<Image img={postgres_stackoverflow_schema} size="lg" alt="Схема PostgreSQL Stack Overflow"/>

*Команды DDL для создания таблиц в PostgreSQL доступны [здесь](https://pastila.nl/?001c0102/eef2d1e4c82aab78c4670346acb74d83#TeGvJWX9WTA1V/5dVVZQjg==).*

Эта схема, хотя и не обязательно самая оптимальная, использует ряд популярных функций PostgreSQL, включая первичные ключи, внешние ключи, партиционирование и индексы.

Мы мигрируем каждую из этих концепций на их эквиваленты в ClickHouse.

Для пользователей, которые хотят заполнить этот набор данных в экземпляре PostgreSQL для тестирования этапов миграции, мы предоставили данные в формате `pg_dump` для загрузки с DDL, и последующие команды загрузки данных показаны ниже:

```bash

# users
wget https://datasets-documentation.s3.eu-west-3.amazonaws.com/stackoverflow/pdump/2024/users.sql.gz
gzip -d users.sql.gz
psql < users.sql


# posts
wget https://datasets-documentation.s3.eu-west-3.amazonaws.com/stackoverflow/pdump/2024/posts.sql.gz
gzip -d posts.sql.gz
psql < posts.sql


# posthistory
wget https://datasets-documentation.s3.eu-west-3.amazonaws.com/stackoverflow/pdump/2024/posthistory.sql.gz
gzip -d posthistory.sql.gz
psql < posthistory.sql


# comments
wget https://datasets-documentation.s3.eu-west-3.amazonaws.com/stackoverflow/pdump/2024/comments.sql.gz
gzip -d comments.sql.gz
psql < comments.sql


# votes
wget https://datasets-documentation.s3.eu-west-3.amazonaws.com/stackoverflow/pdump/2024/votes.sql.gz
gzip -d votes.sql.gz
psql < votes.sql


# badges
wget https://datasets-documentation.s3.eu-west-3.amazonaws.com/stackoverflow/pdump/2024/badges.sql.gz
gzip -d badges.sql.gz
psql < badges.sql


# postlinks
wget https://datasets-documentation.s3.eu-west-3.amazonaws.com/stackoverflow/pdump/2024/postlinks.sql.gz
gzip -d postlinks.sql.gz
psql < postlinks.sql
```

Хотя этот набор данных мал для ClickHouse, он значителен для Postgres. В приведенном выше примере представлена подмножество, охватывающее первые три месяца 2024 года.

> Хотя наши примеры результатов используют полный набор данных для демонстрации различий в производительности между Postgres и ClickHouse, все шаги, документированные ниже, функционально идентичны с меньшим подмножеством. Пользователи, желающие загрузить полный набор данных в Postgres, могут ознакомиться [здесь](https://pastila.nl/?00d47a08/1c5224c0b61beb480539f15ac375619d#XNj5vX3a7ZjkdiX7In8wqA==). Из-за внешних ограничений, наложенных вышеупомянутой схемой, полный набор данных для PostgreSQL содержит только те строки, которые соответствуют ссылочной целостности. Версию [Parquet](/getting-started/example-datasets/stackoverflow) без таких ограничений можно легко загрузить напрямую в ClickHouse при необходимости.

## Миграция данных {#migrating-data}

Миграция данных между ClickHouse и Postgres делится на два основных типа рабочих нагрузок:

- **Первичная массовая загрузка с периодическими обновлениями** - Необходимость мигрировать первоначальный набор данных вместе с периодическими обновлениями через заданные интервалы, например, ежедневно. Обновления здесь обрабатываются путем повторной отправки изменившихся строк - идентифицируемых либо по столбцу, который можно использовать для сравнения (например, по дате), либо по значению `XMIN`. Удаления обрабатываются с полным периодическим перезагрузкой набора данных.
- **Репликация в реальном времени или CDC** - Необходимость мигрировать первоначальный набор данных. Изменения в этом наборе данных должны отражаться в ClickHouse почти в реальном времени с задержкой всего несколько секунд. Это фактически процесс захвата изменений данных (CDC), при котором таблицы в Postgres должны быть синхронизированы с ClickHouse, то есть вставки, обновления и удаления в таблице Postgres должны применяться к эквивалентной таблице в ClickHouse.

### Первичная массовая загрузка с периодическими обновлениями {#initial-bulk-load-with-periodic-updates}

Эта рабочая нагрузка представляет собой более простую из вышеуказанных нагрузок, поскольку изменения могут применяться периодически. Первоначальная массовая загрузка набора данных может быть достигнута с помощью:

- **Табличные функции** - Используя [табличную функцию Postgres](/sql-reference/table-functions/postgresql) в ClickHouse для `SELECT` данных из Postgres и `INSERT` их в таблицу ClickHouse. Это актуально для массовых загрузок до наборов данных в несколько сотен гигабайт.
- **Экспорты** - Экспортируя в промежуточные форматы, такие как CSV или SQL-скрипты. Эти файлы затем могут быть загружены в ClickHouse либо клиентом через оператор `INSERT FROM INFILE`, либо с использованием объектного хранилища и их связанных функций, т.е. s3, gcs.

Инкрементальные загрузки, в свою очередь, могут быть расписаны. Если таблица Postgres только получает вставки, и существует инкрементный идентификатор или временная метка, пользователи могут использовать вышеупомянутый подход с таблицами для загрузки инкрементов, т.е. оператор `WHERE` может быть применен к `SELECT`. Этот подход также может быть использован для поддержки обновлений, если они гарантированно обновляют тот же столбец. Однако поддержка удалений потребует полной перезагрузки, что может быть трудно осуществить по мере роста таблицы.

Мы демонстрируем первоначальную загрузку и инкрементальную загрузку, используя `CreationDate` (предполагаем, что он обновляется при изменении строк).

```sql
-- первоначальная загрузка
INSERT INTO stackoverflow.posts SELECT * FROM postgresql('<host>', 'postgres', 'posts', 'postgres', '<password')

INSERT INTO stackoverflow.posts SELECT * FROM postgresql('<host>', 'postgres', 'posts', 'postgres', '<password') WHERE CreationDate > ( SELECT (max(CreationDate) FROM stackoverflow.posts)
```

> ClickHouse будет пропускать простые операторы `WHERE`, такие как `=`, `!=`, `>`, `>=`, `<`, `<=` и IN, на сервер PostgreSQL. Таким образом, инкрементальные загрузки могут быть более эффективными, если существует индекс на столбцах, используемых для определения набора изменений.

> Возможный метод определения операций UPDATE при использовании репликации запросов заключается в использовании [`XMIN` системного столбца](https://www.postgresql.org/docs/9.1/ddl-system-columns.html) (идентификаторы транзакций) в качестве водяного знака - изменение этого столбца указывает на изменение и, следовательно, может быть применено к целевой таблице. Пользователи, использующие этот подход, должны быть осведомлены о том, что значения `XMIN` могут циклически переполняться, и для сравнения требуется полное сканирование таблицы, что делает отслеживание изменений более сложным. Дополнительные сведения об этом подходе см. в разделе "Захват изменений данных (CDC)".

### Репликация в реальном времени или CDC {#real-time-replication-or-cdc}

Захват изменений данных (CDC) - это процесс, при котором таблицы синхронизируются между двумя базами данных. Это значительно более сложно, если обновления и удаления должны обрабатываться почти в реальном времени. В настоящее время существует несколько решений:
1. **PeerDB от ClickHouse** - PeerDB предлагает открытое решение для специализированного CDC PostgreSQL, которое пользователи могут выполнять самостоятельно или через SaaS-решение, которое показало хорошую эффективность в масштабе с Postgres и ClickHouse. Решение сосредоточено на низкоуровневых оптимизациях для достижения высокой производительности передачи данных и гарантии надежности между Postgres и ClickHouse. Оно поддерживает как онлайн, так и офлайн загрузки.

:::info
PeerDB теперь доступен нативно в ClickHouse Cloud - Сверхбыстрый CDC из Postgres в ClickHouse с нашим [новым коннектором ClickPipe](/integrations/clickpipes/postgres) - сейчас в публичной бета-версии.
:::

2. **Постройте свое собственное** - Это можно достичь с помощью **Debezium + Kafka** - Debezium предлагает возможность захвата всех изменений в таблице Postgres, перенаправляя их как события в очередь Kafka. Эти события могут быть затем использованы либо коннектором Kafka ClickHouse, либо [ClickPipes в ClickHouse Cloud](https://clickhouse.com/cloud/clickpipes) для вставки в ClickHouse. Это представляет собой Захват изменений данных (CDC), так как Debezium будет не только выполнять первоначальную копию таблиц, но также обеспечивать обнаружение всех последующих обновлений, удалений и вставок в Postgres, что приведет к получению событий на выходе. Это требует тщательной настройки как Postgres, так и Debezium, а также ClickHouse. Примеры можно найти [здесь](https://clickhouse.com/blog/clickhouse-postgresql-change-data-capture-cdc-part-2).

Для примеров в этом руководстве мы предполагаем только первоначальную массовую загрузку, сосредоточив внимание на исследовании данных и легкой итерации к производственным схемам, подходящим для других подходов.

[Нажмите здесь, чтобы перейти к Часть 2](/migrations/postgresql/designing-schemas).
