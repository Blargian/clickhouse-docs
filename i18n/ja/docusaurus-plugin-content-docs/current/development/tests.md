---
slug: /development/tests
sidebar_position: 40
sidebar_label: テスト
---

# テスト

## 機能テスト {#functional-tests}

機能テストは最もシンプルで便利なテストです。  
ClickHouseのほとんどの機能は機能テストでテスト可能であり、この方法でテストできるClickHouseのコードに対するすべての変更に対して使用することが必須です。

各機能テストは、実行中のClickHouseサーバーに1つまたは複数の**クエリ**を送信し、結果を参照と比較します。

テストは`queries`ディレクトリにあります。  
2つのサブディレクトリがあります：`stateless`と`stateful`。
- Statelessテストは、事前にロードされたテストデータを使用せずにクエリを実行します。テスト自体内で小さな合成データセットをその場で作成することがよくあります。
- StatefulテストはClickHouseから事前にロードされたテストデータを必要とし、これも一般公開されています。

各テストは、`.sql`または`.sh`のいずれかのタイプであることができます。
- `.sql`テストは、`clickhouse-client`にパイプされたシンプルなSQLスクリプトです。
- `.sh`テストは、自身で実行されるスクリプトです。

一般的に、SQLテストは`.sh`テストよりも好まれます。  
純粋なSQLからテストできない機能（たとえば、入力データを`clickhouse-client`にパイプする、または`clickhouse-local`をテストするなど）がある場合にのみ`.sh`テストを使用すべきです。

:::note
`DateTime`および`DateTime64`データ型をテストする際の一般的な間違いは、サーバーが特定のタイムゾーン（例： "UTC"）を使用していると仮定することです。これは正しくありません。CIテスト実行時のタイムゾーンは意図的にランダム化されています。テスト値にタイムゾーンを明示的に指定する最も簡単な回避策は、例として`toDateTime64(val, 3, 'Europe/Amsterdam')`を使用することです。
:::

### ローカルでのテストの実行 {#running-a-test-locally}

ClickHouseサーバーをローカルで起動し、デフォルトポート（9000）でリスニングします。  
例えば、テスト`01428_hash_set_nan_key`を実行するには、リポジトリフォルダに移動し、次のコマンドを実行します。

```sh
PATH=<path to clickhouse-client>:$PATH tests/clickhouse-test 01428_hash_set_nan_key
```

テスト結果（`stderr`および`stdout`）は、テスト自体の隣にあるファイル`01428_hash_set_nan_key.[stderr|stdout]`に書き込まれます（`queries/0_stateless/foo.sql`の場合、出力は`queries/0_stateless/foo.stdout`にあります）。

すべての`clickhouse-test`オプションについては、`tests/clickhouse-test --help`を参照してください。  
すべてのテストを実行するか、テスト名のフィルタを提供してテストのサブセットを実行できます: `./clickhouse-test substring`。  
テストを並行して実行したりランダムな順序で実行するオプションもあります。

### 新しいテストの追加 {#adding-a-new-test}

新しいテストを追加するには、まず`queries/0_stateless`ディレクトリに`.sql`または`.sh`ファイルを作成します。  
次に、`clickhouse-client < 12345_test.sql > 12345_test.reference`または`./12345_test.sh > ./12345_test.reference`を使用して対応する`.reference`ファイルを生成します。

テストは、すべて`test`データベース内でテーブルを作成、削除、選択するなどを行うべきであり、これは事前に自動的に作成されます。  
一時テーブルを使用することは問題ありません。

CIと同様の環境をローカルでセットアップするには、テスト構成をインストールします（Zookeeperのモック実装を使用し、いくつかの設定を調整します）。

```sh
cd <repository>/tests/config
sudo ./install.sh
```

:::note
テストは以下の条件を満たすべきです。
- 最小限であること：必要最低限のテーブル、カラム、複雑さのみを作成すること。
- 高速であること：数秒（より良いのはサブ秒）以上かからないこと。
- 正確で決定論的であること：テスト対象の機能が動作していない場合にのみ失敗すること。
- 孤立している/状態がないこと：環境やタイミングに依存しないこと。
- 網羅的であること：ゼロ、ヌル、空のセット、例外（ネガティブテスト、`-- { serverError xyz }`および`-- { clientError xyz }`という構文を使用）などのコーナーケースをカバーすること。
- テストの最後にテーブルをクリーンアップすること（残りがある場合）。
- 他のテストが同じ内容をテストしていないことを確認すること（つまり、最初に`grep`を実行する）。
:::

### テスト実行の制限 {#restricting-test-runs}

テストはゼロまたはより多くの**タグ**を持ち、CI内でテストが実行されるコンテキストを指定します。

`.sql`テストの場合、タグはSQLコメントとして最初の行に配置されます：

```sql
-- タグ: no-fasttest, no-replicated-database
-- no-fasttest: <provide_a_reason_for_the_tag_here>
-- no-replicated-database: <provide_a_reason_here>

SELECT 1
```

`.sh`テストの場合、タグは2行目のコメントとして書かれます：

```bash
#!/usr/bin/env bash
# タグ: no-fasttest, no-replicated-database
# - no-fasttest: <provide_a_reason_for_the_tag_here>
# - no-replicated-database: <provide_a_reason_here>
```

使用可能なタグのリスト：

| タグ名 | 機能 | 使用例 |
|---|---|---|
| `disabled` | テストは実行されません。 | |
| `long` | テストの実行時間が1〜10分に延長されます。 | |
| `deadlock` | テストは長時間ループで実行されます。 | |
| `race` | `deadlock`と同じです。`deadlock`を使用した方が良いです。 | |
| `shard` | サーバーが`127.0.0.*`をリスニングしている必要があります。 | |
| `distributed` | `shard`と同じです。`shard`を使用した方が良いです。 | |
| `global` | `shard`と同じです。`shard`を使用した方が良いです。 | |
| `zookeeper` | テストが実行するためにZookeeperまたはClickHouse Keeperを必要とします。 | テストは`ReplicatedMergeTree`を使用します。 |
| `replica` | `zookeeper`と同じです。`zookeeper`を使用した方が良いです。 | |
| `no-fasttest` | [Fast test](continuous-integration.md#fast-test) 下ではテストが実行されません。 | テストはFast testで無効化されているMySQLテーブルエンジンを使用します。 |
| `no-[asan, tsan, msan, ubsan]` | [サニタイザー](#sanitizers)があるビルド内でのテストを無効にします。 | テストはQEMUで実行され、サニタイザーでは動作しません。 |
| `no-replicated-database` | | |
| `no-ordinary-database` | | |
| `no-parallel` | このテストと並行して他のテストの実行を無効にします。 | テストは`system`テーブルから読み取り、変動が生じる可能性があります。 |
| `no-parallel-replicas` | | |
| `no-debug` | | |
| `no-stress` | | |
| `no-polymorphic-parts` | | |
| `no-random-settings` | | |
| `no-random-merge-tree-settings` | | |
| `no-backward-compatibility-check` | | |
| `no-cpu-x86_64` | | |
| `no-cpu-aarch64` | | |
| `no-cpu-ppc64le` | | |
| `no-s3-storage` | | |

上記の設定に加えて、特定のClickHouse機能の使用を定義するために`system.build_options`から`USE_*`フラグを使用できます。  
たとえば、テストでMySQLテーブルを使用する場合は、`use-mysql`タグを追加する必要があります。

### ランダム設定の制限を指定 {#specifying-limits-for-random-settings}

テストは、テスト実行中にランダム化可能な設定の最小および最大許容値を指定できます。

`.sh`テストの場合、制限はタグに次ぐ行またはタグが指定されていない場合の2行目のコメントとして書かれます：

```bash
#!/usr/bin/env bash
# タグ: no-fasttest
# ランダム設定の制限: max_block_size=(1000, 10000); index_granularity=(100, None)
```

`.sql`テストの場合、タグはタグの隣の行または最初の行にSQLコメントとして配置されます：

```sql
-- タグ: no-fasttest
-- ランダム設定の制限: max_block_size=(1000, 10000); index_granularity=(100, None)
SELECT 1
```

1つの制限だけを指定する必要がある場合は、もう1つには`None`を使用できます。

### テスト名の選択 {#choosing-the-test-name}

テストの名前は5桁のプレフィックスで始まり、それに続いて説明的な名前が続きます。たとえば`00422_hash_function_constexpr.sql`のようにです。  
プレフィックスを選択するには、ディレクトリ内にすでに存在する最大のプレフィックスを見つけ、それを1つ大きくします。

```sh
ls tests/queries/0_stateless/[0-9]*.reference | tail -n 1
```

その間に、同じ数字のプレフィックスを持つ他のテストが追加される可能性がありますが、これは問題ありませんので、後で変更する必要はありません。

### 発生するべきエラーのチェック {#checking-for-an-error-that-must-occur}

時々、誤ったクエリに対してサーバーエラーが発生することをテストしたい場合があります。これをSQLテストでサポートするために特別な注釈形式があります：

```sql
select x; -- { serverError 49 }
```

このテストは、サーバーが未知のカラム`x`に関してエラーコード49を返すことを保証します。  
エラーがない場合やエラーが異なる場合、テストは失敗します。  
クライアント側でエラーが発生することを確認したい場合は、代わりに`clientError`注釈を使用します。

エラーメッセージの特定の文言をチェックしないでください。エラーメッセージは今後変更される可能性があり、そのためにテストが無駄に失敗することになります。  
エラーコードのみをチェックしてください。既存のエラーコードが必要に対して正確でない場合は、新しいエラーコードを追加することを検討してください。

### 分散クエリのテスト {#testing-a-distributed-query}

機能テストで分散クエリを使用したい場合は、`remote`テーブル関数を利用し、サーバー自身をクエリするために`127.0.0.{1..2}`アドレスを使用できます。または、サーバー設定ファイル内で`test_shard_localhost`のようなあらかじめ定義されたテストクラスターを使用できます。  
テスト名に`shard`または`distributed`の単語を追加して、CI内で正しい設定で実行されるようにすることを忘れないでください。サーバーが分散クエリをサポートするように設定されている場所です。

### 一時ファイルの取り扱い {#working-with-temporary-files}

シェルテストで作業するために一時ファイルをその場で作成する必要がある場合があります。  
ただし、一部のCIチェックがテストを並行して実行するため、一時ファイルを一意の名前なしに作成したり削除したりすると、FlakyなどのCIチェックに失敗を引き起こす可能性があります。  
これを回避するために、環境変数`$CLICKHOUSE_TEST_UNIQUE_NAME`を使用して、一時ファイルに実行中のテストに固有の名前を付ける必要があります。  
そうすることで、セットアップ中に作成されるファイルやクリーンアップ中に削除されるファイルは、そのテストだけに使用されるファイルであり、並行して実行されている他のテストのファイルではないことを確認できます。

## 既知のバグ {#known-bugs}

機能テストで簡単に再現できるバグがある場合、準備された機能テストを`tests/queries/bugs`ディレクトリに配置します。  
これらのテストはバグが修正されたときに`tests/queries/0_stateless`に移動されます。

## 統合テスト {#integration-tests}

統合テストでは、クラスター構成でのClickHouseおよびClickHouseとMySQL、Postgres、MongoDBなどの他のサーバーとの相互作用をテストできます。  
これらはネットワーク分割、パケットドロップなどを模擬するのに役立ちます。  
これらのテストはDockerの下で実行され、さまざまなソフトウェアを持つ複数のコンテナを作成します。

テストを実行する方法については、`tests/integration/README.md`を参照してください。

ClickHouseとサードパーティのドライバーの統合はテストされていないことに注意してください。  
また、現在、JDBCおよびODBCドライバーとの統合テストもありません。

## 単体テスト {#unit-tests}

単体テストは、ClickHouse全体ではなく、単一の孤立したライブラリやクラスをテストしたいときに有用です。  
単体テストのビルドを有効または無効にするには、`ENABLE_TESTS` CMakeオプションを使用します。  
単体テスト（および他のテストプログラム）は、コード全体の`tests`サブディレクトリにあります。  
単体テストを実行するには、`ninja test`と入力します。  
一部のテストは`gtest`を使用しますが、いくつかは単にテスト失敗時に非ゼロの終了コードを返すプログラムです。

すでに機能テストによってカバレッジが提供されている場合（機能テストは通常は使用がはるかに簡単です）、単体テストは必ずしも必要ではありません。

個々のgtestチェックは、実行可能ファイルを直接呼び出すことで実行できます。例えば：

```bash
$ ./src/unit_tests_dbms --gtest_filter=LocalAddress*
```

## パフォーマンステスト {#performance-tests}

パフォーマンステストでは、合成クエリに対するClickHouseの特定の孤立した部分のパフォーマンスを測定および比較できます。  
パフォーマンステストは`tests/performance/`にあります。  
各テストはテストケースの説明を含む`.xml`ファイルで表現されます。  
テストは`docker/test/performance-comparison`ツールを使用して実行されます。  
実行方法については、readmeファイルを参照してください。

各テストは、ループ内で1つまたは複数のクエリ（パラメーターの組み合わせを含む可能性あり）を実行します。

特定のシナリオでClickHouseのパフォーマンスを改善したい場合、改善が単純なクエリで観察できる場合は、パフォーマンステストを書くことを強く推奨します。また、比較的孤立していてあまり特異でないSQL関数を追加または修正する場合にもパフォーマンステストを書くことをお勧めします。  
テスト中は、`perf top`やその他の`perf`ツールを使用することは常に意味があります。

## テストツールとスクリプト {#test-tools-and-scripts}

`tests`ディレクトリ内の一部のプログラムは準備されたテストではありませんが、テストツールです。  
たとえば、`Lexer`には、標準入力のトークン化を行い、色付けされた結果を標準出力に書き込むツール`src/Parsers/tests/lexer`があります。  
このようなツールをコードの例や探索、手動テストのために使用できます。

## 雑多なテスト {#miscellaneous-tests}

`tests/external_models`には機械学習モデルのテストがあります。  
これらのテストは更新されず、統合テストに移行する必要があります。

クォーラム挿入用の別のテストがあります。  
このテストは、別々のサーバー上でClickHouseクラスターを実行し、様々な障害ケースを模擬します：ネットワーク分割、パケットドロップ（ClickHouseノード間、ClickHouseとZooKeeper間、ClickHouseサーバーとクライアント間など）、`kill -9`、`kill -STOP`および`kill -CONT`、[Jepsen](https://aphyr.com/tags/Jepsen)のようにです。  
その後、すべての確認済みの挿入が書き込まれ、この挿入が拒否されたものでないことをチェックします。

クォーラムテストは、ClickHouseがオープンソース化される前に別のチームによって書かれました。  
このチームはもはやClickHouseに関与していません。  
テストは偶然にもJavaで書かれました。  
これらの理由から、クォーラムテストは書き直され、統合テストに移動する必要があります。

## 手動テスト {#manual-testing}

新しい機能を開発する際は、手動でテストすることが合理的です。  
次の手順でそれを行うことができます：

ClickHouseをビルドします。ターミナルからClickHouseを実行します：`programs/clickhouse-server`にディレクトリを変更し、`./clickhouse-server`で実行します。  
デフォルトで、現在のディレクトリの設定（`config.xml`、`users.xml`および`config.d`および`users.d`ディレクトリ内のファイル）を使用します。  
ClickHouseサーバーに接続するには、`programs/clickhouse-client/clickhouse-client`を実行します。

すべてのClickHouseツール（サーバー、クライアントなど）は、単一のバイナリ`clickhouse`へのシンボリックリンクであることに注意してください。  
このバイナリは`programs/clickhouse`にあります。  
すべてのツールは、`clickhouse tool`として呼び出すこともできます。

代わりにClickHouseパッケージをインストールすることも可能です：ClickHouseリポジトリからの安定版リリース、または自分でパッケージをビルドできます。これは、ClickHouseソースのルートで`./release`を実行することによって行います。  
その後、サーバーを`sudo clickhouse start`（またはサーバーを停止するには`stop`）で起動します。  
ログは`/etc/clickhouse-server/clickhouse-server.log`で確認できます。

ClickHouseがシステムにすでにインストールされている場合、`clickhouse`バイナリを新しくビルドし、既存のバイナリを置き換えることができます：

``` bash
$ sudo clickhouse stop
$ sudo cp ./clickhouse /usr/bin/
$ sudo clickhouse start
```

また、システムのClickHouseサーバーを停止し、同じ設定で独自のサーバーを実行することもできますが、端末にログを出力するようにします：

``` bash
$ sudo clickhouse stop
$ sudo -u clickhouse /usr/bin/clickhouse server --config-file /etc/clickhouse-server/config.xml
```

gdbの使用例：

``` bash
$ sudo -u clickhouse gdb --args /usr/bin/clickhouse server --config-file /etc/clickhouse-server/config.xml
```

システムのClickHouseサーバーがすでに実行中で、停止したくない場合は、`config.xml`のポート番号を変更する（または`config.d`ディレクトリ内のファイルでそれらを上書きする）、適切なデータパスを提供するなどして実行できます。

`clickhouse`バイナリはほぼ依存関係がなく、広範囲のLinuxディストリビューションで動作します。  
サーバー上で変更を迅速かつ簡単にテストするには、新しくビルドした`clickhouse`バイナリをサーバーに`scp`して、前述の例のように実行するだけです。

## ビルドテスト {#build-tests}

ビルドテストは、さまざまな代替構成および一部の外国システムでビルドが壊れていないことを確認します。  
これらのテストも自動化されています。

例：
- Darwin x86_64 (macOS)用のクロスコンパイル
- FreeBSD x86_64用のクロスコンパイル
- Linux AArch64用のクロスコンパイル
- システムパッケージからのライブラリを使用してUbuntuでビルド（推奨されません）
- ライブラリの共有リンクでビルド（推奨されません）

たとえば、システムパッケージでのビルドは悪い慣習です。なぜなら、システムが持つパッケージの正確なバージョンを保証できないからです。  
しかし、Debianのメンテナはこれが本当に必要です。  
このために、少なくともこのビルドバリエーションをサポートする必要があります。  
もう一つの例は、共有リンクが一般的な問題の原因となりますが、一部の熱心な人々には必要です。

すべてのビルドのすべてのテストを実行することはできませんが、少なくともさまざまなビルドバリエーションが壊れていないことを確認したいと考えています。  
そのためにビルドテストを使用します。

ビルドテストは、コンパイルが長すぎる翻訳単位がないことや、RAMを必要以上に消費することがないこともテストします。

スタックフレームが大きすぎないこともテストします。

## プロトコル互換性のテスト {#testing-for-protocol-compatibility}

ClickHouseのネットワークプロトコルを拡張する際には、古い`clickhouse-client`が新しい`clickhouse-server`で動作し、新しい`clickhouse-client`が古い`clickhouse-server`で動作することを手動でテストします（単に対応するパッケージからバイナリを実行することで）。

また、次のケースを自動的に統合テストでテストします：
- 古いバージョンのClickHouseによって書き込まれたデータが新しいバージョンによって正常に読み取れるか。
- クラスター内で異なるClickHouseバージョン間で分散クエリが機能するか。

## コンパイラからの支援 {#help-from-the-compiler}

ClickHouseのメインコード（`dbms`ディレクトリにある）は、`-Wall -Wextra -Werror`を使用してビルドされ、いくつかの追加の警告が有効になっています。  
これらのオプションは、サードパーティのライブラリには有効ではありません。

Clangにはさらに役立つ警告があり、`-Weverything`で探すことができ、デフォルトのビルドに選択することができます。

本番ビルドにはClangが使用されますが、gccビルドもテストします。  
開発には、通常Clangを使用する方が便利です。  
ラップトップのバッテリーを節約するために、デバッグモードで自分のマシン上でビルドすることができますが、コンパイラは`-O3`を使用するとより多くの警告を生成できることに注意してください。これはより良い制御フローと手続き間分析によるものです。  
デバッグモードでClangでビルドする際には、デバッグバージョンの`libc++`が使用され、ランタイムでのエラーをより多く検出できます。

## サニタイザー {#sanitizers}

:::note
ローカルで実行する際にClickHouseサーバーまたはクライアントが起動時にクラッシュする場合、アドレス空間のレイアウトランダム化を無効にする必要がある場合があります：`sudo sysctl kernel.randomize_va_space=0`
:::

### アドレスサニタイザー {#address-sanitizer}

コミット毎にASanの下で機能、統合、ストレス、および単体テストを実行します。

### スレッドサニタイザー {#thread-sanitizer}

コミット毎にTSanの下で機能、統合、ストレス、および単体テストを実行します。

### メモリサニタイザー {#memory-sanitizer}

コミット毎にMSanの下で機能、統合、ストレス、および単体テストを実行します。

### 未定義動作サニタイザー {#undefined-behaviour-sanitizer}

コミット毎にUBSanの下で機能、統合、ストレス、および単体テストを実行します。  
一部のサードパーティライブラリのコードは未定義動作に対してサニタイズされていません。

### Valgrind（Memcheck） {#valgrind-memcheck}

以前は、Valgrindの下で機能テストを一晩中実行していましたが、もう行っていません。  
何時間もかかります。  
現在、`re2`ライブラリには1つの既知の偽陽性があります。詳細は[この記事](https://research.swtch.com/sparse)を参照してください。

## ファジング {#fuzzing}

ClickHouseのファジングは、[libFuzzer](https://llvm.org/docs/LibFuzzer.html)とランダムSQLクエリの両方を使用して実装されています。  
すべてのファジングテストは、サニタイザー（アドレスおよび未定義）を使用して実行されるべきです。

LibFuzzerは、ライブラリコードの孤立したファジングテストに使用されます。  
ファジングテストはテストコードの一部として実装され、"_fuzzer"という名前の後に接尾辞が付けられます。  
ファジングテストの例は`src/Parsers/fuzzers/lexer_fuzzer.cpp`に見られます。  
LibFuzzer専用の設定、辞書、コーパスは`tests/fuzz`に保存されています。  
ユーザー入力を処理するすべての機能に対してファジングテストを書くことを推奨します。

ファジングテストはデフォルトではビルドされません。  
ファジングテストをビルドするには、`-DENABLE_FUZZING=1` と `-DENABLE_TESTS=1`オプションを設定する必要があります。  
ファジングテストをビルドする際には、Jemallocを無効にすることをお勧めします。  
ClickHouseのファジングをGoogle OSS-Fuzzに統合するために使用される設定は`docker/fuzz`にあります。

また、ランダムなSQLクエリを生成し、サーバーがそれらを実行中にクラッシュしないことを確認するためのシンプルなファジングテストも利用しています。  
これは`00746_sql_fuzzy.pl`にあります。このテストは継続的に（夜間およびそれ以降）実行されるべきです。

さらに、膨大な数のコーナーケースを見つけることができる洗練されたASTベースのクエリファジングテストも使用しています。  
これは、クエリAST内のランダムな置換や順序の入れ替えを行います。  
前のテストからASTノードを記憶しておき、後のテストのファジングに使用されます。  
このファジングテストについて詳しくは、[このブログ記事](https://clickhouse.com/blog/fuzzing-click-house)を参照してください。

## ストレスタイプテスト {#stress-test}

ストレスタイプテストはファジングの別のケースです。  
すべての機能テストをパラレルにランダムな順序で1つのサーバーで実行します。  
テストの結果はチェックされません。

以下がチェックされています：
- サーバーがクラッシュしないこと、デバッグまたはサニタイザーのトラップがトリガーされないこと。
- デッドロックがないこと。
- データベース構造が一貫していること。
- テスト後にサーバーが正常に停止して再起動できること（例外なし）。

5つのバリエーション（Debug、ASan、TSan、MSan、UBSan）があります。

## スレッドファジングテスト {#thread-fuzzer}

スレッドファジングテスト（Thread Sanitizerとは混同しないでください）は、スレッドの実行順序をランダム化できる別のタイプのファジングです。  
これにより、さらに特異なケースが見つかる手助けになります。

## セキュリティ監査 {#security-audit}

私たちのセキュリティチームは、セキュリティの観点からClickHouseの機能について基本的な評価を行いました。

## 静的解析ツール {#static-analyzers}

コミットごとに`clang-tidy`を実行します。  
`clang-static-analyzer`チェックも有効にされています。  
`clang-tidy`は一部のスタイルチェックにも使用されます。

`clang-tidy`、`Coverity`、`cppcheck`、`PVS-Studio`、`tscancode`、`CodeQL`を評価しました。  
使用方法に関する指示は`tests/instructions/`ディレクトリにあります。

もし`CLion`をIDEとして使用する場合、標準でいくつかの`clang-tidy`チェックを活用できます。

また、シェルスクリプトの静的解析には`shellcheck`を使用しています。

## 硬化 {#hardening}

デバッグビルドでは、ユーザーレベルの割り当てをASLRするカスタムアロケータを使用しています。

また、割り当て後、読み取り専用であると予想されるメモリ領域を手動で保護します。

デバッグビルドでは、古い（安全でない、スレッドセーフでない）関数が呼び出されないことを保証するlibcのカスタマイズも含めています。

デバッグアサーションが広範囲に使用されています。

デバッグビルドでは、「論理エラー」コードを伴う例外がスローされた場合（バグを示唆する）、プログラムが早期に終了します。  
これにより、リリースビルドでは例外を使用できますが、デバッグビルドではアサーションになります。

デバッグビルドに対してデバッグバージョンのjemallocが使用されます。  
デバッグビルドに対してデバッグバージョンのlibc++が使用されます。

## 実行時整合性チェック {#runtime-integrity-checks}

ディスクに保存されたデータはチェックサムが付与されています。  
MergeTreeテーブル内のデータは、同時に3つの方法でチェックサムが付与されます（圧縮データブロック、非圧縮データブロック、ブロック全体のチェックサム）。  
クライアントとサーバー間、またはサーバー間でネットワークを通じて転送されるデータもチェックサムが付与されます。  
レプリケーションは、レプリカ間でビット同一性のあるデータを保証します。

ハードウェアの不具合（ストレージメディアのビットロット、サーバーのRAMのビット反転、ネットワークコントローラーのRAMのビット反転、ネットワークスイッチのRAMのビット反転、クライアントのRAMのビット反転、ワイヤ上のビット反転）から保護するために必要です。  
ビット反転は一般的であり、ECC RAMやTCPチェックサムが存在していても発生する可能性があります（毎日ペタバイトのデータを処理する数千のサーバーを実行することができれば）。  
[ビデオを参照してください（ロシア語）](https://www.youtube.com/watch?v=ooBAQIe0KlQ)。

ClickHouseはオペレーションエンジニアが不具合のあるハードウェアを見つけるのに役立つ診断を提供します。

\* これは遅くありません。

## コードスタイル {#code-style}

コードスタイルのルールは[こちら](style.md)に記載されています。

一般的なスタイル違反をチェックするために、`utils/check-style`スクリプトを使用できます。

コードの適切なスタイルを強制するには、`clang-format`を使用できます。  
ファイル`.clang-format`はソースのルートにあります。  
これは、主に実際のコードスタイルに対応しています。  
しかし、既存のファイルに`clang-format`を適用することは推奨されません。なぜなら、フォーマットが悪化するからです。  
`clang-format-diff`ツールを使用すると、clangソースリポジトリで見つけることができます。

また、`uncrustify`ツールを試してコードを再フォーマットすることも可能です。  
設定はソースのルートの`uncrustify.cfg`にあります。  
`clang-format`よりもテストが少ないです。

`CLion`には独自のコードフォーマッタがあり、我々のコードスタイルに合わせて調整する必要があります。

コード内のタイプミスを見つけるために`codespell`を使用します。  
これは自動化されています。

## テストカバレッジ {#test-coverage}

テストカバレッジは追跡していますが、機能テストにのみ、ClickHouseサーバーのみに制限されています。  
これは日次で実施されます。

## テストのためのテスト {#tests-for-tests}

フレークテストに対する自動チェックがあります。  
新しいテストを100回（機能テストの場合）または10回（統合テストの場合）実行します。  
1回でも失敗した場合、そのテストはフレークテストと見なされます。

## テストの自動化 {#test-automation}

テストは[GitHub Actions](https://github.com/features/actions)で実行します。

ビルドジョブとテストは、コミットごとにサンドボックスで実行されます。  
生成されたパッケージとテスト結果はGitHubに公開され、直接リンクでダウンロードできます。  
アーティファクトは数ヶ月間ストレージされます。  
GitHubでプルリクエストを送信すると、テスト可能としてタグ付けされ、CIシステムはClickHouseパッケージ（リリース、デバッグ、アドレスサニタイザー付き、など）をあなたのためにビルドします。  

