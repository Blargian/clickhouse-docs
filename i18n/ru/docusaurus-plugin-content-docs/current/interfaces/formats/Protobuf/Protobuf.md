---
alias: []
description: 'Документация для формата Protobuf'
input_format: true
keywords: ['Protobuf']
output_format: true
slug: /interfaces/formats/Protobuf
title: 'Protobuf'
---

import CloudNotSupportedBadge from '@theme/badges/CloudNotSupportedBadge';

<CloudNotSupportedBadge/>

| Вход | Выход | Псевдоним |
|------|-------|-----------|
| ✔    | ✔     |           |

## Описание {#description}

Формат `Protobuf` является форматом [Protocol Buffers](https://protobuf.dev/).

Этот формат требует внешней схемы формата, которая кэшируется между запросами.

ClickHouse поддерживает:
- синтаксисы `proto2` и `proto3`.
- поля `Repeated`/`optional`/`required`.

## Пример использования {#example-usage}

### Основные примеры {#basic-examples}

Примеры использования:

```sql
SELECT * FROM test.table FORMAT Protobuf SETTINGS format_schema = 'schemafile:MessageType'
```

```bash
cat protobuf_messages.bin | clickhouse-client --query "INSERT INTO test.table SETTINGS format_schema='schemafile:MessageType' FORMAT Protobuf"
```

Файл `schemafile.proto` выглядит следующим образом:

```capnp
syntax = "proto3";

message MessageType {
  string name = 1;
  string surname = 2;
  uint32 birthDate = 3;
  repeated string phoneNumbers = 4;
};
```

Для нахождения соответствия между колонками таблицы и полями типа сообщения Protocol Buffers ClickHouse сравнивает их имена.
Это сравнение регистронезависимое, и символы `_` (подчеркивание) и `.` (точка) считаются равными.
Если типы колонки и поля сообщения Protocol Buffers различны, применяется необходимое преобразование.

Поддерживаются вложенные сообщения. Например, для поля `z` в следующем типе сообщения:

```capnp
message MessageType {
  message XType {
    message YType {
      int32 z;
    };
    repeated YType y;
  };
  XType x;
};
```

ClickHouse пытается найти колонку с именем `x.y.z` (или `x_y_z`, или `X.y_Z` и так далее).

Вложенные сообщения подходят для ввода или вывода [вложенных структур данных](/sql-reference/data-types/nested-data-structures/index.md).

Значения по умолчанию, определенные в схеме protobuf, такие как приведенная ниже, не применяются, вместо них используются [умолчания таблицы](/sql-reference/statements/create/table#default_values):

```capnp
syntax = "proto2";

message MessageType {
  optional int32 result_per_page = 3 [default = 10];
}
```

ClickHouse вводит и выводит сообщения protobuf в формате `length-delimited`.
Это означает, что перед каждым сообщением его длина должна быть записана как [целое число переменной длины (varint)](https://developers.google.com/protocol-buffers/docs/encoding#varints).

Смотрите также: [как читать/писать сообщения protobuf с длиной, отделенной от других, на популярных языках](https://cwiki.apache.org/confluence/display/GEODE/Delimiting+Protobuf+Messages).

### Использование автогенерируемой схемы {#using-autogenerated-protobuf-schema}

Если у вас нет внешней схемы Protobuf для ваших данных, вы все равно можете вводить/выводить данные в формате Protobuf с использованием автогенерируемой схемы.

Например:

```sql
SELECT * FROM test.hits format Protobuf SETTINGS format_protobuf_use_autogenerated_schema=1
```

В этом случае ClickHouse автогенерирует схему Protobuf в соответствии со структурой таблицы, используя функцию [`structureToProtobufSchema`](/sql-reference/functions/other-functions.md#structure_to_protobuf_schema).
Затем он будет использовать эту схему для сериализации данных в формате Protobuf.

Вы также можете читать файл Protobuf с автогенерируемой схемой. В этом случае файл должен быть создан с использованием той же схемы:

```bash
$ cat hits.bin | clickhouse-client --query "INSERT INTO test.hits SETTINGS format_protobuf_use_autogenerated_schema=1 FORMAT Protobuf"
```

Параметр [`format_protobuf_use_autogenerated_schema`](/operations/settings/settings-formats.md#format_protobuf_use_autogenerated_schema) по умолчанию включен и применяется, если [`format_schema`](/operations/settings/formats#format_schema) не установлен.

Вы также можете сохранить автогенерируемую схему в файл во время ввода/вывода, используя параметр [`output_format_schema`](/operations/settings/formats#output_format_schema). Например:

```sql
SELECT * FROM test.hits format Protobuf SETTINGS format_protobuf_use_autogenerated_schema=1, output_format_schema='path/to/schema/schema.proto'
```
В этом случае автогенерируемая схема Protobuf будет сохранена в файле `path/to/schema/schema.capnp`.

### Сброс кеша Protobuf {#drop-protobuf-cache}

Чтобы перезагрузить схему Protobuf, загруженную из [`format_schema_path`](/operations/server-configuration-parameters/settings.md/#format_schema_path), используйте оператор [`SYSTEM DROP ... FORMAT CACHE`](/sql-reference/statements/system.md/#system-drop-schema-format).

```sql
SYSTEM DROP FORMAT SCHEMA CACHE FOR Protobuf
```

## Настройки формата {#format-settings}
