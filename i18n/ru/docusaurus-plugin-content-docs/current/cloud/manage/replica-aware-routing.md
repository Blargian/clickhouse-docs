---
title: 'Маршрутизация с учётом реплик'
slug: /manage/replica-aware-routing
description: 'Как использовать маршрутизацию с учётом реплик для увеличения повторного использования кэша'
keywords: ['облако', 'фиксация конечных точек', 'фиксация', 'конечные точки', 'фиксация маршрутизации', 'маршрутизация', 'маршрутизация с учётом реплик']
---


# Маршрутизация с учётом реплик (частный предварительный просмотр)

Маршрутизация с учётом реплик (также известная как закреплённые сессии, фиксация маршрута или привязка сессии) использует [алгоритм балансировки нагрузки ring hash прокси-сервера Envoy](https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/load_balancers#ring-hash). Главной целью маршрутизации с учётом реплик является увеличение вероятности повторного использования кэша. Это не гарантирует изоляцию.

При включении маршрутизации с учётом реплик для сервиса мы разрешаем использование поддомена с подстановочным знаком поверх имени узла сервиса. Для сервиса с именем узла `abcxyz123.us-west-2.aws.clickhouse.cloud` вы можете использовать любое имя узла, которое соответствует шаблону `*.sticky.abcxyz123.us-west-2.aws.clickhouse.cloud`, чтобы зайти на сервис:

|Примеры имён узлов|
|---|
|`aaa.sticky.abcxyz123.us-west-2.aws.clickhouse.cloud`|
|`000.sticky.abcxyz123.us-west-2.aws.clickhouse.cloud`|
|`clickhouse-is-the-best.sticky.abcxyz123.us-west-2.aws.clickhouse.cloud`|

Когда Envoy получает имя узла, соответствующее такому шаблону, он вычисляет хеш маршрутизации на основе имени узла и находит соответствующий сервер ClickHouse на кольце хеширования на основе вычисленного хеша. Предполагая, что изменений в сервисе нет (например, перезапусков сервера, масштабирования и т.п.), Envoy всегда будет выбирать тот же сервер ClickHouse для подключения.

Обратите внимание, что оригинальное имя узла всё равно будет использовать балансировку нагрузки `LEAST_CONNECTION`, который является алгоритмом маршрутизации по умолчанию.

## Ограничения маршрутизации с учётом реплик {#limitations-of-replica-aware-routing}

### Маршрутизация с учётом реплик не гарантирует изоляцию {#replica-aware-routing-does-not-guarantee-isolation}

Любое нарушение сервиса, например, перезапуски серверного контейнера (по любой причине, такой как обновление версии, сбой, вертикальное масштабирование вверх и т.д.), масштабирование сервера «вверх» / «вниз», приведёт к нарушению кольца хеширования маршрутизации. Это приведёт к тому, что соединения с тем же именем узла попадут на другой серверный контейнер.

### Маршрутизация с учётом реплик не работает из коробки с частной связью {#replica-aware-routing-does-not-work-out-of-the-box-with-private-link}

Клиентам необходимо вручную добавить запись DNS, чтобы разрешение имён работало для нового шаблона имён узлов. Это может привести к дисбалансу загрузки сервера, если клиенты используют его некорректно.

## Настройка маршрутизации с учётом реплик {#configuring-replica-aware-routing}

Чтобы включить маршрутизацию с учётом реплик, пожалуйста, свяжитесь с [нашей службой поддержки](https://clickhouse.com/support).
