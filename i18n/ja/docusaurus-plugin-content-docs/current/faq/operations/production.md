---
slug: /faq/operations/production
title: 本番環境で使用するClickHouseのバージョンは？
toc_hidden: true
toc_priority: 10
---
# 本番環境で使用するClickHouseのバージョンは？ {#which-clickhouse-version-to-use-in-production}

まず最初に、この質問がなぜされるのかについて説明します。主に2つの理由があります。

1. ClickHouseは非常に高速なペースで開発されており、通常、年間に10回以上の安定したリリースがあります。これにより、選択肢が広がり、選ぶのが簡単ではありません。
2. 一部のユーザーは、どのバージョンが自分のユースケースに最適かを判断するための時間をかけたくなく、他人のアドバイスに従いたいと考えています。

2つ目の理由はより根本的なものであるため、まずそれに取り組み、次にさまざまなClickHouseのリリースのナビゲートに戻ります。
## どのClickHouseのバージョンを推奨しますか？ {#which-clickhouse-version-do-you-recommend}

コンサルタントを雇ったり、知られている専門家を信頼して本番環境の責任を回避したくなるかもしれません。他の誰かが推奨した特定のClickHouseのバージョンをインストールし、それに問題が発生したら、それはあなたの責任ではなく、他の人の責任です。このような考え方は大きな落とし穴です。外部の人間が、あなたの会社の本番環境で何が起こっているかをあなたよりよく知っていることはありません。

では、どのClickHouseのバージョンにアップグレードすべきかを正しく選ぶにはどうすればよいでしょうか？または、最初のClickHouseのバージョンをどう選ぶべきでしょうか？まず最初に、**現実的なプレプロダクション環境**の設定に投資する必要があります。理想的には、完全に同一のシャドウコピーですが、通常は高価です。

以下は、あまり高いコストをかけずにプレプロダクション環境で合理的な忠実度を得るためのいくつかの重要なポイントです：

- プレプロダクション環境は、本番環境で実行する予定のクエリセットにできるだけ近く実行する必要があります：
    - 固定データで読み取り専用にしないでください。
    - 単にデータをコピーするだけで、典型的なレポートを構築せずに書き込み専用にしないでください。
    - スキーママイグレーションを適用する代わりにクリーンアップしないでください。
- 本番データおよびクエリのサンプルを使用してください。依然として代表的であり、 `SELECT` クエリが適切な結果を返すようなサンプルを選ぶことを試みてください。データが機密で内部方針が生産環境からの持ち出しを許可していない場合は、難読化を使用してください。
- プレプロダクションが本番環境と同様の監視およびアラートソフトウェアによってカバーされていることを確認してください。
- 本番環境が複数のデータセンターや地域にまたがる場合、プレプロダクション環境も同様に設定してください。
- 本番環境がレプリケーション、分散テーブル、およびカスケードマテリアライズドビューなどの複雑な機能を使用している場合、プレプロダクションでも同様に設定されていることを確認してください。
- プレプロダクションで本番と同じ数のサーバーやVMを使用するためのトレードオフがありますが、サイズは小さくするか、サイズは同じで数は少なくするかのいずれかです。最初のオプションは、余分なネットワーク関連の問題をキャッチするかもしれませんが、後者は管理が容易です。

もう一つ投資すべき分野は**自動テストインフラストラクチャ**です。何らかのクエリが一度成功裏に実行されたからといって、永遠に成功し続けるとは限りません。ClickHouseがモックアップされたユニットテストをいくつか持つことは構いませんが、あなたのプロダクトには、実際のClickHouseに対して実行され、すべての重要なユースケースが引き続き期待通りに機能していることを確認するための合理的な自動テストのセットがあることを確認してください。

さらなる一歩として、その自動テストを[ClickHouseのオープンソーステストインフラストラクチャ](https://github.com/ClickHouse/ClickHouse/tree/master/tests)に貢献することもできます。これは日々の開発に継続的に使用されています。これを実行する方法を学んで[どうやって適応させるか](../../development/tests.md)に確かに追加の時間と労力がかかりますが、ClickHouseのリリースが安定して発表されたときにすでにそれらに対してテストされることを保証することによって、投資が見返りをもたらします。そうすることで、問題を後で報告してバグ修正が実装され、バックポートされ、リリースされるのを待つ時間を繰り返し失うリスクを減らすことができます。いくつかの企業は、内部政策としてそのようなテスト貢献をインフラストラクチャに持っています（Googleでの[ビヨンセのルール](https://www.oreilly.com/library/view/software-engineering-at/9781492082781/ch01.html#policies_that_scale_well)と呼ばれます）。

プレプロダクション環境とテストインフラストラクチャが整っていると、最適なバージョンの選択は簡単になります：

1. 定期的に新しいClickHouseリリースに対して自動テストを実行してください。 `testing` とマークされたClickHouseのリリースに対しても実行できますが、その次のステップに進むことは推奨されません。
2. テストに合格したClickHouseリリースをプレプロダクションにデプロイし、すべてのプロセスが期待通りに実行されていることを確認してください。
3. 発見した問題は、[ClickHouse GitHub Issues](https://github.com/ClickHouse/ClickHouse/issues)に報告してください。
4. 重大な問題がなければ、ClickHouseリリースを本番環境にデプロイし始めても安全なはずです。 [カナリアリリース](https://martinfowler.com/bliki/CanaryRelease.html) や [グリーンブルーデプロイメント](https://martinfowler.com/bliki/BlueGreenDeployment.html) に類似したアプローチを実装する段階的リリースの自動化に投資することで、本番環境での問題のリスクをさらに減少させることができます。

気づいたかもしれませんが、上記で説明したアプローチはClickHouse特有のものではありません。このようなインフラストラクチャを信頼している人々は、本番環境を真剣に考慮している限り、どのインフラでも同じことを行います。
## ClickHouseリリースの選び方 {#how-to-choose-between-clickhouse-releases}

ClickHouseパッケージリポジトリの内容を見てみると、2種類のパッケージがあることがわかります：

1. `stable`
2. `lts`（長期サポート）

これらの間での選択方法についてのガイダンスは以下の通りです：

- `stable` はデフォルトで推奨するパッケージの種類です。これらは通常、毎月リリースされ（したがって、新機能は合理的な遅延で提供されます）、最新の3つの安定リリースは診断とバグ修正のバックポートに関してサポートされています。
- `lts` は年2回リリースされ、初回リリースから1年間サポートされます。次のような場合には、`stable` よりも `lts` を好むかもしれません：
    - あなたの会社には、頻繁なアップグレードや非LTSソフトウェアの使用を許可しない内部ポリシーがある。
    - あなたがClickHouseを使用している他の製品が、複雑なClickHouse機能を必要としないか、更新を維持するだけのリソースが不足している。

最初は `lts` が適切だと考える多くのチームも、製品にとって重要な最近の機能のために `stable` に切り替えることがよくあります。

:::tip    
ClickHouseをアップグレードする際に考慮すべきさらに1つのことがあります：私たちは常にリリース間の互換性に注意を払っていますが、時には保持が合理的でないことがあり、いくつかの小さな詳細が変更される可能性があります。アップグレードする前に[変更履歴](/whats-new/changelog/index.md)を確認して、後方互換性がない変更に関するノートがあるかどうかを確認してください。
:::
