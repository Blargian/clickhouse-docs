---
slug: /shards
title: 'Шарды и реплики таблиц'
description: 'Что такое шарды и реплики таблиц в ClickHouse'
keywords: ['shard', 'shards', 'sharding', 'replica', 'replicas']
---

import image_01 from '@site/static/images/managing-data/core-concepts/shards_01.png'
import image_02 from '@site/static/images/managing-data/core-concepts/shards_02.png'
import image_03 from '@site/static/images/managing-data/core-concepts/shards_03.png'
import image_04 from '@site/static/images/managing-data/core-concepts/shards_04.png'
import image_05 from '@site/static/images/managing-data/core-concepts/shards_replicas_01.png'
import Image from '@theme/IdealImage';

<br/>
:::note
Эта тема не относится к ClickHouse Cloud, где [Параллельные реплики](/docs/deployment-guides/parallel-replicas) функционируют как несколько шардов в традиционных кластерах ClickHouse без общего хранения, а объектное хранилище [заменяет](https://clickhouse.com/blog/clickhouse-cloud-boosts-performance-with-sharedmergetree-and-lightweight-updates#shared-object-storage-for-data-availability) реплики, обеспечивая высокую доступность и отказоустойчивость.
:::

## Что такое шарды таблиц в ClickHouse? {#what-are-table-shards-in-clickhouse}

В традиционных кластерах ClickHouse с архитектурой [shared-nothing](https://en.wikipedia.org/wiki/Shared-nothing_architecture) шардирование используется, когда ① данные слишком велики для единственного сервера или ② один сервер слишком медлен для обработки данных. Следующая фигура иллюстрирует случай ①, когда таблица [uk_price_paid_simple](/parts) превышает возможности одной машины:

<Image img={image_01} size="lg" alt='SHARDS'/>

<br/>

В таком случае данные могут быть распределены между несколькими серверами ClickHouse в виде шардов таблиц:

<Image img={image_02} size="lg" alt='SHARDS'/>

<br/>

Каждый шард содержит подмножество данных и функционирует как обычная таблица ClickHouse, к которой можно выполнять запросы независимо. Однако запросы будут обрабатывать только это подмножество, что может быть допустимым вариантом в зависимости от распределения данных. Обычно [распределенная таблица](/docs/engines/table-engines/special/distributed) (обычно на сервер) предоставляет единый обзор полного набора данных. Она не хранит данные сама по себе, а пересылает **SELECT** запросы ко всем шардам, собирает результаты и направляет **INSERT** для равномерного распределения данных.

## Создание распределенной таблицы {#distributed-table-creation}

Чтобы проиллюстрировать пересылку **SELECT** запросов и маршрутизацию **INSERT**, мы рассмотрим пример таблицы [Что такое части таблиц](/parts), разделенной на два шара на двух серверах ClickHouse. Сначала мы покажем DDL-запрос для создания соответствующей **Распределенной таблицы** для этой конфигурации:

```sql
CREATE TABLE uk.uk_price_paid_simple_dist ON CLUSTER test_cluster
(
    date Date,
    town LowCardinality(String),
    street LowCardinality(String),
    price UInt32
)
ENGINE = Distributed('test_cluster', 'uk', 'uk_price_paid_simple', rand())
```

Клаузула `ON CLUSTER` делает DDL-запрос [распределенным DDL-запросом](/docs/sql-reference/distributed-ddl), инструктируя ClickHouse создать таблицу на всех серверах, перечисленных в [определении кластера](https://docs/architecture/horizontal-scaling#replication-and-sharding-configuration) `test_cluster`. Распределенный DDL требует дополнительного компонента [Keeper](https://clickhouse.com/clickhouse/keeper) в [архитектуре кластера](/docs/architecture/horizontal-scaling#architecture-diagram).

Для [параметров распределенного движка](https://docs/engines/table-engines/special/distributed#distributed-parameters) мы указываем имя кластера (`test_cluster`), имя базы данных (`uk`) для целевой шардированной таблицы, имя шардированной целевой таблицы (`uk_price_paid_simple`) и **ключ шардирования** для маршрутизации INSERT. В этом примере мы используем функцию [rand](/sql-reference/functions/random-functions#rand) для случайного назначения строк на шарды. Однако можно использовать любое выражение — даже сложные — в качестве ключа шардирования, в зависимости от случая использования. Следующий раздел иллюстрирует, как работает маршрутизация INSERT.

## Маршрутизация INSERT {#insert-routing}

Ниже показана схема, иллюстрирующая, как INSERT в распределенную таблицу обрабатываются в ClickHouse:

<Image img={image_03} size="lg" alt='SHARDS'/>

<br/>

① INSERT (с одной строкой), направленный на распределенную таблицу, отправляется на сервер ClickHouse, который хостит таблицу, либо напрямую, либо через балансировщик нагрузки.

② Для каждой строки из INSERT (в нашем примере только одна) ClickHouse оценивает ключ шардирования (в данном случае rand()), берет результат по модулю количество серверов шардов и использует это как идентификатор целевого сервера (идентификаторы начинаются с 0 и увеличиваются на 1). Строка затем пересылается и ③ вставляется в соответствующий шард таблицы сервера.

Следующий раздел объясняет, как работает пересылка SELECT.

## Пересылка SELECT {#select-forwarding}

Эта схема показывает, как обрабатываются SELECT-запросы с распределенной таблицей в ClickHouse:

<Image img={image_04} size="lg" alt='SHARDS'/>

<br/>

① Аггрегационный запрос SELECT, нацеленный на распределенную таблицу, отправляется на соответствующий сервер ClickHouse, либо напрямую, либо через балансировщик нагрузки.

② Распределенная таблица пересылает запрос ко всем серверам, которые хостят шарды целевой таблицы, где каждый сервер ClickHouse вычисляет свой локальный агрегатный результат **параллельно**.

Затем сервер ClickHouse, на котором изначально была нацелена распределенная таблица ③ собирает все локальные результаты, ④ объединяет их в окончательный глобальный результат и ⑤ возвращает его отправителю запроса.

## Что такое реплики таблиц в ClickHouse? {#what-are-table-replicas-in-clickhouse}

Репликация в ClickHouse обеспечивает **целостность данных** и **резервное копирование** за счет поддержания **копий данных шардов** на нескольких серверах. Поскольку аппаратные сбои неизбежны, репликация предотвращает потерю данных, обеспечивая наличие нескольких реплик для каждого шарда. Записи могут направляться на любую реплику, либо напрямую, либо через [распределенную таблицу](#distributed-table-creation), которая выбирает реплику для операции. Изменения автоматически пропагируются на другие реплики. В случае сбоя или обслуживания данные остаются доступными на других репликах, и как только сбойный хост восстанавливается, он автоматически синхронизируется, чтобы оставаться актуальным.

Обратите внимание, что для репликации требуется компонент [Keeper](https://clickhouse.com/clickhouse/keeper) в [архитектуре кластера](/docs/architecture/horizontal-scaling#architecture-diagram).

Следующая схема иллюстрирует кластер ClickHouse с шестью серверами, где два шарда таблицы `Shard-1` и `Shard-2`, представленные ранее, имеют по три реплики. Запрос отправляется в этот кластер:

<Image img={image_05} size="lg" alt='SHARDS'/>

<br/>

Обработка запросов работает аналогично конфигурациям без реплик, при этом только одна реплика с каждого шарда выполняет запрос.

> Реплики не только обеспечивают целостность данных и резервное копирование, но также улучшают пропускную способность обработки запросов, позволяя нескольким запросам выполняться параллельно на разных репликах.

① Запрос, нацеленный на распределенную таблицу, отправляется на соответствующий сервер ClickHouse, либо напрямую, либо через балансировщик нагрузки.

② Распределенная таблица пересылает запрос одной реплике с каждого шарда, где каждый сервер ClickHouse, хостящий выбранную реплику, вычисляет свой локальный результат запроса параллельно.

Остальная часть работает [так же](#select-forwarding), как и в конфигурациях без реплик и не показана на схеме выше. Сервер ClickHouse, хостящий изначально нацеленную распределенную таблицу, собирает все локальные результаты, объединяет их в окончательный глобальный результат и возвращает его отправителю запроса.

Обратите внимание, что ClickHouse позволяет настраивать стратегию пересылки запросов для ②. По умолчанию — в отличие от схемы выше — распределенная таблица [предпочитает](https://docs/operations/settings/settings#prefer_localhost_replica) локальную реплику, если она доступна, но могут использоваться и другие стратегии балансировки [нагрузки](https://docs/operations/settings/settings#load_balancing).

## Где найти дополнительную информацию {#where-to-find-more-information}

Для получения дополнительной информации, выходящей за рамки этого общего введения в шарды и реплики таблиц, ознакомьтесь с нашим [руководством по развертыванию и масштабированию](/docs/architecture/horizontal-scaling).

Мы также настоятельно рекомендуем это учебное видео для более глубокого понимания шардов и реплик ClickHouse:

<iframe width="1024" height="576" src="https://www.youtube.com/embed/vBjCJtw_Ei0?si=WqopTrnti6usCMRs" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
