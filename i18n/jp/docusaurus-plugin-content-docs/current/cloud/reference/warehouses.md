---
title: 'ウェアハウス'
slug: /cloud/reference/warehouses
keywords: ['compute separation', 'cloud', 'architecture', 'compute-compute', 'warehouse', 'warehouses', 'hydra']
description: 'ClickHouse Cloudにおける計算分離'
---

import compute_1 from '@site/static/images/cloud/reference/compute-compute-1.png';
import compute_2 from '@site/static/images/cloud/reference/compute-compute-2.png';
import compute_3 from '@site/static/images/cloud/reference/compute-compute-3.png';
import compute_4 from '@site/static/images/cloud/reference/compute-compute-4.png';
import compute_5 from '@site/static/images/cloud/reference/compute-compute-5.png';
import compute_7 from '@site/static/images/cloud/reference/compute-compute-7.png';
import compute_8 from '@site/static/images/cloud/reference/compute-compute-8.png';
import Image from '@theme/IdealImage';


# ウェアハウス

## 計算分離とは何ですか？ {#what-is-compute-compute-separation}

計算分離は、ScaleおよびEnterpriseティアで利用可能です。

各ClickHouse Cloudサービスには以下が含まれます：
- 2つ以上のClickHouseノード（またはレプリカ）のグループが必要ですが、子サービスは単一レプリカでも構いません。
- 接続に使用するサービスのURLであるエンドポイント（またはClickHouse Cloud UIコンソールから作成された複数のエンドポイント）、例: `https://dv2fzne24g.us-east-1.aws.clickhouse.cloud:8443`。
- サービスがすべてのデータと部分的なメタデータを保存するオブジェクトストレージフォルダー：

:::note
子の単一サービスは、親サービスとは異なり、垂直にスケールできます。
:::

<Image img={compute_1} size="md" alt="ClickHouse Cloudの現在のサービス" />

<br />

_Fig. 1 - ClickHouse Cloudの現在のサービス_

計算分離により、ユーザーは同じオブジェクトストレージフォルダーを使用し、同じテーブル、ビューなどを持つ複数の計算ノードグループを作成できます。

各計算ノードグループは独自のエンドポイントを持つため、ワークロードに使用するレプリカのセットを選択できます。いくつかのワークロードは小さなサイズのレプリカ1つで満足するかもしれませんが、他のワークロードは完全な高可用性（HA）と数百ギガのメモリを必要とするかもしれません。計算分離はまた、読み取り操作と書き込み操作を分離しており、互いに干渉しないようにします：

<Image img={compute_2} size="md" alt="ClickHouse Cloudの計算分離" />

<br />

_Fig. 2 - ClickHouse Cloudの計算分離_

既存のサービスと同じデータを共有する追加サービスを作成することも、複数のサービスが同じデータを共有する全く新しいセットアップを作成することも可能です。

## ウェアハウスとは何ですか？ {#what-is-a-warehouse}

ClickHouse Cloudにおいて、_ウェアハウス_とは同じデータを共有するサービスのセットです。
各ウェアハウスにはプライマリサービス（最初に作成されたサービス）があり、セカンダリサービスがあります。以下のスクリーンショットでは、2つのサービスを持つウェアハウス「DWH Prod」を示しています：

- プライマリサービス `DWH Prod`
- セカンダリサービス `DWH Prod Subservice`

<Image img={compute_8} size="lg" alt="プライマリサービスとセカンダリサービスを持つウェアハウスの例" background='white' />

<br />

_Fig. 3 - ウェアハウスの例_

ウェアハウス内のすべてのサービスは以下を共有します：

- リージョン（例えば、us-east1）
- クラウドサービスプロバイダー（AWS、GCP、Azureいずれか）
- ClickHouseデータベースのバージョン

サービスをウェアハウスによってソートすることができます。

## アクセス制御 {#access-controls}

### データベースの資格情報 {#database-credentials}

ウェアハウス内のすべてのサービスは、同じテーブルのセットを共有するため、他のサービスへのアクセス制御も共有します。これは、サービス1で作成されたすべてのデータベースユーザーが、サービス2を同じ権限（テーブル、ビューなどに対するグラント）で使用できることを意味します。逆もまた然りです。ユーザーは各サービスごとに別のエンドポイントを使用しますが、同じユーザー名とパスワードを使用します。言い換えれば、_ユーザーは同じストレージで動作するサービス間で共有されます：_

<Image img={compute_3} size="md" alt="同じデータを共有するサービス間のユーザーアクセス" />

<br />

_Fig. 4 - サービス1で作成されたユーザーAliceは、同じデータを共有するすべてのサービスにアクセスするために同じ資格情報を使用できます_

### ネットワークアクセス制御 {#network-access-control}

特定のサービスが他のアプリケーションやアドホックユーザーによって使用されないように制限することがしばしば便利です。これは、ClickHouse Cloudコンソールの特定のサービスのサービスタブで**設定**に移動することにより、現在の通常のサービスに対して設定されている方法と同様に、ネットワーク制限を使用して行うことができます。

各サービスごとにIPフィルタリング設定を適用できるため、どのアプリケーションがどのサービスにアクセスできるかを制御できます。これにより、特定のサービスに対してのユーザーの使用を制限できます：

<Image img={compute_4} size="md" alt="ネットワークアクセス制御設定"/>

<br />

_Fig. 5 - ネットワーク設定のためにサービス2にアクセスすることが制限されているAlice_

### 読み取りと読み取り-書き込み {#read-vs-read-write}

特定のサービスへの書き込みアクセスを制限し、ウェアハウス内のサービスの一部のみを介して書き込みを許可することが便利な場合があります。これは、2番目以降のサービスを作成する際に行うことができます（最初のサービスは常に読み取り-書き込みでなければなりません）：

<Image img={compute_5} size="lg" alt="ウェアハウス内の読み取り-書き込みと読み取り専用のサービス"/>

<br />

_Fig. 6 - ウェアハウス内の読み取り-書き込みと読み取り専用のサービス_

:::note
1. 読み取り専用サービスは、現在ユーザー管理操作（作成、削除など）を許可しています。この動作は将来的に変更される可能性があります。
2. 現在、リフレッシュ可能なマテリアライズドビューは、ウェアハウス内のすべてのサービス（読み取り専用サービスを含む）で実行されます。この動作は将来的に変更され、RWサービスのみに実行される予定です。
:::

## スケーリング {#scaling}

ウェアハウス内の各サービスは、以下の点でワークロードに合わせて調整できます：
- ノード（レプリカ）の数。プライマリサービス（ウェアハウス内で最初に作成されたサービス）は、2つ以上のノードを持っている必要があります。各セカンダリサービスは、1つ以上のノードを持つことができます。
- ノード（レプリカ）のサイズ
- サービスが自動的にスケールするべきかどうか
- サービスが非アクティブ時にアイドル状態にすべきかどうか（グループ内の最初のサービスには適用できません - **制限事項**セクションを参照してください）

## 動作の変更 {#changes-in-behavior}
計算分離がサービスに対して有効になると（少なくとも1つのセカンダリサービスが作成された場合）、`clusterAllReplicas()` 関数の呼び出しは、呼び出されるサービスのレプリカのみを利用します。つまり、同じデータセットに接続されている2つのサービスがあり、サービス1から`clusterAllReplicas(default, system, processes)`が呼ばれた場合、サービス1で実行されているプロセスのみが表示されます。必要な場合は、例えば`clusterAllReplicas('all_groups.default', system, processes)`を呼び出してすべてのレプリカにアクセスすることができます。

## 制限事項 {#limitations}

1. **プライマリサービスは常に稼働している必要があり、アイドル状態にはできません（制限はGA後に削除される予定です）。** プライベートプレビューおよびGA後しばらくの間、プライマリサービス（通常は他のサービスを追加して拡張したい既存のサービス）は常に稼働しており、アイドル設定が無効になります。少なくとも1つのセカンダリサービスがある場合、プライマリサービスを停止したりアイドル状態にすることはできません。すべてのセカンダリサービスが削除されると、元のサービスを再び停止またはアイドル状態にすることができます。

2. **ワークロードを隔離できない場合があります。** データベースワークロードを互いに隔離するオプションを提供することが目標ですが、あるサービス内のワークロードが同じデータを共有する他のサービスに影響を与える可能性があるコーナーケースが存在することがあります。これは非常に稀な状況で、主にOLTPのようなワークロードに関連しています。

3. **すべての読み取り-書き込みサービスはバックグラウンドマージ処理を行っています。** ClickHouseにデータを挿入すると、最初にデータは一時的なパーティションに挿入され、その後バックグラウンドでマージが行われます。これらのマージはメモリおよびCPUリソースを消費する可能性があります。同じストレージを共有する2つの読み取り-書き込みサービスがあると、両方ともバックグラウンド操作を行っています。つまり、サービス1で`INSERT`クエリが発生しても、マージ操作はサービス2によって完了する可能性があります。読み取り専用サービスはバックグラウンドマージを実行しないため、この操作にリソースを消費することはありません。

4. **1つの読み取り-書き込みサービスへの挿入が、他の読み取り-書き込みサービスのアイドル化を妨げる可能性があります。** 前述の理由により、2番目のサービスは最初のサービスのバックグラウンドマージ操作を実行します。これらのバックグラウンド操作により、アイドル状態にすることができなくなります。バックグラウンド操作が完了すると、サービスはアイドル状態になります。読み取り専用サービスは影響を受けず、遅延なくアイドル状態になります。

5. **CREATE/RENAME/DROP DATABASEクエリは、デフォルトでアイドル/停止されたサービスによってブロックされる可能性があります。** これらのクエリはハングする可能性があります。これを回避するには、セッションまたはクエリレベルで`settings distributed_ddl_task_timeout=0`を使用してデータベース管理クエリを実行できます。たとえば：

```sql
create database db_test_ddl_single_query_setting
settings distributed_ddl_task_timeout=0
```

6. **非常に稀な状況では、アイドル状態または長期間（数日）停止されたセカンダリサービスが、同じウェアハウス内の他のサービスにパフォーマンスの低下を引き起こすことがあります。** この問題はすぐに解決される予定で、バックグラウンドで実行されるメタの変更に関連しています。この問題が発生していると考えられる場合は、ClickHouseの[サポート](https://clickhouse.com/support/program)に連絡してください。

7. **現在、ウェアハウスあたりのサービスのソフト制限は5つです。** 1つのウェアハウス内に5つを超えるサービスが必要な場合は、サポートチームに連絡してください。

## 価格設定 {#pricing}

計算価格は、ウェアハウス内のすべてのサービス（プライマリおよびセカンダリ）で同じです。ストレージは1回のみ請求され、最初の（オリジナルの）サービスに含まれます。

## バックアップ {#backups}

- 同じウェアハウス内のすべてのサービスが同じストレージを共有するため、バックアップはプライマリ（初期）サービスのみで作成されます。これにより、ウェアハウス内のすべてのサービスのデータがバックアップされます。
- ウェアハウスのプライマリサービスからバックアップを復元すると、それは既存のウェアハウスに接続されていない全く新しいサービスに復元されます。復元が完了した後に、新しいサービスにさらにサービスを追加することができます。

## ウェアハウスの使用 {#using-warehouses}

### ウェアハウスの作成 {#creating-a-warehouse}

ウェアハウスを作成するには、既存のサービスとデータを共有する第2のサービスを作成する必要があります。これは、既存のサービスのいずれかにプラスボタンをクリックすることで行えます：

<Image img={compute_7} size="md" alt="ウェアハウス内に新しいサービスを作成する" border background='white' />

<br />

_Fig. 7 - ウェアハウスに新しいサービスを作成するにはプラスボタンをクリックします_

サービス作成画面では、元のサービスが新しいサービスのデータソースとしてドロップダウンで選択されます。作成されると、これら2つのサービスはウェアハウスを形成します。

### ウェアハウスの名前の変更 {#renaming-a-warehouse}

ウェアハウスの名前を変更する方法は2つあります：

- サービスページの右上にある「ウェアハウスでソート」を選択し、ウェアハウス名の近くにある鉛筆アイコンをクリックします。
- 任意のサービス上でウェアハウス名をクリックし、そこでウェアハウスを名前変更します。

### ウェアハウスの削除 {#deleting-a-warehouse}

ウェアハウスを削除すると、すべての計算サービスとデータ（テーブル、ビュー、ユーザーなど）が削除されます。この操作は元に戻すことができません。
ウェアハウスを削除するには、最初に作成されたサービスを削除する必要があります。これを行うには：

1. 最初に作成されたサービスに加えて作成されたすべてのサービスを削除します；
2. 最初のサービスを削除します（警告：このステップでウェアハウスのすべてのデータが削除されます）。
