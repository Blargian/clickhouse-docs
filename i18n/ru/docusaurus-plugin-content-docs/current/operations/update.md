description: 'Документация по обновлению'
sidebar_title: 'Самоуправляемое обновление'
slug: /operations/update
title: 'Самоуправляемое обновление'
```

## ClickHouse upgrade overview {#clickhouse-upgrade-overview}

Этот документ содержит:
- общие рекомендации
- рекомендуемый план
- особенности обновления бинарных файлов на ваших системах

## General guidelines {#general-guidelines}

Эти заметки должны помочь вам в планировании и понимании причин рекомендаций, которые мы даем позже в документе.

### Upgrade ClickHouse server separately from ClickHouse Keeper or ZooKeeper {#upgrade-clickhouse-server-separately-from-clickhouse-keeper-or-zookeeper}

Если не требуется исправление безопасности для ClickHouse Keeper или Apache ZooKeeper, обновлять Keeper при обновлении ClickHouse сервера не обязательно. Стабильность Keeper необходима во время процесса обновления, поэтому завершите обновление ClickHouse сервера перед тем, как рассматривать обновление Keeper.

### Minor version upgrades should be adopted often {#minor-version-upgrades-should-be-adopted-often}

Настоятельно рекомендуется всегда обновляться до новой минорной версии сразу после ее выхода. Минорные релизы не содержат разрушающих изменений, но имеют важные исправления ошибок (и могут содержать исправления безопасности).

### Test experimental features on a separate ClickHouse server running the target version {#test-experimental-features-on-a-separate-clickhouse-server-running-the-target-version}

Совместимость экспериментальных функций может быть нарушена в любой момент любым образом. Если вы используете экспериментальные функции, проверьте журналы изменений и подумайте о том, чтобы настроить отдельный сервер ClickHouse с установленной целевой версией и протестировать ваше использование экспериментальных функций там.

### Downgrades {#downgrades}

Если вы обновились и затем поняли, что новая версия несовместима с какой-то функцией, от которой вы зависите, вы можете вернуться к недавней (меньше года) версии, если не начали использовать какие-либо новые функции. Как только новые функции будут использованы, откат не сработает.

### Multiple ClickHouse server versions in a cluster {#multiple-clickhouse-server-versions-in-a-cluster}

Мы стараемся поддерживать окно совместимости в один год (включая 2 версии LTS). Это означает, что любые две версии должны работать вместе в кластере, если разница между ними составляет меньше одного года (или если между ними менее двух версий LTS). Тем не менее, рекомендуется как можно быстрее обновить всех участников кластера до одной версии, так как некоторые незначительные проблемы возможны (например, замедление распределенных запросов, ошибки повторных попыток в некоторых фоновых операциях в ReplicatedMergeTree и т.д.).

Мы никому не рекомендуем запускать разные версии в одном кластере, когда даты релиза отличаются более чем на один год. Хотя мы не ожидаем потерю данных, кластер может стать непригодным для использования. Проблемы, которые вы можете ожидать, если разница в версиях более одного года, включают:

- кластер может не работать
- некоторые (или даже все) запросы могут завершаться с произвольными ошибками
- произвольные ошибки/предупреждения могут появляться в журналах
- вернуться к предыдущей версии может быть невозможно

### Incremental upgrades {#incremental-upgrades}

Если разница между текущей версией и целевой версией составляет более одного года, рекомендуется либо:
- Обновить с простоем (остановить все серверы, обновить все серверы, запустить все серверы).
- Либо обновить через промежуточную версию (версия должна быть менее чем на год новее текущей версии).

## Recommended plan {#recommended-plan}

Это рекомендуемые шаги для обновления ClickHouse без простоя:

1. Убедитесь, что ваши изменения конфигурации не находятся в файле по умолчанию `/etc/clickhouse-server/config.xml`, а вместо этого находятся в `/etc/clickhouse-server/config.d/`, поскольку `/etc/clickhouse-server/config.xml` может быть перезаписан во время обновления.
2. Ознакомьтесь с [журналами изменений](/whats-new/changelog/index.md) на наличие разрушающих изменений (от целевой версии до версии, на которой вы сейчас находитесь).
3. Выполните любые обновления, указанные в разрушающих изменениях, которые можно сделать до обновления, и составьте список изменений, которые нужно будет внести после обновления.
4. Определите одну или несколько реплик для каждого шардирования, чтобы они поддерживались в то время, как остальные реплики для каждого шардирования обновляются.
5. На репликах, которые будут обновлены, по одной за раз:
   - остановить сервер ClickHouse
   - обновить сервер до целевой версии
   - запустить сервер ClickHouse
   - дождаться сообщений Keeper, подтверждающих, что система стабильна
   - перейти к следующей реплике
6. Проверьте на наличие ошибок в журнале Keeper и журнале ClickHouse
7. Обновите реплики, указанные на шаге 4, до новой версии
8. Обратитесь к списку изменений, внесенных на шагах 1-3, и внесите изменения, которые необходимо сделать после обновления.

:::note
Это сообщение об ошибке ожидаемо, когда в реплицированной среде работают несколько версий ClickHouse. Вы перестанете видеть эти сообщения, когда все реплики будут обновлены до одной версии.
```text
MergeFromLogEntryTask: Code: 40. DB::Exception: Контрольные суммы частей не совпадают:
хеш не сходит с некомпрессированных файлов. (CHECKSUM_DOESNT_MATCH)  Данные после слияния не
идентичны данным на других репликах.
```
:::

## ClickHouse server binary upgrade process {#clickhouse-server-binary-upgrade-process}

Если ClickHouse был установлен из пакетов `deb`, выполните следующие команды на сервере:

```bash
$ sudo apt-get update
$ sudo apt-get install clickhouse-client clickhouse-server
$ sudo service clickhouse-server restart
```

Если вы установили ClickHouse, используя другой метод, отличный от рекомендуемых пакетов `deb`, используйте соответствующий метод обновления.

:::note
Вы можете обновлять несколько серверов одновременно, как только не будет момента, когда все реплики одного шардирования отключены.
:::

Обновление более старой версии ClickHouse до конкретной версии:

Например:

`xx.yy.a.b` - это текущая стабильная версия. Последнюю стабильную версию можно найти [здесь](https://github.com/ClickHouse/ClickHouse/releases)

```bash
$ sudo apt-get update
$ sudo apt-get install clickhouse-server=xx.yy.a.b clickhouse-client=xx.yy.a.b clickhouse-common-static=xx.yy.a.b
$ sudo service clickhouse-server restart
