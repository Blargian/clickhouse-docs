---
sidebar_label: 'Обзор'
sidebar_position: 0
slug: /cloud/manage/backups/overview
title: 'Обзор'
keywords: ['backups', 'cloud backups', 'restore']
description: 'Предоставляет обзор резервных копий в ClickHouse Cloud'
---

import CloudNotSupportedBadge from '@theme/badges/CloudNotSupportedBadge';
import ScalePlanFeatureBadge from '@theme/badges/ScalePlanFeatureBadge';
import Image from '@theme/IdealImage';
import backup_chain from '@site/static/images/cloud/manage/backup-chain.png';
import backup_status_list from '@site/static/images/cloud/manage/backup-status-list.png';
import backup_usage from '@site/static/images/cloud/manage/backup-usage.png';
import backup_restore from '@site/static/images/cloud/manage/backup-restore.png';
import backup_service_provisioning from '@site/static/images/cloud/manage/backup-service-provisioning.png';


# Резервные копии

Резервные копии баз данных обеспечивают защиту, гарантируя, что если данные будут утеряны по какой-либо непредвиденной причине, служба может быть восстановлена до предыдущего состояния из последней успешной резервной копии. Это минимизирует время простоя и предотвращает постоянную потерю критически важных данных для бизнеса. Этот гид охватывает, как работают резервные копии в ClickHouse Cloud, какие у вас есть варианты настройки резервных копий для вашей службы, и как восстановить данные из резервной копии.

## Как работают резервные копии в ClickHouse Cloud {#how-backups-work-in-clickhouse-cloud}

Резервные копии ClickHouse Cloud представляют собой комбинацию "полных" и "инкрементных" резервных копий, которые составляют цепочку резервных копий. Цепочка начинается с полной резервной копии, а инкрементные резервные копии создаются в последующие запланированные промежутки времени для формирования последовательности резервных копий. Как только длина цепочки резервных копий достигает определенной величины, начинается новая цепочка. Эта вся цепочка резервных копий затем может быть использована для восстановления данных в новую службу, если это необходимо. Как только все резервные копии, входящие в конкретную цепочку, выходят за рамки установленного периода хранения (подробнее о хранении ниже), цепочка удаляется.

На скриншоте ниже сплошные квадраты обозначают полные резервные копии, а пунктирные квадраты показывают инкрементные резервные копии. Сплошной прямоугольник вокруг квадратов обозначает период хранения и резервные копии, которые видны конечному пользователю, которые могут быть использованы для восстановления резервной копии. В приведенном ниже сценарии резервные копии создаются каждые 24 часа и хранятся в течение 2 дней.

В День 1 создается полная резервная копия, чтобы начать цепочку резервных копий. В День 2 создается инкрементная резервная копия, и у нас теперь есть полная и инкрементная резервная копия для восстановления. К Дню 7 у нас есть одна полная резервная копия и шесть инкрементных резервных копий в цепочке, при этом два самых последних инкрементных резервных копий visible для пользователя. В День 8 мы создаем новую полную резервную копию, а в День 9, как только у нас будет две резервные копии в новой цепочке, предыдущая цепочка удаляется.

<Image img={backup_chain} size="md" alt="Пример цепочки резервных копий в ClickHouse Cloud" />

*Пример сценария резервного копирования в Clickhouse Cloud*

## Политика резервного копирования по умолчанию {#default-backup-policy}

В базовых, масштабируемых и корпоративных тарифах резервные копии учитываются и оплачиваются отдельно от хранения. Все службы по умолчанию имеют одну резервную копию с возможностью настройки большего количества, начиная с масштабируемого тарифа, через вкладку Настройки консоли облака.

## Список статусов резервных копий {#backup-status-list}

Ваша служба будет подвергаться резервному копированию в соответствии с установленным расписанием, будь то расписание по умолчанию или [пользовательское расписание](./configurable-backups.md), выбранное вами. Все доступные резервные копии можно просмотреть на вкладке **Резервные копии** службы. Отсюда вы можете видеть статус резервной копии, ее продолжительность, а также размер резервной копии. Вы также можете восстановить конкретную резервную копию, используя колонку **Действия**.

<Image img={backup_status_list} size="md" alt="Список статусов резервных копий в ClickHouse Cloud" border/>

## Понимание стоимости резервного копирования {#understanding-backup-cost}

Согласно политике по умолчанию, ClickHouse Cloud требует резервное копирование каждый день с 24-часовым периодом хранения. Выбор расписания, которое требует сохранения большего объема данных или приводит к более частым резервным копиям, может вызвать дополнительные расходы на хранение резервных копий.

Чтобы понять стоимость резервного копирования, вы можете просмотреть стоимость резервного копирования по службе на экране использования (как показано ниже). Как только ваши резервные копии будут работать в течение нескольких дней с пользовательским расписанием, вы сможете получить представление о стоимости и экстраполировать, чтобы получить ежемесячную стоимость для резервных копий.

<Image img={backup_usage} size="md" alt="Диаграмма использования резервных копий в ClickHouse Cloud" border/>

Оценка общей стоимости ваших резервных копий требует от вас установки расписания. Мы также работаем над обновлением нашего [калькулятора цен](https://clickhouse.com/pricing), чтобы вы могли получить приблизительную ежемесячную стоимость перед установкой расписания. Вам необходимо предоставить следующие данные для оценки стоимости:
- Размер полных и инкрементных резервных копий
- Желаемая частота
- Желаемое время хранения
- Провайдер облака и регион

:::note
Имейте в виду, что оцениваемая стоимость резервных копий будет изменяться по мере роста объема данных в службе с течением времени.
:::


## Восстановление резервной копии {#restore-a-backup}

Резервные копии восстанавливаются в новую службу ClickHouse Cloud, а не в существующую службу, из которой была сделана резервная копия.

После нажатия на значок **Восстановить** резервную копию вы можете указать имя службы новой службы, которая будет создана, и затем восстановить эту резервную копию:

<Image img={backup_restore} size="md" alt="Восстановление резервной копии в ClickHouse Cloud" />

Новая служба будет отображаться в списке служб как `Provisioning` до тех пор, пока она не будет готова:

<Image img={backup_service_provisioning} size="md" alt="Процесс предоставления сервиса" border/>

## Работа с вашей восстановленной службой {#working-with-your-restored-service}

После того как резервная копия была восстановлена, у вас теперь будет две похожие службы: **оригинальная служба**, которую необходимо восстановить, и новая **восстановленная служба**, которая была восстановлена из резервной копии оригинальной.

Как только восстановление резервной копии завершено, вам следует сделать одно из следующего:
- Использовать новую восстановленную службу и удалить оригинальную службу.
- Перенести данные из новой восстановленной службы обратно в оригинальную службу и удалить новую восстановленную службу.

### Используйте **новую восстановленную службу** {#use-the-new-restored-service}

Чтобы использовать новую службу, выполните следующие шаги:

1. Убедитесь, что новая служба имеет записи в списке доступа по IP, необходимые для вашего использования.
1. Убедитесь, что новая служба содержит необходимые вам данные.
1. Удалите оригинальную службу.

### Перенос данных из **новой восстановленной службы** обратно в **оригинальную службу** {#migrate-data-from-the-newly-restored-service-back-to-the-original-service}

Предположим, что вы не можете работать с новой восстановленной службой по какой-либо причине, например, если у вас все еще есть пользователи или приложения, которые подключаются к существующей службе. Вы можете решить перенести новые восстановленные данные в оригинальную службу. Перенос можно осуществить, следуя этим шагам:

**Разрешите удаленный доступ к новой восстановленной службе**

Новая служба должна быть восстановлена из резервной копии с таким же списком разрешенных IP, как оригинальная служба. Это требуется, так как подключения к другим службам ClickHouse Cloud не будут разрешены, если вы не разрешили доступ из **Anywhere**. Временно измените список разрешений и разрешите доступ из **Anywhere**. Смотрите документацию по [Списку доступа по IP](/cloud/security/setting-ip-filters) для подробностей.

**На вновь восстановленной службе ClickHouse (системе, которая содержит восстановленные данные)**

:::note
Вам нужно будет сбросить пароль для новой службы, чтобы получить к ней доступ. Это можно сделать на вкладке **Настройки** в списке служб.
:::

Добавьте пользователя только для чтения, который может читать исходную таблицу (`db.table` в этом примере):

  ```sql
  CREATE USER exporter
  IDENTIFIED WITH SHA256_PASSWORD BY 'password-here'
  SETTINGS readonly = 1;
  ```

  ```sql
  GRANT SELECT ON db.table TO exporter;
  ```

Скопируйте определение таблицы:

  ```sql
  SELECT create_table_query
  FROM system.tables
  WHERE database = 'db' AND table = 'table'
  ```

**На целевой системе ClickHouse Cloud (той, в которой была повреждена таблица):**

Создайте целевую базу данных:
  ```sql
  CREATE DATABASE db
  ```

Используя оператор `CREATE TABLE` из источника, создайте целевую таблицу:

:::tip
Измените `ENGINE` на `ReplicatedMergeTree` без каких-либо параметров, когда вы запускаете оператор `CREATE`. ClickHouse Cloud всегда реплицирует таблицы и предоставляет правильные параметры.
:::

  ```sql
  CREATE TABLE db.table ...
  ENGINE = ReplicatedMergeTree
  ORDER BY ...
  ```

Используйте функцию `remoteSecure`, чтобы перенести данные из вновь восстановленной службы ClickHouse Cloud в вашу оригинальную службу:

  ```sql
  INSERT INTO db.table
  SELECT *
  FROM remoteSecure('source-hostname', db, table, 'exporter', 'password-here')
  ```

После того как вы успешно вставили данные в свою оригинальную службу, убедитесь, что вы проверили данные в службе. Вам также следует удалить новую службу, как только данные будут проверены.

## Восстановление или восстановление таблиц {#undeleting-or-undropping-tables}

<CloudNotSupportedBadge/>

Команда `UNDROP` не поддерживается в ClickHouse Cloud. Если вы случайно `DROP` таблицу, лучшее решение - восстановить последнюю резервную копию и воссоздать таблицу из резервной копии.

Чтобы предотвратить случайное удаление таблиц пользователями, вы можете использовать [`GRANT` оператор](/sql-reference/statements/grant), чтобы отозвать права на команду [`DROP TABLE` оператор](/sql-reference/statements/drop#drop-table) для конкретного пользователя или роли.

:::note
Чтобы предотвратить случайное удаление данных, обратите внимание, что по умолчанию невозможно удалить таблицы >`1TB` в ClickHouse Cloud.
Если вы хотите удалить таблицы, превышающие этот порог, вы можете использовать настройку `max_table_size_to_drop`, чтобы сделать это:

```sql
DROP TABLE IF EXISTS table_to_drop
SYNC SETTINGS max_table_size_to_drop=2097152 -- увеличивает лимит до 2TB
```
:::

## Настраиваемые резервные копии {#configurable-backups}

Если вы хотите настроить расписание резервного копирования, отличное от расписания резервного копирования по умолчанию, ознакомьтесь с [Настраиваемыми резервными копиями](./configurable-backups.md).

## Экспорт резервных копий в вашу собственную облачную учетную запись {#export-backups-to-your-own-cloud-account}

Пользователи, желающие экспортировать резервные копии в свою собственную облачную учетную запись, могут ознакомиться с [данной ссылкой](./export-backups-to-own-cloud-account.md).
