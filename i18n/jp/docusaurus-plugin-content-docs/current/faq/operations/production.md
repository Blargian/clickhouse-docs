---
slug: /faq/operations/production
title: '本番環境で使用するClickHouseのバージョンはどれですか？'
toc_hidden: true
toc_priority: 10
description: 'このページでは、本番環境で使用するClickHouseのバージョンについてのガイダンスを提供します'
---


# 本番環境で使用するClickHouseのバージョンはどれですか？ {#which-clickhouse-version-to-use-in-production}

まず、なぜ人々がこの質問をするのかについて考えてみましょう。主な理由は二つあります。

1.  ClickHouseは非常に高い速度で開発されており、通常は年に10回以上の安定版リリースがあります。これにより、選択肢が広がりますが、それはあまり単純な選択ではありません。
2.  一部のユーザーは、どのバージョンが自分のユースケースに最適かを考えるのに時間を費やしたくなく、他の人のアドバイスに従いたいと考えています。

二つ目の理由はより根本的であるため、それから始めて、さまざまなClickHouseリリースをナビゲートする方法に戻りましょう。

## どのClickHouseバージョンをお勧めしますか？ {#which-clickhouse-version-do-you-recommend}

コンサルタントを雇ったり、知られた専門家に頼んで本番環境の責任を回避したくなるのは理解できます。誰か他の人が推奨する特定のClickHouseバージョンをインストールし、それに問題があればあなたの責任ではありません。しかし、この考え方は大きな罠です。外部の誰も、あなたの会社の本番環境で何が起こっているかをよりよく理解しているわけではありません。

では、どのようにして適切なClickHouseバージョンにアップグレードするか、または最初のClickHouseバージョンをどのように選ぶかですか？まず、**現実的なプレプロダクション環境**の設定に投資する必要があります。理想的には、完全に同一のシャドーコピーが望ましいですが、それは通常高価です。

コストを抑えて、プレプロダクション環境の合理的な忠実度を確保するための重要なポイントは以下の通りです：

- プレプロダクション環境では、本番で実行する予定のクエリにできるだけ近いセットのクエリを実行する必要があります：
    - 固定データで読み取り専用にしないでください。
    - データをコピーするだけの書き込み専用にはしないでください。
    - スキーママイグレーションを適用する代わりに完全にクリーンにしないでください。
- 実際の本番データとクエリのサンプルを使用してください。まだ代表的であり、`SELECT`クエリが合理的な結果を返すようなサンプルを選ぶようにしてください。データが機密性が高い場合は、内部ポリシーが本番環境からデータを持ち出すことを許可しない場合、ぼかしを使用してください。
- プレプロダクションは、本番環境と同様に監視およびアラートソフトウェアでカバーされていることを確認してください。
- 本番が複数のデータセンターやリージョンにまたがっている場合、プレプロダクションも同様にしてください。
- 本番でレプリケーション、分散テーブル、カスケーディング・マテリアライズド・ビューなどの複雑な機能を使用している場合、プレプロダクションでも同様に設定してください。
- プレプロダクションで本番と同じ数のサーバーまたはVMを小型で使用するか、同じサイズでもっと少ない数を使用するかのトレードオフがあります。最初のオプションは追加のネットワーク関連の問題をキャッチするかもしれませんが、後者は管理が容易です。

二つ目の投資エリアは**自動テストインフラストラクチャ**です。ある種のクエリが一度成功したからといって、それが永遠に成功し続けるとは限りません。ClickHouseをモックにしたユニットテストを持つことは問題ありませんが、製品が実際のClickHouseに対して実行される合理的な自動テストのセットを確保するようにしてください。そして、すべての重要なユースケースが期待通りに動作するかをチェックしてください。

さらに一歩進めると、[ClickHouseのオープンソーステストインフラストラクチャ](https://github.com/ClickHouse/ClickHouse/tree/master/tests)にその自動テストを寄与することができます。これは日々の開発に継続的に使用されています。これを実行する方法を学び、テストをこのフレームワークに適応させるためには追加の時間と労力が必要ですが、ClickHouseのリリースが安定と見なされたときにすでにテストされていることを保証し、事後に問題を報告して修正が実施され、バックポートされ、リリースされるのを待つ時間を繰り返し無駄にすることがなくなります。一部の企業では、内部ポリシーとしてそのようなテストの寄与を要求しています（Googleでは[ビヨンセの法則](https://www.oreilly.com/library/view/software-engineering-at/9781492082781/ch01.html#policies_that_scale_well)と呼ばれています）。

プレプロダクション環境とテストインフラストラクチャが整った状態で、最適なバージョンを選ぶのは簡単です：

1.  定期的に新しいClickHouseリリースに対して自動テストを実行します。`testing`とマークされたClickHouseリリースに対してもそれを行うことができますが、その後のステップに進むことをお勧めしません。
2.  テストに合格したClickHouseリリースをプレプロダクションにデプロイし、すべてのプロセスが期待通りに動作しているかを確認します。
3.  発見した問題を[ClickHouse GitHub Issues](https://github.com/ClickHouse/ClickHouse/issues)に報告します。
4.  大きな問題がなければ、ClickHouseリリースを本番環境にデプロイし始めても安全でしょう。[カナリアリリース](https://martinfowler.com/bliki/CanaryRelease.html)や[グリーン・ブルーデプロイメント](https://martinfowler.com/bliki/BlueGreenDeployment.html)に類似したアプローチを実装する段階的なリリース自動化に投資することで、本番での問題のリスクをさらに軽減できます。

お分かりの通り、上記のアプローチにはClickHouseに特有の内容はありません。人々は、本番環境を真剣に考える場合、信頼するインフラストラクチャに対してこれを行います。

## ClickHouseリリースの選び方 {#how-to-choose-between-clickhouse-releases}

ClickHouseパッケージリポジトリの内容を調べると、二種類のパッケージがあることがわかります：

1.  `stable`
2.  `lts`（長期サポート）

これらの選択肢の間でどのように選ぶかのガイダンスは以下の通りです：

- `stable`は、デフォルトでお勧めするパッケージの種類です。おおよそ月に1回リリースされ（新機能を合理的に遅れて提供）、最新の三つの安定版リリースは診断およびバグ修正のバックポートのサポートがあります。
- `lts`は年に二回リリースされ、初回リリースから1年間サポートされます。以下のケースでは`stable`よりも`lts`を優先するかもしれません：
    - 会社の内部ポリシーにより、頻繁なアップグレードや非LTSソフトウェアの使用が許可されない場合。
    - ClickHouseを二次製品で使用していて、複雑なClickHouseの機能を必要としないか、更新を維持するためのリソースが十分でない場合。

多くのチームは、最初は`lts`が最良の選択だと考えていますが、製品にとって重要な最近の機能のために`stable`に切り替えることがよくあります。

:::tip    
ClickHouseをアップグレードする際に考慮すべきことがもう一つあります。リリース間の互換性には常に目を光らせていますが、時には維持することが合理的でなく、いくつかの細かい点が変更されることがあります。したがって、アップグレード前に[変更履歴](/whats-new/changelog/index.md)を確認し、後方互換性のない変更に関する注意事項があるかどうかを確認してください。
:::
