# Autogenerated markdown

This is a small explanation of how to work with the autogenerated markdown documentation, in case of future updates.

In this folder you will find the following files:
- `autogenerate-settings.sh` (defines the queries for generating each markdown page)
- `resultset_{}_settings.format` (one file per generated page defining the template of the markdown page)
- `row_settings.format` (defines the structure of each setting entry which will get inserted into one of the template pages mentioned above).

## Example

The [MergeTree Table Settings]() page is generated using these files: `autogenerate-settings.sh`, `resultset_{}_settings.format` and `row_settings.format`.

In `autogenerate-settings.sh` ClickHouse will be cloned and the following query is run:

```sql
WITH
'FormatFactorySettings.h' AS cpp_file,
format_settings_from_source AS
(
    SELECT extract(line, 'DECLARE\\(\\w+, (\\w+),') AS name
    FROM file(cpp_file, LineAsString)
    WHERE match(line, '^\\s*DECLARE\\(')
)
SELECT
    name,
    description,
    type,
    default,
    tier,
FROM system.settings
WHERE name IN format_settings_from_source
ORDER BY
  CASE
    WHEN tier = 'Production' THEN 1
    WHEN tier = 'Beta' THEN 2
    WHEN tier = 'Experimental' THEN 3
    WHEN tier = 'Obsolete' THEN 4
  END, name ASC
INTO OUTFILE 'docs/en/operations/settings/settings-formats.md' TRUNCATE
FORMAT Template
SETTINGS
format_template_resultset = 'scripts/settings/resultset_format_settings.format',
format_template_row = 'scripts/settings/row_settings.format'
```
For this markdown file it is necessary to first extract only the format settings from the `system.settings` table which contains not only the settings for formats, but also the core settings.
The format settings are defined in [FormatSettings.h]() and so we first extract the names of all the format settings into `format_settings_from_source`.

Once this is done we can use this list as a condition to select only the format settings from `system.settings`.

We are using the [Template](http://www.clickhouse.com/docs/en/interfaces/formats#format-template) format to generate the markdown. We specify the general page template using `resultset_format_settings.format` which is specified using setting `format_template_resultset`:

```text
---
title: Format Settings
sidebar_label: Format Settings
slug: /en/operations/settings/formats
---

<!--Do not edit – this file is autogenerated-->

## Format Settings

${data}
```

the `Template` format will insert the selected rows with the structure we define (as markdown in our case) in `row_settings.format`, replacing `${data}`.

`row_settings.format` defines the structure of each individual setting entry and the file to use is defined by setting `format_template_row`:

```text
## ${0:XML}

${1:XML}

**Type**: ${2:XML}<br/>
**Default value**: `${3:XML}`<br/>
**Tier**: ${4:XML}<br/>
```

Where:
- `${0:XML}` will insert the selected `name`
- `${1:XML}` will insert the selected `description`
- `${2:XML}` will insert the selected `type`
- `${3:XML}` will insert the selected `default`
- `${4:XML}` will insert the selected `tier`

**Changing this file will change the layout for ALL generated markdown files**

If different row formatting is needed for a specific markdown file, then please create a new `row_setttings_{page}.format` and specify to use this new file with the `format_template_row` setting in the query.

## Testing locally

(Assuming you can already build the docs locally. (If not see the docs repository readme for details))
To test locally you can run `yarn new-build` (see package.json for details) to build the docs. Afterwards run `yarn start` to launch docusaurus locally.
You can inspect the pages to make sure that the output is correct.

N.B Any changes to the content of the descriptions of the settings now need to be made to the table itself.
changes made to the generated markdown files will just be overwritten each time we build the documentation.