---
title: Protobuf
slug: /interfaces/formats/Protobuf
keywords: [Protobuf]
input_format: true
output_format: true
alias: []
---

import CloudNotSupportedBadge from '@theme/badges/CloudNotSupportedBadge';

<CloudNotSupportedBadge/>

| 入力 | 出力 | エイリアス |
|-------|--------|-------|
| ✔     | ✔      |       |

## 説明 {#description}

`Protobuf`フォーマットは[Protocol Buffers](https://protobuf.dev/)フォーマットです。

このフォーマットは、クエリ間でキャッシュされる外部フォーマットスキーマを必要とします。

ClickHouseは以下をサポートしています：
- `proto2`および`proto3`構文の両方。
- `Repeated`/`optional`/`required`フィールド。

## 使用例 {#example-usage}

### 基本的な例 {#basic-examples}

使用例：

```sql
SELECT * FROM test.table FORMAT Protobuf SETTINGS format_schema = 'schemafile:MessageType'
```

```bash
cat protobuf_messages.bin | clickhouse-client --query "INSERT INTO test.table SETTINGS format_schema='schemafile:MessageType' FORMAT Protobuf"
```

ファイル`schemafile.proto`は以下のようになります：

```capnp
syntax = "proto3";

message MessageType {
  string name = 1;
  string surname = 2;
  uint32 birthDate = 3;
  repeated string phoneNumbers = 4;
};
```

ClickHouseはテーブルカラムとProtocol Buffersのメッセージタイプのフィールドの対応を名前で比較します。
この比較は大文字小文字を区別せず、文字`_`（アンダースコア）および`.`（ドット）は等しいものとして扱われます。
カラムとProtocol Buffersのメッセージフィールドのタイプが異なる場合、必要な変換が適用されます。

ネストされたメッセージがサポートされています。例えば、以下のメッセージタイプのフィールド`z`に対して：

```capnp
message MessageType {
  message XType {
    message YType {
      int32 z;
    };
    repeated YType y;
  };
  XType x;
};
```

ClickHouseは`x.y.z`（または`x_y_z`、`X.y_Z`など）という名前のカラムを探します。

ネストされたメッセージは[ネストデータ構造](/sql-reference/data-types/nested-data-structures/index.md)の入力または出力に適しています。

以下のようなprotobufスキーマで定義されたデフォルト値は適用されず、代わりに[テーブルのデフォルト値](/sql-reference/statements/create/table.md/#create-default-values)が使用されます：

```capnp
syntax = "proto2";

message MessageType {
  optional int32 result_per_page = 3 [default = 10];
}
```

ClickHouseは`length-delimited`フォーマットでprotobufメッセージを入力および出力します。
これは、各メッセージの前にその長さを[可変幅整数 (varint)](https://developers.google.com/protocol-buffers/docs/encoding#varints)として書き込む必要があることを意味します。

さらに詳しくは、[人気のある言語での長さ区切りのprotobufメッセージの読み書き方法](https://cwiki.apache.org/confluence/display/GEODE/Delimiting+Protobuf+Messages)をご覧ください。

### 自動生成スキーマの利用 {#using-autogenerated-protobuf-schema}

データに対して外部のProtobufスキーマがない場合でも、自動生成されたスキーマを使用してProtobufフォーマットでデータを出力/入力できます。

例えば：

```sql
SELECT * FROM test.hits format Protobuf SETTINGS format_protobuf_use_autogenerated_schema=1
```

この場合、ClickHouseはテーブル構造に従ってProtobufスキーマを自動生成し、[`structureToProtobufSchema`](/sql-reference/functions/other-functions.md#structure_to_protobuf_schema)関数を使用します。
その後、このスキーマを使用してProtobufフォーマットでデータをシリアライズします。

自動生成されたスキーマを使用してProtobufファイルを読み込むこともできます。この場合、ファイルは同じスキーマを使用して作成されている必要があります：

```bash
$ cat hits.bin | clickhouse-client --query "INSERT INTO test.hits SETTINGS format_protobuf_use_autogenerated_schema=1 FORMAT Protobuf"
```

設定[`format_protobuf_use_autogenerated_schema`](/operations/settings/settings-formats.md#format_protobuf_use_autogenerated_schema)はデフォルトで有効であり、[`format_schema`](/operations/settings/settings-formats.md#formatschema-format-schema)が設定されていない場合に適用されます。

入力/出力中に自動生成スキーマをファイルに保存することもできます。設定[`output_format_schema`](/operations/settings/settings-formats.md#outputformatschema-output-format-schema)を使用します。例えば：

```sql
SELECT * FROM test.hits format Protobuf SETTINGS format_protobuf_use_autogenerated_schema=1, output_format_schema='path/to/schema/schema.proto'
```
この場合、自動生成されたProtobufスキーマはファイル`path/to/schema/schema.capnp`に保存されます。

### Protobufキャッシュの削除 {#drop-protobuf-cache}

[`format_schema_path`](/operations/server-configuration-parameters/settings.md/#format_schema_path)からロードされたProtobufスキーマを再読み込みするには、[`SYSTEM DROP ... FORMAT CACHE`](/sql-reference/statements/system.md/#system-drop-schema-format)ステートメントを使用します。

```sql
SYSTEM DROP FORMAT SCHEMA CACHE FOR Protobuf
```

## フォーマット設定 {#format-settings}
