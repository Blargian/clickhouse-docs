---
description: 'Руководство по использованию и настройке функции кэша условий запросов в ClickHouse'
sidebar_label: 'Кэш условий запросов'
sidebar_position: 64
slug: /operations/query-condition-cache
title: 'Кэш условий запросов'
---


# Кэш условий запросов

Многие реальные рабочие нагрузки включают повторяющиеся запросы к одним и тем же или почти одинаковым данным (например, ранее существовавшие данные плюс новые данные).
ClickHouse предоставляет различные методы оптимизации для таких шаблонов запросов.
Одна из возможностей - настроить физическую структуру данных, используя индексные структуры (например, первичные индексы, индексы пропуска, проекции) или предварительные вычисления (материализованные представления).
Другая возможность - использовать [кэш запросов](query-cache.md) ClickHouse для избежания повторной оценки запросов.
Недостаток первого подхода в том, что он требует ручного вмешательства и мониторинга со стороны администратора базы данных.
Второй подход может возвращать устаревшие результаты (так как кэш запросов транзакционно не согласован), что может быть приемлемо или нет, в зависимости от конкретного случая использования.

Кэш условий запросов предоставляет элегантное решение для обеих проблем.
Он основан на идее, что оценка условия фильтра (например, `WHERE col = 'xyz'`) на одних и тех же данных всегда будет возвращать одинаковые результаты.
Более конкретно, кэш условий запросов запоминает для каждого оцененного фильтра и каждой гранулы (= блок из 8192 строк по умолчанию), удовлетворяет ли хотя бы одна строка в грануле условию фильтра.
Информация записывается в виде одного бита: 0 означает, что ни одна строка не соответствует фильтру, тогда как 1 означает, что существует хотя бы одна соответствующая строка.
В первом случае ClickHouse может пропустить соответствующую гранулу при оценке фильтра, во втором случае гранула должна быть загружена и оценена.

Кэш условий запросов эффективен, если выполняются три предпосылки:
- Во-первых, рабочая нагрузка должна многократно оценивать одни и те же условия фильтра. Это естественно происходит, если запрос повторяется несколько раз, но также может происходить, если два запроса имеют одинаковые фильтры, например `SELECT product FROM products WHERE quality > 3` и `SELECT vendor, count() FROM products WHERE quality > 3`.
- Во-вторых, большинство данных должно быть неизменяемым, т.е. не изменяться между запросами. Это обычно так в ClickHouse, поскольку части неизменяемы и создаются только при INSERT.
- В-третьих, фильтры должны быть избирательными, т.е. условию фильтра должно удовлетворять относительно небольшое количество строк. Чем меньше строк соответствует условию фильтра, тем больше гранул будет записано с битом 0 (нет соответствующих строк), и тем больше данных можно будет "отсечь" при последующих оценках фильтра.

## Потребление памяти {#memory-consumption}

Поскольку кэш условий запросов хранит только один бит на условие фильтра и гранулу, он потребляет мало памяти.
Максимальный размер кэша условий запросов можно настроить с помощью серверной настройки [`query_condition_cache_size`](server-configuration-parameters/settings.md#query_condition_cache_size) (по умолчанию: 100 МБ).
Размер кэша в 100 МБ соответствует 100 * 1024 * 1024 * 8 = 838 860 800 записям.
Поскольку каждая запись представляет метку (по умолчанию 8192 строки), кэш может охватывать до 6 871 947 673 600 (6,8 триллиона) строк одной колонки.
На практике фильтры оцениваются более чем по одной колонке, поэтому это число нужно разделить на количество фильтруемых колонок.

## Настройки конфигурации и использование {#configuration-settings-and-usage}

Настройка [use_query_condition_cache](settings/settings#use_query_condition_cache) контролирует, должен ли конкретный запрос или все запросы текущей сессии использовать кэш условий запросов.

Например, первое выполнение запроса

```sql
SELECT col1, col2
FROM table
WHERE col1 = 'x'
SETTINGS use_query_condition_cache = true;
```

сохранит диапазоны таблицы, которые не удовлетворяют предикату.
Последующие выполнения того же запроса, также с параметром `use_query_condition_cache = true`, будут использовать кэш условий запросов для сканирования меньшего объема данных.

## Администрирование {#administration}

Кэш условий запросов не сохраняется между перезапусками ClickHouse.

Чтобы очистить кэш условий запросов, выполните [`SYSTEM DROP QUERY CONDITION CACHE`](../sql-reference/statements/system.md#drop-query-condition-cache).

Содержимое кэша отображается в системной таблице [system.query_condition_cache](system-tables/query_condition_cache.md).
Чтобы рассчитать текущий размер кэша условий запросов в МБ, выполните `SELECT formatReadableSize(sum(entry_size)) FROM system.query_condition_cache`.

Количество попаданий и промахов кэша условий запросов с момента запуска базы данных показано как события "QueryConditionCacheHits" и "QueryConditionCacheMisses" в системной таблице [system.events](system-tables/events.md).
Оба счетчика обновляются только для запросов `SELECT`, которые выполняются с настройкой `use_query_condition_cache = true`, другие запросы не влияют на "QueryCacheMisses".

## Связанный контент {#related-content}

- Блог: [Introducing the Query Condition Cache](https://clickhouse.com/blog/introducing-the-clickhouse-query-condition-cache)
- [Predicate Caching: Query-Driven Secondary Indexing for Cloud Data Warehouses (Schmidt et. al., 2024)](https://doi.org/10.1145/3626246.3653395)
