---
description: 'SAMPLE句のドキュメント'
sidebar_label: 'SAMPLE'
slug: /sql-reference/statements/select/sample
title: 'SAMPLE句'
---


# SAMPLE句

`SAMPLE`句は、近似的な`SELECT`クエリ処理を可能にします。

データサンプリングが有効になっている場合、クエリはすべてのデータではなく、特定のデータの一部（サンプル）のみで実行されます。たとえば、すべての訪問の統計を計算する必要がある場合、すべての訪問の1/10のデータでクエリを実行し、結果を10倍するだけで十分です。

近似的なクエリ処理は、以下のような場合に役立ちます。

- レイテンシ要件が厳格（100ms未満など）だが、それを満たすために追加のハードウェアリソースのコストを正当化できない場合。
- 生データが正確でないため、近似が品質を顕著に低下させない場合。
- ビジネスニーズが近似結果をターゲットにしている場合（コスト効果のため、または正確な結果をプレミアムユーザーに提供するため）。

:::note    
サンプリングは、[MergeTree](../../../engines/table-engines/mergetree-family/mergetree.md)ファミリーのテーブルでのみ使用でき、テーブル作成時にサンプリング式が指定されている場合に限ります（[MergeTreeエンジン](../../../engines/table-engines/mergetree-family/mergetree.md#table_engine-mergetree-creating-a-table)を参照）。 
:::

データサンプリングの特徴は以下の通りです。

- データサンプリングは決定論的なメカニズムです。同じ`SELECT .. SAMPLE`クエリの結果は常に同じです。
- サンプリングは異なるテーブルで一貫して機能します。単一のサンプリングキーを持つテーブルに対しては、同じ係数を持つサンプルは常に同じデータのサブセットを選択します。たとえば、ユーザーIDのサンプルは、異なるテーブルから可能なすべてのユーザーIDの同じサブセットを持つ行を取得します。つまり、[IN](../../../sql-reference/operators/in.md)句内のサブクエリでサンプルを使用することができます。また、[JOIN](../../../sql-reference/statements/select/join.md)句を使用してサンプルを結合することもできます。
- サンプリングにより、ディスクから読み取るデータ量が少なくなります。サンプリングキーを正しく指定する必要があることに注意してください。詳細については、[MergeTreeテーブルの作成](../../../engines/table-engines/mergetree-family/mergetree.md#table_engine-mergetree-creating-a-table)を参照してください。

`SAMPLE`句でサポートされている構文は以下の通りです。

| SAMPLE句構文      | 説明                                                                                                                                                                                                                                     |
|-------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `SAMPLE k`        | ここで`k`は0から1の数字です。クエリは`k`の割合のデータで実行されます。たとえば、`SAMPLE 0.1`はデータの10％でクエリを実行します。[続きを読む](#sample-k)                                                                                                                   |
| `SAMPLE n`        | ここで`n`は十分大きな整数です。クエリは少なくとも`n`行のサンプルで実行されます（ただし、これを大きく超えることはありません）。たとえば、`SAMPLE 10000000`は最小10,000,000行でクエリを実行します。[続きを読む](#sample-n)                                                                       |
| `SAMPLE k OFFSET m` | ここで`k`と`m`は0から1の数字です。クエリはデータの`k`の割合のサンプルで実行されます。サンプル用に使用されるデータは`m`の割合がオフセットされます。[続きを読む](#sample-k-offset-m)                                                                                          |


## SAMPLE K {#sample-k}

ここで`k`は0から1までの数字（分数および小数表記の両方がサポートされています）です。たとえば、`SAMPLE 1/2`または`SAMPLE 0.5`です。

`SAMPLE k`句では、データの`k`の割合からサンプルが取得されます。以下に例を示します：

```sql
SELECT
    Title,
    count() * 10 AS PageViews
FROM hits_distributed
SAMPLE 0.1
WHERE
    CounterID = 34
GROUP BY Title
ORDER BY PageViews DESC LIMIT 1000
```

この例では、クエリは10％のデータのサンプルで実行されます。集計関数の値は自動的に補正されないため、近似的な結果を得るためには、`count()`の値を手動で10倍します。

## SAMPLE N {#sample-n}

ここで`n`は十分大きな整数です。たとえば、`SAMPLE 10000000`です。

この場合、クエリは少なくとも`n`行のサンプルで実行されます（ただし、これを大きく超えることはありません）。たとえば、`SAMPLE 10000000`は最小10,000,000行でクエリを実行します。

データ読み取りの最小単位は1グラニュール（そのサイズは`index_granularity`設定によって決まります）であるため、グラニュールのサイズよりもはるかに大きなサンプルを設定することが理にかなっています。

`SAMPLE n`句を使用する場合、処理されたデータの相対パーセントがわかりません。したがって、集計関数がどの係数で乗算されるべきかもわかりません。近似的な結果を得るには、`_sample_factor`仮想カラムを使用してください。

`_sample_factor`カラムには、動的に計算される相対係数が含まれています。このカラムは、指定されたサンプリングキーを持つテーブルを[作成](../../../engines/table-engines/mergetree-family/mergetree.md#table_engine-mergetree-creating-a-table)したときに自動的に作成されます。`_sample_factor`カラムの使用例は以下に示します。

`visits`テーブルを考えてみましょう。これはサイト訪問に関する統計を含んでいます。最初の例は、ページビューの数を計算する方法を示しています：

```sql
SELECT sum(PageViews * _sample_factor)
FROM visits
SAMPLE 10000000
```

次の例は、訪問者の総数を計算する方法を示しています：

```sql
SELECT sum(_sample_factor)
FROM visits
SAMPLE 10000000
```

以下の例は、平均セッション時間を計算する方法を示しています。相対係数を平均値を計算するために使用する必要はないことに注意してください。

```sql
SELECT avg(Duration)
FROM visits
SAMPLE 10000000
```

## SAMPLE K OFFSET M {#sample-k-offset-m}

ここで`k`と`m`は0から1までの数字です。以下に例を示します。

**例1**

```sql
SAMPLE 1/10
```

この例では、サンプルはすべてのデータの1/10です：

`[++------------]`

**例2**

```sql
SAMPLE 1/10 OFFSET 1/2
```

ここでは、データの後半から10％のサンプルが取得されます。

`[------++------]`
