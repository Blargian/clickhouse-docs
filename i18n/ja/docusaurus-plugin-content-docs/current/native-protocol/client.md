---
slug: /native-protocol/client
sidebar_position: 2
---

# クライアントパケット

| 値   | 名称                | 説明                   |
|------|--------------------|------------------------|
| 0    | [こんにちは](#hello) | クライアントハンドシェイク開始 |
| 1    | [クエリ](#query)    | クエリ要求             |
| 2    | [データ](#data)     | データを含むブロック     |
| 3    | [キャンセル](#cancel) | クエリをキャンセル      |
| 4    | [ピング](#ping)     | ピング要求             |
| 5    | テーブルステータス  | テーブルステータス要求  |

`データ`は圧縮可能です。

## こんにちは {#hello}

例えば、我々は `Go Client` v1.10 で、`54451` プロトタイプバージョンをサポートし、`default` データベースに `default` ユーザーと `secret` パスワードで接続したいとします。

| フィールド          | 型      | 値                  | 説明                        |
|---------------------|---------|---------------------|-----------------------------|
| client_name         | 文字列  | `"Go Client"`       | クライアント実装名         |
| version_major       | UVarInt | `1`                 | クライアントメジャーバージョン |
| version_minor       | UVarInt | `10`                | クライアントマイナーバージョン |
| protocol_version     | UVarInt | `54451`             | TCPプロトコルバージョン    |
| database             | 文字列  | `"default"`         | データベース名              |
| username             | 文字列  | `"default"`         | ユーザー名                  |
| password             | 文字列  | `"secret"`          | パスワード                  |

### プロトコルバージョン {#protocol-version}

プロトコルバージョンはクライアントのTCPプロトコルバージョンです。

通常は、最新の互換性のあるサーバーリビジョンと等しいですが、
これと混同してはいけません。

### デフォルト {#defaults}

すべての値は**明示的に設定**する必要があり、サーバー側にデフォルトはありません。  
クライアント側では、`"default"` データベース、`"default"` ユーザー名、`""`（空文字列） をデフォルトとして使用します。

## クエリ {#query}

| フィールド         | 型                          | 値         | 説明                     |
|--------------------|----------------------------|-------------|--------------------------|
| query_id           | 文字列                     | `1ff-a123`  | クエリID、UUIDv4に可能    |
| client_info        | [ClientInfo](#client-info) | 型を参照   | クライアントに関するデータ |
| settings           | [Settings](#settings)      | 型を参照   | 設定リスト               |
| secret             | 文字列                     | `secret`    | サーバー間の秘密        |
| [stage](#stage)    | UVarInt                    | `2`         | クエリステージに到達するまで実行 |
| compression        | UVarInt                    | `0`         | 無効=0、有効=1            |
| body               | 文字列                     | `SELECT 1`  | クエリテキスト            |

### クライアント情報 {#client-info}

| フィールド         | 型            | 説明                                   |
|--------------------|---------------|----------------------------------------|
| query_kind         | バイト        | None=0, 初期=1, 二次=2                 |
| initial_user       | 文字列       | 初期ユーザー                           |
| initial_query_id   | 文字列       | 初期クエリID                          |
| initial_address    | 文字列       | 初期アドレス                           |
| initial_time       | Int64         | 初期時刻                               |
| interface          | バイト        | TCP=1, HTTP=2                          |
| os_user            | 文字列       | OSユーザー                             |
| client_hostname    | 文字列       | クライアントホスト名                   |
| client_name        | 文字列       | クライアント名                         |
| version_major      | UVarInt       | クライアントメジャーバージョン        |
| version_minor      | UVarInt       | クライアントマイナーバージョン        |
| protocol_version    | UVarInt       | クライアントプロトコルバージョン       |
| quota_key          | 文字列       | クオータキー                           |
| distributed_depth  | UVarInt       | 分散の深さ                             |
| version_patch      | UVarInt       | クライアントパッチバージョン          |
| otel               | Bool          | トレースフィールドが存在するか         |
| trace_id           | FixedString(16) | トレースID                             |
| span_id            | FixedString(8)  | スパンID                               |
| trace_state        | 文字列       | トレース状態                           |
| trace_flags        | バイト        | トレースフラグ                         |


### 設定 {#settings}

| フィールド      | 型      | 値                   | 説明                       |
|------------------|---------|---------------------|----------------------------|
| key              | 文字列  | `send_logs_level`   | 設定のキー                |
| value            | 文字列  | `trace`             | 設定の値                  |
| important        | Bool    | `true`              | 無視される可能性があるか   |

リストとしてエンコードされており、空のキーと値がリストの終わりを示します。

### ステージ {#stage}

| 値   | 名称                  | 説明                                    |
|------|---------------------|----------------------------------------|
| 0    | カラム取得           | カラムタイプのみを取得                 |
| 1    | マージ可能状態を伴う  | マージ可能状態まで                     |
| 2    | 完了                 | フルコンプリートまで（デフォルトにすべき） |

## データ {#data}

| フィールド    | 型                   | 説明                         |
|---------------|----------------------|------------------------------|
| info          | BlockInfo            | エンコードされたブロック情報 |
| columns       | UVarInt              | カラム数                     |
| rows          | UVarInt              | 行数                         |
| columns       | [[]Column](#column)  | データを含むカラム          |

### カラム {#column}

| フィールド  | 型      | 値               | 説明      |
|-------------|---------|------------------|-----------|
| name        | 文字列  | `foo`            | カラム名  |
| type        | 文字列  | `DateTime64(9)`  | カラム型  |
| data        | バイト   | ~                | カラムデータ |

## キャンセル {#cancel}

パケット本文はありません。サーバーはクエリをキャンセルする必要があります。

## ピング {#ping}

パケット本文はありません。サーバーは [ポンで応答する必要があります](./server.md#pong)。
