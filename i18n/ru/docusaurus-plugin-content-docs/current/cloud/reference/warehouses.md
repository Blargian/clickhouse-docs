---
title: 'Складские помещения'
slug: /cloud/reference/warehouses
keywords: ['разделение вычислений', 'облако', 'архитектура', 'вычисление-вчисление', 'склад', 'склады', 'гидра']
description: 'Разделение вычислений в ClickHouse Cloud'
---

import compute_1 from '@site/static/images/cloud/reference/compute-compute-1.png';
import compute_2 from '@site/static/images/cloud/reference/compute-compute-2.png';
import compute_3 from '@site/static/images/cloud/reference/compute-compute-3.png';
import compute_4 from '@site/static/images/cloud/reference/compute-compute-4.png';
import compute_5 from '@site/static/images/cloud/reference/compute-compute-5.png';
import compute_7 from '@site/static/images/cloud/reference/compute-compute-7.png';
import compute_8 from '@site/static/images/cloud/reference/compute-compute-8.png';
import Image from '@theme/IdealImage';


# Складские помещения

## Что такое разделение вычислений? {#what-is-compute-compute-separation}

Разделение вычислений доступно для уровней Scale и Enterprise.

Каждый сервис ClickHouse Cloud включает в себя:
- Требуется группа из двух или более узлов ClickHouse (или реплик), но дочерние сервисы могут быть с одной репликой.
- Конечная точка (или несколько конечных точек, созданных через консоль ClickHouse Cloud UI), которая является URL сервиса, используемого для подключения к этому сервису (например, `https://dv2fzne24g.us-east-1.aws.clickhouse.cloud:8443`).
- Папка объектного хранилища, где сервис хранит все данные и частично метаданные:

:::note
Дочерние одиночные сервисы могут масштабироваться вертикально в отличие от одиночных родительских сервисов.
:::

<Image img={compute_1} size="sm" alt="Текущий сервис в ClickHouse Cloud" background='white' />

<br />

_Рис. 1 - текущий сервис в ClickHouse Cloud_

Разделение вычислений позволяет пользователям создавать несколько групп вычислительных узлов, каждая из которых имеет свою собственную конечную точку и использует одну и ту же папку объектного хранилища, а значит, и те же таблицы, представления и т. д.

Каждая группа вычислительных узлов будет иметь свою собственную конечную точку, так что вы можете выбрать, какой набор реплик использовать для своих рабочих нагрузок. Некоторые из ваших рабочих нагрузок могут быть удовлетворены только одной небольшой репликой, а другим может потребоваться полная высокая доступность (HA) и сотни гигабайт памяти. Разделение вычислений также позволяет отделить операции чтения от операций записи, чтобы они не мешали друг другу:

<Image img={compute_2} size="md" alt="Разделение вычислений в ClickHouse Cloud" background='white' />

<br />

_Рис. 2 - разделение вычислений в ClickHouse Cloud_

В этой программе частного тестирования у вас будет возможность создавать дополнительные сервисы, которые разделяют те же данные с вашими существующими сервисами, или создать совершенно новую конфигурацию с несколькими сервисами, которые разделяют одни и те же данные.

## Что такое склад? {#what-is-a-warehouse}

В ClickHouse Cloud _склад_ — это набор сервисов, которые разделяют одни и те же данные. Каждый склад имеет основной сервис (этот сервис был создан первым) и вторичные сервисы. Например, на скриншоте ниже вы можете увидеть склад "DWH Prod" с двумя сервисами:

- Основной сервис `DWH Prod`
- Вторичный сервис `DWH Prod Subservice`

<Image img={compute_8} size="lg" alt="Пример склада с основным и вторичными сервисами" background='white' />

<br />

_Рис. 3 - пример склада_

Все сервисы в складе разделяют одно и то же:

- Регион (например, us-east1)
- Поставщик облачных услуг (AWS, GCP или Azure)
- Версия базы данных ClickHouse

Вы можете сортировать сервисы по складу, к которому они принадлежат.

## Контроль доступа {#access-controls}

### Учетные данные базы данных {#database-credentials}

Поскольку все в складе разделяют один и тот же набор таблиц, они также разделяют контроль доступа к этим другим сервисам. Это означает, что все пользователи базы данных, созданные в Сервисе 1, также смогут использовать Сервис 2 с теми же правами (разрешениями для таблиц, представлений и т. д.), и наоборот. Пользователи будут использовать другую конечную точку для каждого сервиса, но будут использовать одно и то же имя пользователя и пароль. Другими словами, _пользователи разделяются между сервисами, которые работают с одним и тем же хранилищем_:

<Image img={compute_3} size="md" alt="Доступ пользователей между сервисами, которые разделяют одни и те же данные" background='white' />

<br />

_Рис. 4 - пользователь Алиса была создана в Сервисе 1, но она может использовать те же учетные данные для доступа ко всем сервисам, которые разделяют одни и те же данные_

### Контроль сетевого доступа {#network-access-control}

Часто бывает полезно ограничить доступ к конкретным сервисам для других приложений или пользователей по запросу. Это можно сделать с помощью сетевых ограничений, аналогично тому, как это настроено для обычных сервисов (перейдите к **Настройки** на вкладке сервиса в конкретном сервисе в консоли ClickHouse Cloud).

Вы можете применить настройку фильтрации IP для каждого сервиса отдельно, что означает, что вы можете контролировать, какое приложение может получить доступ к какому сервису. Это позволяет ограничить пользователей в использовании определенных сервисов:

<Image img={compute_4} size="md" alt="Настройки сетевого контроля доступа" background='white' />

<br />

_Рис. 5 - Алиса ограничена в доступе к Сервису 2 из-за настроек сети_

### Чтение против записи {#read-vs-read-write}

Иногда бывает полезно ограничить доступ на запись к конкретному сервису и разрешить записи только подмножеству сервисов в складе. Это можно сделать при создании второго и дальнейших сервисов (первый сервис должен всегда быть с возможностью чтения-записи):

<Image img={compute_5} size="lg" alt="Сервисы чтения-записи и только чтения в складе" background='white' />

<br />

_Рис. 6 - Сервисы чтения-записи и только чтения в складе_

:::note
Сервисы только чтения в настоящее время позволяют выполнять операции управления пользователями (создание, удаление и т. д.). Это поведение может быть изменено в будущем.
:::


## Масштабирование {#scaling}

Каждый сервис в складе можно настроить по вашим рабочим нагрузкам в следующих областях:
- Количество узлов (реплик). Основной сервис (сервис, который был создан первым в складе) должен иметь 2 или более узлов. Каждый вторичный сервис может иметь 1 или более узлов.
- Размер узлов (реплик)
- Должен ли сервис масштабироваться автоматически
- Должен ли сервис быть приостановлен при бездействии (не может быть применено к первому сервису в группе - пожалуйста, смотрите раздел **Ограничения**)

## Изменения в поведении {#changes-in-behavior}
После активации разделения вычислений для сервиса (был создан хотя бы один вторичный сервис) вызов функции `clusterAllReplicas()` с именем кластера `default` будет использовать только реплики из сервиса, где он был вызван. Это означает, что если два сервиса подключены к одному набору данных, а `clusterAllReplicas(default, system, processes)` вызывается из сервиса 1, только процессы, работающие на сервисе 1, будут отображаться. Если необходимо, вы все равно можете вызвать `clusterAllReplicas('all_groups.default', system, processes)`, например, чтобы получить доступ ко всем репликам.

## Ограничения {#limitations}

Поскольку это разделение вычислений в настоящее время находится в режиме частного тестирования, есть некоторые ограничения на использование этой функции. Большинство этих ограничений будет снято, как только функция будет выпущена в GA (общую доступность):

1. **Основной сервис всегда должен быть запущен и не должен находиться в состоянии приостановки (ограничение будет снято некоторое время после GA).** В течение частного тестирования и некоторое время после GA основной сервис (обычно существующий сервис, который вы хотите расширить, добавив другие сервисы) всегда будет запущен и будет иметь отключенную настройку приостановки. Вы не сможете остановить или приостановить основной сервис, если имеется хотя бы один вторичный сервис. Как только все вторичные сервисы будут удалены, вы сможете снова остановить или приостановить оригинальный сервис.

2. **Иногда рабочие нагрузки нельзя изолировать.** Хотя цель состоит в том, чтобы предоставить вам возможность изолировать рабочие нагрузки базы данных друг от друга, могут быть крайние случаи, когда одна рабочая нагрузка в одном сервисе повлияет на другой сервис, разделяющий одни и те же данные. Эти ситуации довольно редки и в основном связаны с нагрузками, похожими на OLTP.

3. **Все сервисы с возможностью чтения-записи выполняют фоновые операции слияния.** При вставке данных в ClickHouse база данных сначала вставляет данные в некоторые временные партиции, а затем выполняет слияния в фоновом режиме. Эти слияния могут потреблять память и ресурсы CPU. Когда два сервиса с возможностью чтения-записи разделяют одно и то же хранилище, они оба выполняют фоновые операции. Это означает, что может возникнуть ситуация, когда в Сервис 1 выполняется запрос `INSERT`, но операция слияния завершается в Сервисе 2. Обратите внимание, что сервисы только чтения не выполняют фоновые слияния, поэтому не используют свои ресурсы на эту операцию.

4. **Вставки в одном сервисе с возможностью чтения-записи могут предотвратить приостановку другого сервиса с возможностью чтения-записи, если функция приостановки включена.** Из-за предыдущего пункта, второй сервис выполняет фоновые операции слияния для первого сервиса. Эти фоновые операции могут предотвратить переход второго сервиса в режим ожидания при приостановке. Как только фоновые операции завершатся, сервис будет приостановлен. Сервисы только чтения не подвергаются влиянию и будут приостановлены без задержки.

5. **Запросы CREATE/RENAME/DROP DATABASE могут по умолчанию блокироваться приостановленными/остановленными сервисами.** Эти запросы могут повиснуть. Чтобы обойти это, вы можете выполнять запросы управления базами данных с настройкой `settings distributed_ddl_task_timeout=0` на уровне сессии или запроса. Например:

```sql
create database db_test_ddl_single_query_setting
settings distributed_ddl_task_timeout=0
```

6. **В очень редких случаях вторичные сервисы, которые приостановлены или остановлены на длительный срок (дни) без пробуждения/запуска могут вызывать ухудшение производительности других сервисов в том же складе.** Эта проблема будет решена в ближайшее время и связана с мутациями, выполняемыми в фоновом режиме. Если вы считаете, что сталкиваетесь с этой проблемой, пожалуйста, свяжитесь с [Поддержкой](https://clickhouse.com/support/program) ClickHouse.

7. **В настоящее время существует мягкое ограничение в 5 сервисов на склад.** Свяжитесь с командой поддержки, если вам нужно более 5 сервисов в одном складе.


## Цены {#pricing}

Дополнительные сервисы, созданные во время частного тестирования, выставляются на оплату как обычно. Цены на вычисления одинаковы для всех сервисов в складе (основных и вторичных). Хранение выставляется на оплату только один раз - оно включено в первый (оригинальный) сервис.

## Резервные копии {#backups}

- Поскольку все сервисы в одном складе разделяют одно и то же хранилище, резервные копии делаются только на основном (инициальном) сервисе. Таким образом, данные для всех сервисов в складе резервируются.
- Если вы восстанавливаете резервную копию из основного сервиса склада, она будет восстановлена в совершенно новый сервис, который не связан с существующим складом. Затем вы можете сразу добавить больше сервисов к новому сервису после завершения восстановления.

## Использование складов {#using-warehouses}

### Создание склада {#creating-a-warehouse}

Для создания склада вам нужно создать второй сервис, который будет разделять данные с существующим сервисом. Это можно сделать, нажав на знак «плюс» на любом из существующих сервисов:

<Image img={compute_7} size="md" alt="Создание нового сервиса в складе" border background='white' />

<br />

_Рис. 7 - Нажмите на знак «плюс» для создания нового сервиса в складе_

На экране создания сервиса оригинальный сервис будет выбран в дропдауне как источник для данных нового сервиса. После создания эти два сервиса образуют склад.

### Переименование склада {#renaming-a-warehouse}

Существует два способа переименовать склад:

- Вы можете выбрать "Сортировать по складу" на странице сервисов в правом верхнем углу, а затем нажать на иконку карандаша рядом с именем склада
- Вы можете нажать на имя склада на любом из сервисов и переименовать склад там

### Удаление склада {#deleting-a-warehouse}

Удаление склада означает удаление всех вычислительных сервисов и данных (таблицы, представления, пользователи и т. д.). Это действие нельзя отменить. Вы можете удалить склад только, удалив первый созданный сервис. Для этого:

1. Удалите все сервисы, которые были созданы вдобавок к первому сервису;
2. Удалите первый сервис (внимание: все данные склада будут удалены на этом этапе).
