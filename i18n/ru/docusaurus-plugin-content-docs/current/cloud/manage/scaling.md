---
sidebar_position: 1
sidebar_label: 'Автоматическое Масштабирование'
slug: /manage/scaling
description: 'Настройка автоматического масштабирования в ClickHouse Cloud'
keywords: ['автомасштабирование', 'авто масштабирование', 'масштабирование', 'горизонтальное', 'вертикальное', 'пик']
title: 'Автоматическое Масштабирование'
---

import Image from '@theme/IdealImage';
import auto_scaling from '@site/static/images/cloud/manage/AutoScaling.png';
import scaling_patch_request from '@site/static/images/cloud/manage/scaling-patch-request.png';
import scaling_patch_response from '@site/static/images/cloud/manage/scaling-patch-response.png';
import scaling_configure from '@site/static/images/cloud/manage/scaling-configure.png';
import scaling_memory_allocation from '@site/static/images/cloud/manage/scaling-memory-allocation.png';
import ScalePlanFeatureBadge from '@theme/badges/ScalePlanFeatureBadge'


# Автоматическое Масштабирование

Масштабирование — это возможность адаптировать доступные ресурсы для удовлетворения потребностей клиентов. Услуги уровней Scale и Enterprise (с стандартным профилем 1:4) могут масштабироваться горизонтально с помощью программного вызова API или изменения настроек в пользовательском интерфейсе для регулировки системных ресурсов. В качестве альтернативы, эти услуги могут быть **автоматически масштабированы** вертикально для удовлетворения требований приложений.

<ScalePlanFeatureBadge feature="Автоматическое вертикальное масштабирование"/>

## Как работает масштабирование в ClickHouse Cloud {#how-scaling-works-in-clickhouse-cloud}

В настоящее время ClickHouse Cloud поддерживает вертикальное автоматическое масштабирование и ручное горизонтальное масштабирование для услуг уровня Scale.

Для услуг уровня Enterprise масштабирование работает следующим образом:

- **Горизонтальное масштабирование**: Ручное горизонтальное масштабирование будет доступно для всех стандартных и пользовательских профилей на уровне Enterprise.
- **Вертикальное масштабирование**:
  - Стандартные профили (1:4) будут поддерживать вертикальное автоматическое масштабирование.
  - Пользовательские профили не будут поддерживать вертикальное автоматическое масштабирование или ручное вертикальное масштабирование при запуске. Тем не менее, эти услуги могут быть масштабированы вертикально, обратившись в службу поддержки.

:::note
Мы вводим новый механизм вертикального масштабирования для вычислительных реплик, который мы называем "Сделать перед Устранением" (MBB). Этот подход добавляет одну или несколько реплик нового размера перед удалением старых реплик, предотвращая потерю мощности в процессе операций масштабирования. Устранение разрыва между удалением существующих реплик и добавлением новых делает процесс масштабирования более плавным и менее разрушительным. Это особенно полезно в сценариях масштабирования вверх, где высокая загрузка ресурсов требует дополнительной мощности, поскольку преждевременное удаление реплик только усугубит ограниченность ресурсов.

Обратите внимание, что в рамках этого изменения исторические данные системных таблиц будут храниться в течение максимум 30 дней в рамках событий масштабирования. Кроме того, любые данные системных таблиц старше 19 декабря 2024 года для услуг на AWS или GCP и старше 14 января 2025 года для услуг на Azure не будут сохранены в процессе миграции на новые уровни организации.
:::

### Вертикальное автоматическое масштабирование {#vertical-auto-scaling}

<ScalePlanFeatureBadge feature="Автоматическое вертикальное масштабирование"/>

Услуги Scale и Enterprise поддерживают автоматическое масштабирование на основе использования CPU и памяти. Мы постоянно отслеживаем историческое использование услуги в течение окна просмотра (за последние 30 часов) для принятия решений о масштабировании. Если использование превышает или падает ниже определенных порогов, мы соответственно масштабируем услугу, чтобы соответствовать спросу.

Автоматическое масштабирование на основе CPU начинает действовать, когда использование CPU пересекает верхний порог в пределах от 50% до 75% (фактический порог зависит от размера кластера). В этот момент выделение CPU для кластера удваивается. Если использование CPU падает ниже половины верхнего порога (например, до 25% при верхнем пороге 50%), выделение CPU уменьшается вдвое.

Автоматическое масштабирование на основе памяти масштабирует кластер до 125% от максимального использования памяти или до 150%, если возникают ошибки OOM (недостаточно памяти).

Выбирается **большее** из рекомендаций по CPU или памяти, и CPU и память, выделяемые для услуги, масштабируются синхронными увеличениями по `1` CPU и `4 GiB` памяти.

### Настройка вертикального автоматического масштабирования {#configuring-vertical-auto-scaling}

Масштабирование услуг ClickHouse Cloud Scale или Enterprise может быть изменено членами организации с ролью **Admin**. Чтобы настроить вертикальное автоматическое масштабирование, перейдите на вкладку **Настройки** для вашей услуги и измените минимальные и максимальные значения памяти, а также настройки CPU, как показано ниже.

:::note
Услуги с одной репликой не могут масштабироваться для всех уровней.
:::

<Image img={auto_scaling} size="lg" alt="Страница настроек масштабирования" border/>

Установите **Максимальную память** для ваших реплик на более высокое значение, чем **Минимальная память**. Тогда услуга будет масштабироваться по мере необходимости в пределах этих границ. Эти настройки также доступны во время первоначального создания услуги. Каждой реплике в вашей услуге будет выделено одинаковое количество ресурсов памяти и CPU.

Вы также можете выбрать установку этих значений одинаковыми, фактически "прикрепляя" услугу к определенной конфигурации. Это немедленно заставит масштабироваться до желаемого размера, который вы выбрали.

Важно отметить, что это отключит любое автоматическое масштабирование на кластере, и ваша услуга не будет защищена от увеличения использования CPU или памяти за пределами этих настроек.

:::note
Для услуг уровня Enterprise стандартные профили 1:4 будут поддерживать вертикальное автоматическое масштабирование.
Пользовательские профили не будут поддерживать вертикальное автоматическое масштабирование или ручное вертикальное масштабирование при запуске.
Тем не менее, эти услуги могут быть масштабированы вертикально, обратившись в службу поддержки.
:::

## Ручное горизонтальное масштабирование {#manual-horizontal-scaling}

<ScalePlanFeatureBadge feature="Ручное горизонтальное масштабирование"/>

Вы можете использовать [публичные API ClickHouse Cloud](https://clickhouse.com/docs/cloud/manage/api/swagger#/paths/~1v1~1organizations~1:organizationId~1services~1:serviceId~1scaling/patch) для масштабирования вашей услуги, обновив настройки масштабирования для услуги или изменив количество реплик из облачной консоли.

Услуги уровней **Scale** и **Enterprise** поддерживают услуги с одной репликой. Однако услуга в этих уровнях, которая начинается с нескольких реплик или расширяется до нескольких реплик, может быть уменьшена до минимума `2` реплик.

:::note
Услуги могут масштабироваться горизонтально до максимума 20 реплик. Если вам нужно больше реплик, пожалуйста, свяжитесь с нашей службой поддержки.
:::

### Горизонтальное масштабирование через API {#horizontal-scaling-via-api}

Чтобы горизонтально масштабировать кластер, выполните запрос `PATCH` через API, чтобы изменить количество реплик. Скриншоты ниже показывают вызов API для увеличения кластера из `3` реплик до `6` реплик и соответствующий ответ.

<Image img={scaling_patch_request} size="lg" alt="Запрос PATCH для масштабирования" border/>

*Запрос `PATCH` для обновления `numReplicas`*

<Image img={scaling_patch_response} size="md" alt="Ответ на запрос PATCH" border/>

*Ответ на запрос `PATCH`*

Если вы выполните новый запрос масштабирования или несколько запросов подряд, в то время как один уже выполняется, служба масштабирования проигнорирует промежуточные состояния и свяжется с окончательным количеством реплик.

### Горизонтальное масштабирование через UI {#horizontal-scaling-via-ui}

Чтобы масштабировать услугу горизонтально из пользовательского интерфейса, вы можете изменить количество реплик для услуги на странице **Настройки**.

<Image img={scaling_configure} size="md" alt="Настройки конфигурации масштабирования" border/>

*Настройки масштабирования услуги из консоли ClickHouse Cloud*

Как только услуга масштабируется, панель мониторинга метрик в облачной консоли должна показать правильное распределение для услуги. Скриншот ниже показывает, что кластер масштабировался до общей памяти `96 GiB`, что соответствует `6` репликам, каждая с выделением `16 GiB` памяти.

<Image img={scaling_memory_allocation} size="md" alt="Распределение памяти при масштабировании" border />

## Автоматическое отключение {#automatic-idling}
На странице **Настройки** вы также можете выбрать, разрешить ли автоматическое отключение вашей услуги, когда она неактивна, как показано на изображении выше (т.е. когда услуга не выполняет никаких запросов, отправленных пользователем). Автоматическое отключение снижает стоимость вашей услуги, поскольку вы не будете оплачивать вычислительные ресурсы, когда услуга приостановлена.

:::note
В некоторых особых случаях, например, когда у услуги много частей, услуга не будет автоматически отключена.

Услуга может перейти в состояние простоя, где она приостанавливает обновление [обновляемых материализованных представлений](/materialized-view/refreshable-materialized-view), потребление из [S3Queue](/engines/table-engines/integrations/s3queue) и планирование новых слияний. Существующие операции слияния завершатся до того, как услуга перейдет в состояние простоя. Чтобы обеспечить непрерывную работу обновляемых материализованных представлений и потребления S3Queue, отключите функциональность состояния простоя.
:::

:::danger Когда не использовать автоматическое отключение
Используйте автоматическое отключение только в том случае, если ваш случай использования может выдержать задержку перед реагированием на запросы, поскольку когда услуга приостановлена, соединения с услугой будут истекать. Автоматическое отключение идеально подходит для услуг, которые используются редко и где задержка может быть принята. Это не рекомендуется для услуг, которые обеспечивают функции, ориентированные на клиентов, которые используются часто.
:::

## Обработка пиковых нагрузок {#handling-bursty-workloads}
Если у вас ожидается предстоящий пик нагрузки, вы можете использовать
[API ClickHouse Cloud](/cloud/manage/api/services-api-reference.md), чтобы заранее увеличить масштаб вашей услуги для обработки пика и уменьшить его, как только спрос снизится. Чтобы понять текущее количество CPU и памяти, используемой для каждой из ваших реплик, вы можете выполнить следующий запрос:

```sql
SELECT *
FROM clusterAllReplicas('default', view(
    SELECT
        hostname() AS server,
        anyIf(value, metric = 'CGroupMaxCPU') AS cpu_cores,
        formatReadableSize(anyIf(value, metric = 'CGroupMemoryTotal')) AS memory
    FROM system.asynchronous_metrics
))
ORDER BY server ASC
SETTINGS skip_unavailable_shards = 1
```

