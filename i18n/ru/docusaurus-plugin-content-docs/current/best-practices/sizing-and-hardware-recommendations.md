---
slug: /guides/sizing-and-hardware-recommendations
sidebar_label: 'Рекомендации по масштабированию и аппаратному обеспечению'
sidebar_position: 4
title: 'Рекомендации по масштабированию и аппаратному обеспечению'
description: 'В этом руководстве обсуждаются наши общие рекомендации по аппаратному обеспечению, вычислениям, памяти и конфигурациям дисков для пользователей с открытым исходным кодом.'
---


# Рекомендации по масштабированию и аппаратному обеспечению

В этом руководстве обсуждаются наши общие рекомендации по аппаратному обеспечению, вычислениям, памяти и конфигурациям дисков для пользователей с открытым исходным кодом. Если вы хотите упростить свою настройку, мы рекомендуем использовать [ClickHouse Cloud](https://clickhouse.com/cloud), так как он автоматически масштабируется и адаптируется к вашим рабочим нагрузкам, минимизируя затраты на управление инфраструктурой.

Конфигурация вашего кластера ClickHouse в значительной степени зависит от случая использования вашего приложения и паттернов рабочей нагрузки. При планировании вашей архитектуры необходимо учитывать следующие факторы:

- Одновременность (запросы в секунду)
- Пропускная способность (строки, обработанные за секунду)
- Объем данных
- Политика хранения данных
- Затраты на оборудование
- Затраты на обслуживание

## Диск {#disk}

Тип(-ы) дисков, которые вы должны использовать с ClickHouse, зависит от объема данных, требований к задержке или пропускной способности.

### Оптимизация для производительности {#optimizing-for-performance}

Для максимизации производительности мы рекомендуем напрямую подключать [SSD-накопители с заданной IOPS от AWS](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/provisioned-iops.html) или аналогичное предложение от вашего облачного провайдера, которое оптимизировано для ввода-вывода.

### Оптимизация для снижения затрат на хранение {#optimizing-for-storage-costs}

Для снижения затрат вы можете использовать [SSD EBS накопители общего назначения](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/general-purpose.html).

Вы также можете реализовать многоуровневое хранилище, используя SSD и HDD в [архитектуре горячее/теплое/холодное](/guides/developer/ttl#implementing-a-hotwarmcold-architecture). В качестве альтернативы, для хранения также возможен [AWS S3](https://aws.amazon.com/s3/), который позволяет разделить вычисления и хранение. Пожалуйста, ознакомьтесь с нашим руководством по использованию открытого ClickHouse с разделением вычислений и хранения [здесь](/guides/separation-storage-compute). Разделение вычислений и хранения доступно по умолчанию в ClickHouse Cloud.

## CPU {#cpu}

### Какой CPU мне следует использовать? {#which-cpu-should-i-use}

Тип CPU, который вы должны использовать, зависит от вашего паттерна использования. В общем случае, однако, приложения с большим количеством частых одновременных запросов, которые обрабатывают больше данных или используют ресурсоемкие пользовательские функции (UDF), будут требовать больше ядер CPU.

**Приложения с низкой задержкой или ориентированные на клиентов**

Для требований к задержке в десятках миллисекунд, таких как рабочие нагрузки, ориентированные на клиентов, мы рекомендуем линии EC2 [i3](https://aws.amazon.com/ec2/instance-types/i3/) или [i4i](https://aws.amazon.com/ec2/instance-types/i4i/) от AWS или аналогичные предложения от вашего облачного провайдера, которые оптимизированы для ввода-вывода.

**Приложения с высокой одновременностью**

Для рабочих нагрузок, которым необходимо оптимизировать одновременность (100+ запросов в секунду), мы рекомендуем [серии C, оптимизированные для вычислений](https://aws.amazon.com/ec2/instance-types/#Compute_Optimized) от AWS или аналогичное предложение от вашего облачного провайдера.

**Случай использования хранилища данных**

Для рабочих нагрузок по хранению данных и ад-хок аналитических запросов мы рекомендуем [серии R](https://aws.amazon.com/ec2/instance-types/#Memory_Optimized) от AWS или аналогичное предложение от вашего облачного провайдера, так как они оптимизированы по памяти.

---

### Каковы должны быть использование CPU? {#what-should-cpu-utilization-be}

Нет стандартной целевой нагрузки CPU для ClickHouse. Используйте инструмент, такой как [iostat](https://linux.die.net/man/1/iostat), чтобы измерить среднее использование CPU, и соответственно регулируйте размер ваших серверов, чтобы управлять неожиданными всплесками трафика. Однако для аналитических или хранилищных случаев использования с ад-хок запросами вы должны нацеливаться на 10-20% загрузки CPU.

### Сколько ядер CPU мне следует использовать? {#how-many-cpu-cores-should-i-use}

Количество CPU, которые вам следует использовать, зависит от вашей рабочей нагрузки. Однако мы обычно рекомендуем следующие соотношения памяти к ядрам CPU на основе типа вашего CPU:

- **[M-type](https://aws.amazon.com/ec2/instance-types/) (общие случаи использования):** 4:1 соотношение памяти к ядру CPU
- **[R-type](https://aws.amazon.com/ec2/instance-types/#Memory_Optimized) (случаи использования хранилища данных):** 8:1 соотношение памяти к ядру CPU
- **[C-type](https://aws.amazon.com/ec2/instance-types/#Compute_Optimized) (оптимизированные для вычислений):** 2:1 соотношение памяти к ядру CPU

Например, при использовании M-type CPU мы рекомендуем выделять 100 ГБ памяти на каждые 25 ядер CPU. Чтобы определить необходимое количество памяти для вашего приложения, необходимо профилировать использование памяти. Вы можете прочитать [это руководство по отладке проблем с памятью](/guides/developer/debugging-memory-issues) или использовать [встроенную панель мониторинга](https://clickhouse.com/operations/monitoring), чтобы отслеживать ClickHouse.

## Память {#memory}

Как и выбор CPU, выбор соотношения памяти к хранилищу и памяти к CPU зависит от вашего случая использования.

Необходимый объем ОЗУ обычно зависит от:
- Сложности запросов.
- Объема данных, которые обрабатываются в запросах.

Однако в общем случае, чем больше памяти у вас есть, тем быстрее будут выполняться ваши запросы. 
Если ваш случай использования чувствителен к цене, меньшие объемы памяти будут приемлемы, так как можно активировать настройки ([`max_bytes_before_external_group_by`](/operations/settings/settings#max_bytes_before_external_group_by) и [`max_bytes_before_external_sort`](/operations/settings/settings#max_bytes_before_external_sort)), которые позволяют сбрасывать данные на диск, но учтите, что это может значительно повлиять на производительность запросов.

### Каково должно быть соотношение памяти к хранилищу? {#what-should-the-memory-to-storage-ratio-be}

Для небольших объемов данных приемлемо соотношение 1:1 по памяти к хранилищу, но общая память не должна быть ниже 8 ГБ.

Для случаев использования с длительными сроками хранения ваших данных или с большими объемами данных мы рекомендуем соотношение 1:100 до 1:130 по памяти к хранилищу. Например, 100 ГБ ОЗУ на реплику, если вы храните 10 ТБ данных.

Для случаев использования с частым доступом, таких как рабочие нагрузки, ориентированные на клиентов, мы рекомендуем использовать больше памяти с соотношением 1:30 до 1:50 по памяти к хранилищу.

## Реплики {#replicas}

Мы рекомендуем иметь как минимум три реплики на шард (или две реплики с [Amazon EBS](https://aws.amazon.com/ebs/)). Кроме того, мы рекомендуем вертикально масштабировать все реплики перед добавлением дополнительных реплик (горизонтальное масштабирование).

ClickHouse не выполняет автоматическое шардирование, и повторное шардирование вашего набора данных потребует значительных вычислительных ресурсов. Поэтому мы обычно рекомендуем использовать самый мощный сервер, доступный, чтобы предотвратить необходимость повторного шардирования ваших данных в будущем.

Рассмотрите возможность использования [ClickHouse Cloud](https://clickhouse.com/cloud), который автоматически масштабируется и позволяет вам легко управлять количеством реплик для вашего случая использования.

## Примеры конфигураций для больших рабочих нагрузок {#example-configurations-for-large-workloads}

Конфигурации ClickHouse в значительной степени зависят от требований вашего конкретного приложения. Пожалуйста, [свяжитесь с отделом продаж](https://clickhouse.com/company/contact?loc=docs-sizing-and-hardware-recommendations), если вы хотите, чтобы мы помогли оптимизировать вашу архитектуру для снижения затрат и повышения производительности.

Чтобы предоставить рекомендации (не предложения), приведены примеры конфигураций пользователей ClickHouse в производственной среде:

### Fortune 500 B2B SaaS {#fortune-500-b2b-saas}

<table>
    <tr>
        <td col="2"><strong><em>Хранение</em></strong></td>
    </tr>
    <tr>
        <td><strong>Ежемесячный объем новых данных</strong></td>
        <td>30TB</td>
    </tr>
    <tr>
        <td><strong>Общий объем хранения (сжатый)</strong></td>
        <td>540TB</td>
    </tr>
    <tr>
        <td><strong>Политика хранения данных</strong></td>
        <td>18 месяцев</td>
    </tr>
    <tr>
        <td><strong>Диск на узел</strong></td>
        <td>25TB</td>
    </tr>
    <tr>
        <td col="2"><strong><em>CPU</em></strong></td>
    </tr>
    <tr>
        <td><strong>Одновременность</strong></td>
        <td>200+ одновременных запросов</td>
    </tr>
    <tr>
        <td><strong>Количество реплик (включая HA пару)</strong></td>
        <td>44</td>
    </tr>
    <tr>
        <td><strong>vCPU на узел</strong></td>
        <td>62</td>
    </tr>
    <tr>
        <td><strong>Всего vCPU</strong></td>
        <td>2700</td>
    </tr>
    <tr>
        <td col="2"><strong><em>Память</em></strong></td>
    </tr>
    <tr>
        <td><strong>Всего ОЗУ</strong></td>
        <td>11TB</td>
    </tr>
    <tr>
        <td><strong>ОЗУ на реплику</strong></td>
        <td>256GB</td>
    </tr>
    <tr>
        <td><strong>Соотношение ОЗУ к vCPU</strong></td>
        <td>4:1</td>
    </tr>
    <tr>
        <td><strong>Соотношение ОЗУ к диску</strong></td>
        <td>1:50</td>
    </tr>
</table>

### Fortune 500 Оператор связи для использования журналов {#fortune-500-telecom-operator-for-a-logging-use-case}

<table>
    <tr>
        <td col="2"><strong><em>Хранение</em></strong></td>
    </tr>
    <tr>
        <td><strong>Ежемесячный объем данных журналов</strong></td>
        <td>4860TB</td>
    </tr>
    <tr>
        <td><strong>Общий объем хранения (сжатый)</strong></td>
        <td>608TB</td>
    </tr>
    <tr>
        <td><strong>Политика хранения данных</strong></td>
        <td>30 дней</td>
    </tr>
    <tr>
        <td><strong>Диск на узел</strong></td>
        <td>13TB</td>
    </tr>
    <tr>
        <td col="2"><strong><em>CPU</em></strong></td>
    </tr>
    <tr>
        <td><strong>Количество реплик (включая HA пару)</strong></td>
        <td>38</td>
    </tr>
    <tr>
        <td><strong>vCPU на узел</strong></td>
        <td>42</td>
    </tr>
    <tr>
        <td><strong>Всего vCPU</strong></td>
        <td>1600</td>
    </tr>
    <tr>
        <td col="2"><strong><em>Память</em></strong></td>
    </tr>
    <tr>
        <td><strong>Всего ОЗУ</strong></td>
        <td>10TB</td>
    </tr>
    <tr>
        <td><strong>ОЗУ на реплику</strong></td>
        <td>256GB</td>
    </tr>
    <tr>
        <td><strong>Соотношение ОЗУ к vCPU</strong></td>
        <td>6:1</td>
    </tr>
    <tr>
        <td><strong>Соотношение ОЗУ к диску</strong></td>
        <td>1:60</td>
    </tr>
</table>

## Дальнейшее чтение {#further-reading}

Ниже приведены опубликованные блоги о архитектуре от компаний, использующих открытый ClickHouse:

- [Cloudflare](https://blog.cloudflare.com/http-analytics-for-6m-requests-per-second-using-clickhouse/?utm_source=linkedin&utm_medium=social&utm_campaign=blog)
- [eBay](https://innovation.ebayinc.com/tech/engineering/ou-online-analytical-processing/)
- [GitLab](https://handbook.gitlab.com/handbook/engineering/development/ops/monitor/observability/#clickhouse-datastore)
- [Lyft](https://eng.lyft.com/druid-deprecation-and-clickhouse-adoption-at-lyft-120af37651fd)
- [MessageBird](https://clickhouse.com/blog/how-messagebird-uses-clickhouse-to-monitor-the-delivery-of-billions-of-messages)
- [Microsoft](https://clickhouse.com/blog/self-service-data-analytics-for-microsofts-biggest-web-properties)
- [Uber](https://www.uber.com/en-ES/blog/logging/)
- [Zomato](https://blog.zomato.com/building-a-cost-effective-logging-platform-using-clickhouse-for-petabyte-scale)

