---
title: ウェアハウス
slug: /cloud/reference/warehouses
keywords: [compute separation, cloud, architecture, compute-compute, warehouse, warehouses, hydra]
description: ClickHouse Cloudにおけるコンピュート-コンピュート分離
---

import COMPUTE1 from '@site/static/images/cloud/reference/compute-compute-1.png';
import COMPUTE2 from '@site/static/images/cloud/reference/compute-compute-2.png';
import COMPUTE3 from '@site/static/images/cloud/reference/compute-compute-3.png';
import COMPUTE4 from '@site/static/images/cloud/reference/compute-compute-4.png';
import COMPUTE5 from '@site/static/images/cloud/reference/compute-compute-5.png';
import COMPUTE7 from '@site/static/images/cloud/reference/compute-compute-7.png';
import COMPUTE8 from '@site/static/images/cloud/reference/compute-compute-8.png';

# ウェアハウス
## コンピュート-コンピュート分離とは何ですか？ {#what-is-compute-compute-separation}

コンピュート-コンピュート分離は、スケールとエンタープライズのティアで利用可能です。

各ClickHouse Cloudサービスには以下が含まれます：
- 2つ以上のClickHouseノード（またはレプリカ）のグループが必要ですが、子サービスは単一レプリカでも構いません。
- サービスに接続するために使用するエンドポイント（またはClickHouse Cloud UIコンソールを介して作成された複数のエンドポイント）、これはサービスのURLです（例えば、 `https://dv2fzne24g.us-east-1.aws.clickhouse.cloud:8443`）。
- サービスがすべてのデータおよび部分的なメタデータを保存するオブジェクトストレージフォルダー：

:::note
子サービスは、単一の親サービスとは異なり、垂直スケールが可能です。
:::

<br />

<img src={COMPUTE1}
    alt='NEEDS ALT'
    class='image'
    style={{width: '200px'}}
/>

<br />

_図1 - ClickHouse Cloudの現在のサービス_

コンピュート-コンピュート分離は、ユーザーが同じオブジェクトストレージフォルダーを使用している各々のエンドポイントを持つ複数のコンピュートノードグループを作成できるようにします。したがって、同じテーブルやビューなどが使用されます。

各コンピュートノードグループには独自のエンドポイントがあるため、ワークロードに使用するレプリカのセットを選択できます。ワークロードのいくつかは、小さなサイズの単一レプリカのみで満たされるかもしれませんし、他は完全な高可用性（HA）と数百ギガバイトのメモリが必要かもしれません。コンピュート-コンピュート分離は、読み取り操作と書き込み操作を分離し、お互いに干渉しないようにすることも可能にします：

<br />

<img src={COMPUTE2}
    alt='NEEDS ALT'
    class='image'
    style={{width: '500px'}}
/>

<br />

_図2 - ClickHouse Cloudのコンピュート_

このプライベートプレビュープログラムでは、既存のサービスとデータを共有する追加サービスを作成するか、完全に新しいセットアップを作成する実力を持っています。
## ウェアハウスとは何ですか？ {#what-is-a-warehouse}

ClickHouse Cloudにおける _ウェアハウス_ は、同じデータを共有するサービスのセットです。
各ウェアハウスには、主要なサービス（このサービスが最初に作成されたもの）と副次的なサービスがあります。例えば、以下のスクリーンショットでは「DWH Prod」というウェアハウスが2つのサービスを持っています：

- 主要なサービス `DWH Prod`
- 副次的なサービス `DWH Prod Subservice`

<br />

<img src={COMPUTE8}
    alt='NEEDS ALT'
    class='image'
    style={{width: '800px'}}
/>

<br />

_図3 - ウェアハウスの例_

ウェアハウス内のすべてのサービスは以下を共有します：

- リージョン（例えば、us-east1）
- クラウドサービスプロバイダー（AWS、GCP、またはAzure）
- ClickHouseデータベースバージョン

サービスは所属するウェアハウスによってソートできます。
## アクセス制御 {#access-controls}
### データベース資格情報 {#database-credentials}

ウェアハウス内のすべては同じテーブルセットを共有するため、他のサービスへのアクセス制御も共有されます。これは、サービス1で作成されたすべてのデータベースユーザーが、サービス2を同じ権限で使えることを意味します（テーブル、ビューなどのグラント）。ユーザーは各サービスごとに別のエンドポイントを使用しますが、同じユーザー名とパスワードを使用します。言い換えれば、_ユーザーは同じストレージで動作するサービス間で共有されます：_

<br />

<img src={COMPUTE3}
    alt='NEEDS ALT'
    class='image'
    style={{width: '500px'}}
/>

<br />

_図4 - ユーザーAliceはサービス1で作成されましたが、同じ資格情報を使って同じデータを共有するすべてのサービスにアクセスできます_
### ネットワークアクセス制御 {#network-access-control}

特定のサービスが他のアプリケーションやアドホックユーザーに使用されないように制限することはしばしば有用です。これは、現在の通常のサービスに対して設定されているのと同様のネットワーク制限を使用することで行えます（ClickHouse Cloudコンソールの特定のサービスのサービスタブで**設定**に移動）。

各サービスにはIPフィルタリング設定を個別に適用できるため、どのアプリケーションがどのサービスにアクセスできるかを制御できます。これにより、特定のサービスの使用を制限できます：

<br />

<img src={COMPUTE4}
    alt='NEEDS ALT'
    class='image'
    style={{width: '400px'}}
/>

<br />

_図5 - ネットワーク設定のためAliceはサービス2へのアクセスが制限されています_
### 読み取り対読み書き {#read-vs-read-write}

特定のサービスへの書き込みアクセスを制限し、ウェアハウス内のサービスのサブセットのみが書き込みを許可されるようにすることは時々有用です。これは、二次サービスおよびそれ以降のサービスを作成するときに実行できます（最初のサービスは常に読み書き可能である必要があります）：

<br />

<img src={COMPUTE5}
    alt='NEEDS ALT'
    class='image'
    style={{width: '400px'}}
/>

<br />

_図6 - ウェアハウス内の読み書きサービスと読み取り専用サービス_

:::note
読み取り専用サービスは現在、ユーザー管理操作（作成、削除など）を許可しています。この動作は今後変更される可能性があります。
:::
## スケーリング {#scaling}

ウェアハウス内の各サービスは、以下の点でワークロードに合わせて調整できます：
- ノード数（レプリカ）。主要サービス（ウェアハウス内で最初に作成されたサービス）は2つ以上のノードを持つ必要があります。各副次サービスは1つ以上のノードを持つことができます。
- ノード（レプリカ）のサイズ
- サービスが自動的にスケールすべきか
- サービスが非活動時にアイドル状態にすべきか（グループ内の最初のサービスに適用できません - **制限事項**セクションを参照してください）
## 挙動の変更 {#changes-in-behavior}
コンピュート-コンピュートがサービスに対して有効化されると（少なくとも1つの副次サービスが作成される）、`clusterAllReplicas()`関数呼び出しは、呼び出されたサービスのレプリカのみを利用します。つまり、同じデータセットに接続された2つのサービスがあり、サービス1から`clusterAllReplicas(default, system, processes)`が呼び出されると、サービス1で実行されているプロセスのみが表示されます。必要に応じて、`clusterAllReplicas('all_groups.default', system, processes)`を呼び出してすべてのレプリカにアクセスすることもできます。
## 制限事項 {#limitations}

このコンピュート-コンピュート分離は現在プライベートプレビュー中であるため、この機能の使用にはいくつかの制限があります。これらの制限のほとんどは、機能がGA（一般提供）にリリースされると解消されます：

1. **主要サービスは常に稼働している必要があり、アイドル状態にはできません（GAの後しばらくしてからこの制限は解除されます）。** プライベートプレビュー中およびGAの後のしばらくの間、主要サービス（通常はその他のサービスを追加して拡張したい既存のサービス）は常に稼働しており、アイドル設定は無効になります。少なくとも1つの副次サービスがある場合、主要サービスを停止またはアイドルにすることはできません。すべての副次サービスが削除されると、再び元のサービスを停止またはアイドルにできます。

2. **ワークロードを分離できない場合があります。** データベースのワークロードを互いに分離するオプションを提供することが目標ですが、あるサービス内の1つのワークロードが同じデータを共有する別のサービスに影響を与える場合がある限界事例があります。これらはかなりまれな状況で、主にOLTPのようなワークロードに関連しています。

3. **すべての読み書きサービスがバックグラウンドでマージ操作を行っています。** ClickHouseにデータを挿入すると、データベースは最初に一部のステージングパーティションにデータを挿入し、その後バックグラウンドでマージを行います。これらのマージはメモリおよびCPUリソースを消費する可能性があります。2つの読み書きサービスが同じストレージを共有していると、両方がバックグラウンド操作を行っていることになります。つまり、サービス1で`INSERT`クエリが存在している場合でも、マージ操作はサービス2によって完了します。読み取り専用サービスはバックグラウンドでマージを実行しないため、この操作にリソースを費やすことはありません。

4. **1つの読み書きサービスへの挿入が、アイドル状態が有効な場合には他の読み書きサービスのアイドルを妨げる可能性があります。** 前のポイントのため、2番目のサービスが最初のサービスのためにバックグラウンドでマージ操作を行います。これらのバックグラウンド操作は、アイドル状態にする際に2番目のサービスがスリープに入るのを妨げる可能性があります。バックグラウンド操作が完了すると、そのサービスはアイドル状態になります。読み取り専用サービスは影響を受けず、遅延なくアイドル状態になります。

5. **CREATE/RENAME/DROP DATABASEクエリは、デフォルトでアイドルまたは停止されたサービスによってブロックされる可能性があります。** これらのクエリがハングする可能性があります。これを回避するために、`settings distributed_ddl_task_timeout=0`を使用してデータベース管理クエリをセッションまたはクエリレベルで実行することができます。例えば：

```sql
create database db_test_ddl_single_query_setting
settings distributed_ddl_task_timeout=0
```

6. **非常にまれなケースでは、長期間（数日）アイドルまたは停止した副次サービスが他のサービスのパフォーマンス低下を引き起こすことがあります。** この問題は近日中に解決される予定で、バックグラウンドで実行される変異に関連しています。この問題が発生していると思われる場合は、ClickHouse [サポート](https://clickhouse.com/support/program)に連絡してください。
## 料金 {#pricing}

プライベートプレビュー中に作成された追加サービスは通常通り請求されます。コンピュート料金はウェアハウス内のすべてのサービス（主要および副次）で同じです。ストレージは最初の（元の）サービスにのみ請求されます。
## バックアップ {#backups}

- 単一のウェアハウス内のすべてのサービスが同じストレージを共有するため、バックアップは主要（初期）サービスでのみ作成されます。これにより、ウェアハウス内のすべてのサービスのデータがバックアップされます。
- ウェアハウスの主要サービスからバックアップを復元すると、既存のウェアハウスに接続されていない全く新しいサービスに復元されます。復元が完了した後、すぐに新しいサービスに追加のサービスを追加できます。
## ウェアハウスの使用 {#using-warehouses}
### ウェアハウスの作成 {#creating-a-warehouse}

ウェアハウスを作成するには、既存のサービスとデータを共有する第二のサービスを作成する必要があります。これは、既存のサービスのいずれかの上のプラスアイコンをクリックすることで行えます：

<br />

<img src={COMPUTE7}
    alt='NEEDS ALT'
    class='image'
    style={{width: '800px'}}
/>

<br />

_図7 - ウェアハウスに新しいサービスを作成するにはプラスアイコンをクリック_

サービス作成画面では、元のサービスが新サービスのデータソースとしてドロップダウンで選択されます。作成されると、これら2つのサービスはウェアハウスを形成します。
### ウェアハウスの名前変更 {#renaming-a-warehouse}

ウェアハウスの名前を変更する方法は2つあります：

- サービスページの右上隅にある「ウェアハウスでソート」を選択し、ウェアハウス名の近くにある鉛筆アイコンをクリックする
- サービスのいずれかでウェアハウス名をクリックして、そこでウェアハウスの名前を変更する
### ウェアハウスの削除 {#deleting-a-warehouse}

ウェアハウスを削除することは、すべてのコンピュートサービスとデータ（テーブル、ビュー、ユーザーなど）を削除することを意味します。この操作は元に戻すことができません。
ウェアハウスを削除するには、最初に作成したサービスを削除する必要があります。これを行うには：

1. 最初に作成されたサービスに追加して作成されたすべてのサービスを削除する；
2. 最初のサービスを削除する（警告：このステップではウェアハウスのデータがすべて削除されます）。
