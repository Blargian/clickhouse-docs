---
slug: /faq/operations/production
title: どの ClickHouse バージョンを本番環境で使用すべきか？
toc_hidden: true
toc_priority: 10
---

# どの ClickHouse バージョンを本番環境で使用すべきか？ {#which-clickhouse-version-to-use-in-production}

まず最初に、なぜ人々がこの質問をするのかについて考えましょう。主に2つの理由があります。

1. ClickHouse は非常に高い速度で開発されており、通常年間に 10 回以上の安定したリリースがあります。そのため、選択肢が広がり、選ぶのが簡単ではありません。
2. 一部のユーザーは、どのバージョンが自分のユースケースに最適かを探る時間を避け、他人のアドバイスに従いたがります。

二つ目の理由はより根本的なものであるため、こちらから始め、その後、様々な ClickHouse のリリースを検討することに戻ります。

## どの ClickHouse バージョンを推奨しますか？ {#which-clickhouse-version-do-you-recommend}

コンサルタントを雇ったり、信頼できる専門家に依存することは、あなたの本番環境に対する責任を取り除く誘惑があります。他の誰かが推奨した特定の ClickHouse バージョンをインストールし、もしそれに問題があれば、それはあなたの責任ではなく、他の誰かの責任です。このような考え方は大きな罠です。外部の人間は、あなたが勤務している会社の本番環境で何が起きているかをあなたよりもよく理解している人はいません。

では、どのようにして適切に ClickHouse のバージョンを選んでアップグレードすべきでしょうか？また、どのようにして最初の ClickHouse バージョンを選ぶべきでしょうか？まず最初に、**現実的なプレプロダクション環境**を設定するために投資する必要があります。理想的には、それは完全に同一のシャドウコピーであるべきですが、通常は高額になります。

コストをあまりかけずにプレプロダクション環境で合理的な忠実度を得るためのいくつかの重要なポイントは次のとおりです：

- プレプロダクション環境は、本番環境で実行する予定のクエリセットにできるだけ近いものを実行する必要があります：
    - 冷凍されたデータを使用した読み取り専用にはしないでください。
    - 単にデータをコピーするだけでなく、典型的なレポートを生成する書き込み専用にはしないでください。
    - スキーママイグレーションを適用する代わりに、クリーンにすることは避けてください。
- 実際の本番データとクエリのサンプルを使用します。依然として代表的であるサンプルを選択し、`SELECT` クエリが合理的な結果を返すようにします。データがセンシティブで、内部ポリシーが本番環境からの出所を許可しない場合は、難読化を使用します。
- プレプロダクションが本番環境同様に監視とアラートソフトウェアによってカバーされていることを確認します。
- あなたの本番環境が複数のデータセンターや地域にまたがる場合は、プレプロダクションでも同様にする必要があります。
- 本番環境がレプリケーションや分散テーブル、階層化されたマテリアライズドビューなどの複雑な機能を使用している場合、プレプロダクションでも同様に設定されていることを確認します。
- プレプロダクションで本番と同じサイズまたはそれより小さいサーバーや仮想マシンを使用することにはトレードオフがあります。最初の選択肢は、追加のネットワーク関連の問題をキャッチするかもしれませんが、後者は管理が容易です。

投資すべき第二の領域は、**自動テストインフラストラクチャ**です。何らかのクエリが一度成功裏に実行されたからといって、それが永久に動作し続けるとは限りません。ClickHouse がモックされたユニットテストをいくつか持つことは問題ありませんが、あなたのプロダクトには重要なユースケースが期待通りに機能するかを確認するために、実際の ClickHouse に対して実行される合理的な自動テストセットが必要です。

さらに一歩進んで、その自動テストを [ClickHouse のオープンソーステストインフラストラクチャ](https://github.com/ClickHouse/ClickHouse/tree/master/tests) に貢献することもできます。これは日常的な開発で継続的に使用されています。これには、[どのように実行するか](../../development/tests.md)を学び、あなたのテストをこのフレームワークに適応させるための追加の時間と努力が必要ですが、ClickHouse のリリースが安定して発表されたときにすでにテスト済みとなることで、問題を報告した後に時間を無駄にすることなく、バグ修正を実施、バックポート、およびリリースを待つことができます。いくつかの企業は、このようなテストのインフラへの貢献を内部ポリシーとして持っています（Google では「Beyonce の法則」と呼ばれています）[Beyonce's Rule](https://www.oreilly.com/library/view/software-engineering-at/9781492082781/ch01.html#policies_that_scale_well)。

プレプロダクション環境とテストインフラが整った状態で、最適なバージョンを選ぶことは簡単です：

1. 新しい ClickHouse リリースに対して自動テストを定期的に実行します。`testing` とマークされた ClickHouse リリースに対しても実行できますが、それを使って次のステップに進むことは推奨されません。
2. テストを通過した ClickHouse リリースをプレプロダクションに展開し、すべてのプロセスが期待通りに実行されていることを確認します。
3. 発見した問題を [ClickHouse GitHub Issues](https://github.com/ClickHouse/ClickHouse/issues) に報告します。
4. 重大な問題がなければ、ClickHouse リリースを本番環境にデプロイすることは安全であるはずです。[カナリアリリース](https://martinfowler.com/bliki/CanaryRelease.html) や [グリーンブルーデプロイメント](https://martinfowler.com/bliki/BlueGreenDeployment.html) に類似したアプローチを実装した段階的なリリース自動化に投資することで、本番環境での問題のリスクをさらに軽減できるかもしれません。

上記のアプローチには、ClickHouse に特有のものはないことに気付いたかもしれません。人々は本番環境を真剣に考えている場合、依存するインフラストラクチャのすべてについてこのようなことを行っています。

## ClickHouse のリリースを選ぶ方法は？ {#how-to-choose-between-clickhouse-releases}

ClickHouse パッケージリポジトリの内容を見ると、2種類のパッケージがあります：

1. `stable`
2. `lts`（長期サポート）

それらの間で選択する際のガイダンスは次のとおりです：

- `stable` はデフォルトで推奨されるパッケージのタイプです。おおよそ毎月リリースされ（新機能が適度に遅れて提供され）、最新の安定リリースが3つの診断およびバグ修正のバックポートにおいてサポートされています。
- `lts` は年に2回リリースされ、初回リリースから1年間サポートされます。次のような場合に `stable` よりも `lts` を選ぶかもしれません：
    - あなたの会社には頻繁なアップグレードや非LTSソフトウェアの使用を許可しない内部ポリシーがあります。
    - あなたがクリックハウスを内部機能がそれほど複雑でない二次的製品に使用している場合、または更新を維持するのに十分なリソースがありません。

最初は `lts` が良いと思っていた多くのチームが、結局は製品にとって重要な最近の機能のために `stable` に切り替えることがよくあります。

:::tip    
ClickHouse をアップグレードする際に覚えておくべきもう1つのことがあります：リリース間の互換性を常に注視していますが、時には維持するのが合理的でなく、一部の細かい詳細が変更されることがあります。したがって、アップグレードする前に [変更ログ](/whats-new/changelog/index.md) を確認して、後方互換性のない変更に関するノートがないかどうかを確認してください。
:::
