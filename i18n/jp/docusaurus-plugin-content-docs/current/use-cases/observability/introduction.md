---
title: 'はじめに'
description: 'ClickHouseをオブザーバビリティソリューションとして使用する'
slug: /use-cases/observability/introduction
keywords: ['observability', 'logs', 'traces', 'metrics', 'OpenTelemetry', 'Grafana', 'OTel']
---

import observability_1 from '@site/static/images/use-cases/observability/observability-1.png';
import observability_2 from '@site/static/images/use-cases/observability/observability-2.png';
import Image from '@theme/IdealImage';


# ClickHouseを利用したオブザーバビリティ

## はじめに {#introduction}

このガイドは、ClickHouseを使用して自分自身のSQLベースのオブザーバビリティソリューションを構築しようとしているユーザー向けに設計されています。ログとトレースに焦点を当てており、データの取り込み、アクセスパターンに合わせたスキーマの最適化、非構造化ログからの構造の抽出を含む、自分自身のソリューションを構築するためのすべての側面をカバーしています。

ClickHouse自体は、オブザーバビリティのための即時使用可能なソリューションではありませんが、オブザーバビリティデータのための高度に効率的なストレージエンジンとして使用することができ、比類のない圧縮率と超高速のクエリ応答時間を実現します。ユーザーがオブザーバビリティソリューション内でClickHouseを使用するためには、ユーザーインターフェースとデータ収集フレームワークの両方が必要です。現在、オブザーバビリティ信号の視覚化には**Grafana**を、データ収集には**OpenTelemetry**を使用することをお勧めしています（両方とも公式にサポートされている統合です）。

<Image img={observability_1} alt="Simple OTel" size="md"/>

<br />

:::note OpenTelemetryだけではない
私たちの推奨はデータ収集にOpenTelemetry（OTel）プロジェクトを使用することですが、VectorやFluentdなどの他のフレームワークやツールを使用して同様のアーキテクチャを構築することも可能です（[Fluent Bitを使用した例](https://clickhouse.com/blog/kubernetes-logs-to-clickhouse-fluent-bit)を参照）。SupersetやMetabaseなどの代替視覚化ツールも存在します。
:::

## なぜClickHouseを使用するのか？ {#why-use-clickhouse}

集中型オブザーバビリティストアの最も重要な機能は、大量のログデータを迅速に集約、分析し、さまざまなソースからのデータを検索する能力です。この集中化はトラブルシューティングを簡素化し、サービスの中断の根本原因を特定することを容易にします。

ユーザーがますますコストに敏感で、これらの即時使用可能なオプションのコストが高く予測不可能だと感じている中で、クエリ性能が許容範囲であるコスト効率の良い予測可能なログストレージは、かつてないほど貴重です。

パフォーマンスとコスト効率のために、ClickHouseはオブザーバビリティ製品におけるログおよびトレースストレージエンジンの事実上の標準となっています。

より具体的には、ClickHouseがオブザーバビリティデータのストレージに理想的であることを示す要素は以下の通りです：

- **圧縮** - オブザーバビリティデータには、HTTPコードやサービス名など、独特のセットから取得された値のフィールドが通常含まれます。ClickHouseの列指向ストレージでは、値がソートされた状態で保存されるため、このデータは非常に良く圧縮され、特に時系列データ向けのさまざまな特殊コーデックと組み合わせることで、圧縮効果が高まります。他のデータストアのように元のデータサイズに等しいストレージを必要とするのではなく、ClickHouseはログとトレースを平均して14倍まで圧縮します。大規模なオブザーバビリティインストールのために大幅なストレージの節約を提供するだけでなく、この圧縮はディスクからの読み取りデータ量が減るため、クエリの加速にも寄与します。
- **高速集約** - オブザーバビリティソリューションは通常、エラーレートを示すラインやトラフィックソースを示す棒グラフなど、データをチャートで視覚化することを重視します。集約やGROUP BYは、これらのチャートを支えるための基盤であり、問題診断のワークフローにフィルターを適用する際に迅速かつ応答性が求められます。ClickHouseの列指向形式とベクトル化されたクエリ実行エンジンは、高速な集約に理想的であり、スパースインデックスがユーザーのアクションに応じた迅速なデータフィルタリングを可能にします。
- **高速リニアスキャン** - 他の技術がログの迅速なクエリのために反転インデックスに依存しているのに対し、これらは必然的に高いディスクおよびリソースの使用量をもたらします。ClickHouseは反転インデックスを追加のオプションインデックスタイプとして提供していますが、リニアスキャンは高度に並列化されており、マシン上のすべての利用可能なコアを使用します（別途設定しない限り）。これにより、毎秒10GB以上（圧縮状態）をスキャンして一致を探すことが可能です。[高効率なテキストマッチングオペレーター](/sql-reference/functions/string-search-functions)を使用します。
- **SQLの親しみやすさ** - SQLはすべてのエンジニアが慣れ親しんでいる普遍的な言語です。50年以上の開発を経て、データ分析のための事実上の言語としてその地位を確立し、[3番目に人気のあるプログラミング言語](https://clickhouse.com/blog/the-state-of-sql-based-observability#lingua-franca)となっています。オブザーバビリティは、SQLが理想的な別のデータ問題です。
- **分析関数** - ClickHouseは、SQLクエリをシンプルに記述しやすくするために設計された分析関数をANSI SQLで拡張します。これらは、データを切り分ける必要がある根本原因分析を行うユーザーにとって不可欠です。
- **セカンダリインデックス** - ClickHouseは、特定のクエリプロファイルを加速するためのセカンダリインデックス（ブルームフィルタなど）をサポートします。これらはオプションでカラムレベルで有効にでき、ユーザーに詳細な制御を与え、コストパフォーマンスの利益を評価できるようにします。
- **オープンソースおよびオープンスタンダード** - オープンソースデータベースとして、ClickHouseはOpen Telemetryなどのオープンスタンダードを取り入れています。プロジェクトに貢献し、積極的に参加する能力は魅力的であり、ベンダーロックインの課題を回避します。

## いつClickHouseをオブザーバビリティに使用すべきか {#when-should-you-use-clickhouse-for-observability}

ClickHouseをオブザーバビリティデータに使用する場合、ユーザーはSQLベースのオブザーバビリティを採用する必要があります。[このブログ投稿](https://clickhouse.com/blog/the-state-of-sql-based-observability)を参照すると、SQLベースのオブザーバビリティの歴史について詳しく説明されていますが、要約すると以下の通りです：

SQLベースのオブザーバビリティは、あなたに適しているかもしれません：

- あなたやあなたのチームがSQLに精通している（または学ぶ意欲がある）場合
- ロックインを避け、拡張性を実現するためにOpenTelemetryのようなオープンスタンダードを遵守することを好む場合
- データ収集からストレージ、視覚化までオープンソースの革新に支えられたエコシステムを運用することをいとわない場合
- 管理するオブザーバビリティデータの中・大規模な成長を見込んでいる場合（非常に大規模でも）
- TCO（総所有コスト）をコントロールし、オブザーバビリティコストが高騰するのを避けたい場合
- コスト管理のためにオブザーバビリティデータの保存期間が短すぎることを受け入れられない場合

SQLベースのオブザーバビリティがあなたに適さない場合：

- SQLを学ぶこと（または生成すること）があなたやあなたのチームに魅力的でない場合
- パッケージ化されたエンドツーエンドのオブザーバビリティ体験を求めている場合
- あなたのオブザーバビリティデータのボリュームが小さすぎて有意義な違いを生まない場合（例：&lt;150 GiB）で、成長が見込まれない場合
- あなたのユースケースがメトリクス重視でPromQLが必要な場合。その場合、メトリクス用にPrometheusの隣でClickHouseをログとトレースに使用し、Grafanaでプレゼンテーション層で統合することができます。
- エコシステムが成熟し、SQLベースのオブザーバビリティがよりターンキーになるのを待つことを好む場合

## ログとトレース {#logs-and-traces}

オブザーバビリティのユースケースには、ロギング、トレーシング、メトリクスの3つの明確な柱があります。それぞれに異なるデータタイプとアクセスパターンがあります。

現在、ClickHouseは2種類のオブザーバビリティデータの保存に推奨されています：

- **ログ** - ログは、システム内で発生するイベントのタイムスタンプ付き記録であり、ソフトウェア操作のさまざまな側面に関する詳細情報をキャプチャします。ログ内のデータは通常非構造的または半構造的で、エラーメッセージ、ユーザーアクティビティログ、システムの変更、その他のイベントを含む可能性があります。ログはトラブルシューティング、異常検知、システム内の問題に至る特定のイベントを理解するために重要です。

```response
54.36.149.41 - - [22/Jan/2019:03:56:14 +0330] "GET
/filter/27|13%20%D9%85%DA%AF%D8%A7%D9%BE%DB%8C%DA%A9%D8%B3%D9%84,27|%DA%A9%D9%85%D8%AA%D8%B1%20%D8%A7%D8%B2%205%20%D9%85%DA%AF%D8%A7%D9%BE%DB%8C%DA%A9%D8%B3%D9%84,p53 HTTP/1.1" 200 30577 "-" "Mozilla/5.0 (compatible; AhrefsBot/6.1; +http://ahrefs.com/robot/)" "-"
```

- **トレース** - トレースは、分散システム内のさまざまなサービスを通過する際のリクエストの経路をキャプチャし、これらのリクエストのパフォーマンスや経路を詳細に示します。トレース内のデータは高度に構造化されており、リクエストが通る各ステップをマッピングするスパンとトレースで構成されており、タイミング情報を含みます。トレースは、システムのパフォーマンスに関する貴重な洞察を提供し、ボトルネックやレイテンシの問題を特定し、マイクロサービスの効率を最適化するのに役立ちます。

:::note メトリクス
ClickHouseはメトリクスデータを保存するために使用できますが、この柱はClickHouseでは未成熟であり、Prometheusデータ形式とPromQLのサポートなどの機能が待機中です。
:::

### 分散トレース {#distributed-tracing}

分散トレースはオブザーバビリティの重要な機能です。分散トレースは単にトレースと呼ばれ、システム内のリクエストの経路をマッピングします。リクエストはエンドユーザーまたはアプリケーションから始まり、システム全体に広がり、通常、マイクロサービス間のアクションの流れをもたらします。このシーケンスを記録し、後続のイベントを相関させることによって、オブザーバビリティユーザーやSREがアプリケーションフローの問題を診断できるようにします。これは、アーキテクチャがどれほど複雑またはサーバーレスであっても同様です。

各トレースは複数のスパンで構成され、リクエストに関連付けられた最初のスパンはルートスパンと呼ばれます。このルートスパンは、リクエスト全体を初めから終わりまでキャプチャします。ルートの下の後続のスパンは、リクエスト中に発生するさまざまなステップまたは操作に関する詳細な洞察を提供します。トレースがなければ、分散システムのパフォーマンス問題を診断することが非常に困難です。トレースは、リクエストがシステムを移動する際のイベントのシーケンスを詳述することによって、分散システムのデバッグと理解のプロセスを容易にします。

ほとんどのオブザーバビリティベンダーは、この情報を滝のように視覚化し、相対的な時間を比例したサイズの水平バーで表示します。たとえば、Grafanaでは：

<Image img={observability_2} alt="Example trace" size="lg" border/>

ログとトレースの概念に深く親しむ必要があるユーザーには、[OpenTelemetryのドキュメント](https://opentelemetry.io/docs/concepts/)を強くお勧めします。
